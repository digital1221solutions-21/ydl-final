<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>YDL - Your Digital Library</title>
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

html {
  -webkit-text-size-adjust: 100%;
  text-size-adjust: 100%;
  -webkit-tap-highlight-color: transparent;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  height: 100vh;
  font-size: 100%;
}

body {
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background: linear-gradient(135deg, #e6f2ff 0%, #cce7ff 50%, #b3d9ff 100%);
  min-height: 100vh;
  overflow-x: hidden;
  position: relative;
  width: 100%;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: none;
  touch-action: pan-y pinch-zoom;
  transition: padding 0.3s ease;
  display: flex;
  flex-direction: column;
}

body.fullscreen-mode {
  padding: 0;
  background: white;
}

body.fullscreen-mode .card-container {
  height: 100vh;
  max-height: 100vh;
  padding: 0;
}

body.fullscreen-mode .card {
  max-width: 100%;
  max-height: 100vh;
  border-radius: 0;
  box-shadow: none;
}

body.fullscreen-mode .card-header {
  border-radius: 0;
}

@supports (-webkit-touch-callout: none) {
  body {
    min-height: -webkit-fill-available;
  }
}

body.modal-open {
  overflow: hidden;
  position: fixed;
  width: 100%;
  height: 100%;
}

/* ========== CRITICAL FIX: Make main content take full screen ========== */
.main-container {
  max-width: none;
  margin: 0;
  width: 100%;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  flex: 1;
}

.card-container {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 100%;
  min-height: 100vh;
  flex: 1;
  padding: 0;
}

/* FIX: Make card full height */
.card {
  display: flex;
  flex-direction: column;
  position: relative;
  width: 100%;
  max-width: none;
  min-height: 100vh;
  height: 100vh;
  max-height: 100vh;
  border-radius: 0;
  overflow: hidden;
  background: linear-gradient(145deg, #ffffff, #f0f9ff);
  box-shadow: 0 15px 35px rgba(0, 119, 255, 0.15),
              0 5px 15px rgba(0, 119, 255, 0.1),
              inset 0 1px 0 rgba(255, 255, 255, 0.5);
  transition: all 0.3s ease;
  border: 2px solid rgba(0, 150, 255, 0.15);
}

/* NEW: Scrollable card content area */
.card-content-scrollable {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 20px 25px;
  background: rgba(255, 255, 255, 0.7);
  -webkit-overflow-scrolling: touch;
}

/* Ensure all content fits within the scrollable area */
.card-content {
  display: flex;
  flex-direction: column;
  min-height: 100%;
}

/* Fix header to always show graduation cap */
.card-header {
  position: relative;
  width: 100%;
  height: 110px;
  min-height: 110px;
  overflow: visible !important;
  background: linear-gradient(135deg, #0077ff 0%, #00a2ff 100%);
  display: flex;
  justify-content: center;
  align-items: center;
  flex-direction: column;
  color: white;
  font-size: 1.4rem;
  font-weight: 700;
  padding: 15px 20px;
  flex-shrink: 0;
  border-bottom: 3px solid rgba(255, 255, 255, 0.3);
}

/* Ensure graduation cap icon is visible */
.card-header i {
  font-size: 2rem;
  margin-bottom: 8px;
  display: block;
}

/* FIX 2: Adjusted button positions to be side by side */
.card-header-buttons {
  position: absolute;
  top: 15px;
  right: 15px;
  display: flex;
  gap: 10px;
  align-items: center;
  z-index: 10;
}

/* Fullscreen button */
.fullscreen-btn {
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid rgba(0, 150, 255, 0.3);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  color: #0077ff;
  font-size: 18px;
  box-shadow: 0 2px 8px rgba(0, 119, 255, 0.15);
}

.fullscreen-btn:hover {
  background: white;
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(0, 119, 255, 0.25);
}

/* Sign out button in header */
.header-signout-btn {
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid rgba(255, 107, 107, 0.3);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  color: #ff6b6b;
  font-size: 16px;
  box-shadow: 0 2px 8px rgba(0, 119, 255, 0.15);
}

.header-signout-btn:hover {
  background: white;
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(255, 107, 107, 0.25);
  color: #ff5252;
}

/* Fix footer buttons visibility */
#adminFooter {
  padding: 15px 20px;
  background: linear-gradient(to right, #f0f9ff, #e6f2ff);
  border-top: 1px solid rgba(0, 150, 255, 0.2);
  min-height: 80px;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  position: relative;
  z-index: 10;
}

.footer-buttons-container {
  display: flex;
  gap: 10px;
  width: 100%;
}

.footer-buttons-container button {
  flex: 1;
  padding: 12px;
  font-size: 14px;
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 44px;
}

/* FIX 3: Manual Exam Modal Button Visibility Fix */
#manualExamModal .modal-footer {
  opacity: 1 !important;
  visibility: visible !important;
  display: flex !important;
}

#manualExamModal .modal-footer button {
  opacity: 1 !important;
  visibility: visible !important;
}

#manualExamModal .modal-footer button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

/* Responsive adjustments */
@media (min-width: 768px) {
  .card {
    max-width: 700px;
    max-height: 90vh;
    border-radius: 20px;
    margin: 20px;
  }
  
  .card-content-scrollable {
    padding: 25px 30px;
  }
}

@media (min-width: 1024px) {
  .card {
    max-width: 900px;
  }
}

/* Mobile responsiveness improvements */
@media (max-width: 767px) {
  .card-header {
    height: 100px;
    min-height: 100px;
    font-size: 1.2rem;
    padding: 12px 15px;
  }
  
  .card-content-scrollable {
    padding: 15px 20px;
  }
  
  .footer-buttons-container {
    gap: 8px;
  }
  
  .footer-buttons-container button {
    padding: 10px 8px;
    font-size: 12px;
    min-height: 40px;
  }
  
  .card-header-buttons {
    top: 10px;
    right: 10px;
    gap: 8px;
  }
  
  .fullscreen-btn,
  .header-signout-btn {
    width: 36px;
    height: 36px;
    font-size: 14px;
  }
}

@media (max-width: 480px) {
  .card-header {
    height: 90px;
    min-height: 90px;
    font-size: 1.1rem;
    padding: 10px 12px;
  }
  
  .card-content-scrollable {
    padding: 12px 15px;
  }
  
  .footer-buttons-container {
    gap: 6px;
  }
  
  .footer-buttons-container button {
    padding: 8px 6px;
    font-size: 11px;
    min-height: 38px;
  }
  
  .card-header-buttons {
    top: 8px;
    right: 8px;
    gap: 6px;
  }
  
  .fullscreen-btn,
  .header-signout-btn {
    width: 34px;
    height: 34px;
    font-size: 13px;
  }
}

/* SCROLLBAR STYLES */
.card-content-scrollable::-webkit-scrollbar {
  width: 8px;
}

.card-content-scrollable::-webkit-scrollbar-track {
  background: rgba(0, 119, 255, 0.1);
  border-radius: 10px;
}

.card-content-scrollable::-webkit-scrollbar-thumb {
  background: linear-gradient(to bottom, #0077ff, #00a2ff);
  border-radius: 10px;
}

.card-content-scrollable::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(to bottom, #0066dd, #0091e6);
}

/* FIX 2: Bulk Uploader Modal fixes to prevent flickering */
.modal-bg {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 50, 100, 0.7);
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  padding: 20px;
  backdrop-filter: blur(5px);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.modal-bg.show {
  display: flex;
  opacity: 1;
}

.modal-content {
  background: linear-gradient(145deg, #ffffff, #f5fbff);
  border-radius: 20px;
  padding: 25px;
  width: 95%;
  max-width: 550px;
  max-height: 90vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  border: 1px solid rgba(0, 150, 255, 0.2);
  transform: translateY(20px);
  transition: transform 0.3s ease;
}

.modal-bg.show .modal-content {
  transform: translateY(0);
}

/* FIX 2: Bulk Uploader Fixed - No more flickering */
#bulkUploaderModal.modal-bg {
  transition: none !important;
  opacity: 1 !important;
}

#bulkUploaderModal.modal-bg.show {
  display: flex;
  opacity: 1 !important;
}

#bulkUploaderModal .modal-content {
  transform: none !important;
  transition: none !important;
  animation: none !important;
}

/* Remove any animations that might cause flickering */
#bulkUploaderModal * {
  animation: none !important;
  transition: none !important;
}

/* FIX 2: Bulk Uploader Fullscreen Mode */
.modal-content.modal-expanded {
  width: 100vw !important;
  height: 100vh !important;
  max-width: 100vw !important;
  max-height: 100vh !important;
  border-radius: 0 !important;
  padding: 15px !important;
}

.modal-expanded .modal-body {
  flex: 1;
  overflow-y: auto;
}

.modal-expanded .modal-footer {
  margin-top: 15px;
  padding-top: 15px;
  border-top: 1px solid rgba(0, 150, 255, 0.2);
}

.modal-body {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding-right: 10px;
  margin-bottom: 15px;
  -webkit-overflow-scrolling: touch;
}

/* FIX 2: Added fix for exam upload options modal buttons to prevent flickering */
#examUploadOptionsModal .modal-content {
  transform: none !important;
}

#examUploadOptionsModal .btn-danger,
#examUploadOptionsModal .btn-success,
#examUploadOptionsModal .btn-primary {
  transform: none !important;
  transition: all 0.2s ease !important;
}

#examUploadOptionsModal .btn-danger:hover,
#examUploadOptionsModal .btn-success:hover,
#examUploadOptionsModal .btn-primary:hover {
  transform: translateY(-2px) !important;
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.15) !important;
}

/* Expand button for modals */
.expand-button {
  position: absolute;
  top: 15px;
  right: 60px;
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid rgba(0, 150, 255, 0.3);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.3s ease;
  color: #0077ff;
  font-size: 18px;
  box-shadow: 0 2px 8px rgba(0, 119, 255, 0.15);
  z-index: 10;
}

.expand-button:hover {
  background: white;
  transform: scale(1.1);
  box-shadow: 0 4px 12px rgba(0, 119, 255, 0.25);
}

/* Sign Out Button Styling */
.sign-out-button {
  background: linear-gradient(135deg, #ff6b6b, #ff8e8e);
  color: white;
  border: none;
  border-radius: 10px;
  padding: 8px 16px;
  font-size: 0.9rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 8px rgba(255, 107, 107, 0.2);
  display: flex;
  align-items: center;
  gap: 6px;
  position: absolute;
  top: 20px;
  right: 20px;
  z-index: 10;
}

.sign-out-button:hover {
  background: linear-gradient(135deg, #ff5252, #ff7b7b);
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(255, 107, 107, 0.3);
}

/* Back button styling */
.back-button {
  position: absolute;
  top: 20px;
  left: 20px;
  background: rgba(255, 255, 255, 0.9);
  border: 1px solid rgba(0, 150, 255, 0.3);
  border-radius: 50%;
  width: 40px;
  height: 40px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 10;
  transition: all 0.3s ease;
  color: #0077ff;
  font-size: 18px;
  box-shadow: 0 2px 8px rgba(0, 119, 255, 0.15);
}

.back-button:hover {
  background: white;
  transform: translateX(-3px);
  box-shadow: 0 4px 12px rgba(0, 119, 255, 0.25);
}

/* ACCORDION STYLES */
.accordion-item {
  margin-bottom: 8px;
  border-radius: 12px;
  overflow: hidden;
  border: 1px solid rgba(0, 150, 255, 0.2);
  background: white;
}

.accordion-header {
  padding: 15px 20px;
  background: linear-gradient(135deg, #0077ff 0%, #00a2ff 100%);
  color: white;
  font-weight: bold;
  font-size: 1rem;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  transition: all 0.3s ease;
  user-select: none;
}

.accordion-header:hover {
  background: linear-gradient(135deg, #0066dd 0%, #0091e6 100%);
}

.accordion-content {
  max-height: 0;
  overflow: hidden;
  transition: max-height 0.3s ease-out;
  background: linear-gradient(to bottom, #f8fbff, #f0f9ff);
}

.accordion-content.expanded {
  max-height: 300px;
}

/* Button styles */
.btn-primary {
  background: linear-gradient(135deg, #0077ff, #00a2ff);
  color: white;
  border: none;
  border-radius: 12px;
  padding: 12px 24px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 6px 12px rgba(0, 119, 255, 0.2);
}

.btn-primary:hover {
  background: linear-gradient(135deg, #0066dd, #0091e6);
  transform: translateY(-3px);
  box-shadow: 0 10px 20px rgba(0, 119, 255, 0.3);
}

.btn-secondary {
  background: linear-gradient(135deg, #6c757d, #868e96);
  color: white;
  border: none;
  border-radius: 12px;
  padding: 12px 24px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 6px 12px rgba(108, 117, 125, 0.2);
}

.btn-secondary:hover {
  background: linear-gradient(135deg, #5a6268, #727b84);
  transform: translateY(-3px);
  box-shadow: 0 10px 20px rgba(108, 117, 125, 0.3);
}

.btn-success {
  background: linear-gradient(135deg, #28a745, #20c997);
  color: white;
  border: none;
  border-radius: 12px;
  padding: 12px 24px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 6px 12px rgba(40, 167, 69, 0.2);
}

.btn-success:hover {
  background: linear-gradient(135deg, #218838, #1ba87e);
  transform: translateY(-3px);
  box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
}

.btn-danger {
  background: linear-gradient(135deg, #dc3545, #ff6b6b);
  color: white;
  border: none;
  border-radius: 12px;
  padding: 12px 24px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 6px 12px rgba(220, 53, 69, 0.2);
}

.btn-danger:hover {
  background: linear-gradient(135deg, #c82333, #ff5252);
  transform: translateY(-3px);
  box-shadow: 0 10px 20px rgba(220, 53, 69, 0.3);
}

.btn-purple {
  background: linear-gradient(135deg, #6f42c1, #9c6eff);
  color: white;
  border: none;
  border-radius: 12px;
  padding: 12px 24px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 6px 12px rgba(111, 66, 193, 0.2);
}

.btn-purple:hover {
  background: linear-gradient(135deg, #5e35b1, #8a5bff);
  transform: translateY(-3px);
  box-shadow: 0 10px 20px rgba(111, 66, 193, 0.3);
}

/* FIX 2: URLs Button CSS for Admin Tools */
.url-button {
  background: linear-gradient(135deg, #17a2b8, #20c997);
  color: white;
  border: none;
  border-radius: 12px;
  padding: 12px 24px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 6px 12px rgba(23, 162, 184, 0.2);
}

.url-button:hover {
  background: linear-gradient(135deg, #138496, #1ba87e);
  transform: translateY(-3px);
  box-shadow: 0 10px 20px rgba(23, 162, 184, 0.3);
}

/* Input styles */
.input-field {
  width: 100%;
  padding: 14px 16px;
  border: 2px solid rgba(0, 150, 255, 0.2);
  border-radius: 12px;
  font-size: 16px;
  background: rgba(255, 255, 255, 0.9);
  transition: all 0.3s ease;
  box-shadow: 0 4px 6px rgba(0, 119, 255, 0.05);
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
}

.input-field:focus {
  outline: none;
  border-color: #0077ff;
  box-shadow: 0 0 0 3px rgba(0, 119, 255, 0.1), 0 4px 6px rgba(0, 119, 255, 0.1);
  background: white;
}

/* Subject buttons */
.subject-btn {
  background: linear-gradient(135deg, #4dabff, #0077ff);
  color: white;
  border: none;
  border-radius: 16px;
  padding: 16px 12px;
  font-weight: 700;
  font-size: 0.95rem;
  transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  box-shadow: 0 10px 20px rgba(0, 119, 255, 0.2);
  position: relative;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 80px;
}

.subject-btn:hover {
  transform: translateY(-8px) scale(1.05);
  box-shadow: 0 20px 40px rgba(0, 119, 255, 0.3);
}

/* Level buttons */
.level-btn {
  position: relative;
  border: 2px solid rgba(156, 163, 175, 0.3);
  border-radius: 12px;
  padding: 12px 8px;
  height: 70px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  background: linear-gradient(135deg, #f9fafb, #f3f4f6);
  overflow: hidden;
  cursor: pointer;
  color: #374151;
}

.level-btn:hover {
  transform: translateY(-3px);
  border-color: rgba(107, 114, 128, 0.5);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
  background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
}

/* Quiz options */
.quiz-option {
  display: block;
  width: 100%;
  background: linear-gradient(to right, #f0f8ff, #e6f2ff);
  border: 2px solid rgba(0, 150, 255, 0.2);
  border-radius: 12px;
  padding: 14px 20px;
  margin-bottom: 10px;
  transition: all 0.3s ease;
  cursor: pointer;
  text-align: left;
  font-weight: 500;
  box-sizing: border-box;
}

.quiz-option:hover {
  background: linear-gradient(to right, #e6f2ff, #d6e9ff);
  border-color: rgba(0, 150, 255, 0.4);
  transform: translateX(5px);
}

/* Modal header and footer fixed */
.modal-header {
  flex-shrink: 0;
  margin-bottom: 20px;
  text-align: center;
  position: relative;
  padding-bottom: 15px;
}

.modal-header::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
  width: 80px;
  height: 3px;
  background: linear-gradient(90deg, #0077ff, #00a2ff);
  border-radius: 2px;
}

.modal-footer {
  flex-shrink: 0;
  margin-top: 20px;
  opacity: 1 !important;
  visibility: visible !important;
  display: flex !important;
}

/* FIX 3: Manual Exam Creator Modal Button Hover Fix */
#manualExamModal .modal-footer button {
  opacity: 1 !important;
  visibility: visible !important;
  transition: all 0.3s ease !important;
}

#manualExamModal .modal-footer button:hover {
  transform: translateY(-2px) !important;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
  opacity: 1 !important;
  visibility: visible !important;
}

/* Ensure buttons are always visible in manual exam modal */
#manualExamModal .modal-footer {
  opacity: 1 !important;
  visibility: visible !important;
  display: flex !important;
}

#manualExamModal .btn-secondary,
#manualExamModal .btn-success {
  opacity: 1 !important;
  visibility: visible !important;
}

/* Admin tools grid */
.admin-tools-grid {
  display: grid;
  grid-template-columns: repeat(5, 1fr);
  gap: 8px;
  justify-content: center;
  margin: 0 auto;
}

.admin-tool-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 12px 5px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
  text-align: center;
  transition: all 0.3s ease;
  height: 70px;
  width: 100%;
}

/* Subject three dots menu */
.subject-three-dots {
  cursor: pointer;
  padding: 8px;
  border-radius: 50%;
  transition: all 0.3s ease;
  display: flex;
  align-items: center;
  justify-content: center;
  width: 32px;
  height: 32px;
}

.subject-three-dots:hover {
  background: rgba(0, 0, 0, 0.1);
  transform: scale(1.1);
}

/* Subject dropdown menu */
.subject-dropdown-menu {
  background: white;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  border: 1px solid rgba(0, 150, 255, 0.2);
  padding: 8px;
  min-width: 120px;
  z-index: 10000;
}

.subject-dropdown-menu button {
  width: 100%;
  padding: 8px 12px;
  border: none;
  background: none;
  text-align: left;
  cursor: pointer;
  border-radius: 4px;
  margin-bottom: 4px;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.subject-dropdown-menu button:hover {
  background: rgba(0, 150, 255, 0.1);
}

.subject-dropdown-menu .edit-btn {
  color: #0077ff;
}

.subject-dropdown-menu .delete-btn {
  color: #dc3545;
}

/* Level three dots */
.level-three-dots {
  position: absolute;
  top: 5px;
  right: 5px;
  cursor: pointer;
  background: rgba(255, 255, 255, 0.9);
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
  font-weight: bold;
  color: #0077ff;
  transition: all 0.3s ease;
  z-index: 5;
}

.level-three-dots:hover {
  background: white;
  transform: scale(1.1);
  box-shadow: 0 2px 8px rgba(0, 119, 255, 0.2);
}

/* Global resource menu */
#globalResourceMenu {
  position: fixed;
  background: white;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  border: 1px solid rgba(0, 150, 255, 0.2);
  padding: 8px;
  min-width: 140px;
  display: none;
  z-index: 2000;
}

#globalResourceMenu button {
  width: 100%;
  padding: 8px 12px;
  border: none;
  background: none;
  text-align: left;
  cursor: pointer;
  border-radius: 4px;
  margin-bottom: 4px;
  font-size: 13px;
  display: flex;
  align-items: center;
  gap: 8px;
}

#globalResourceMenu button:hover {
  background: rgba(0, 150, 255, 0.1);
}

/* Subject page item */
.subject-page-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px;
  background: linear-gradient(135deg, #ffffff, #f8fbff);
  border-radius: 12px;
  border: 1px solid rgba(0, 150, 255, 0.2);
  margin-bottom: 10px;
  transition: all 0.3s ease;
}

.subject-page-item:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0, 119, 255, 0.1);
  border-color: rgba(0, 150, 255, 0.4);
}

/* Subject management item */
.subject-management-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 15px;
  background: white;
  border-radius: 10px;
  border: 1px solid rgba(0, 150, 255, 0.15);
  margin-bottom: 8px;
}

/* Mobile Responsive Styles */
@media (max-width: 1024px) {
  .grid-cols-5 {
    grid-template-columns: repeat(3, 1fr);
  }
}

@media (max-width: 767px) {
  .grid-cols-5 {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .grid-cols-2 {
    grid-template-columns: 1fr;
  }
  
  .subject-btn {
    padding: 14px 10px;
    font-size: 0.9rem;
    height: 75px;
  }
  
  .admin-tools-grid {
    grid-template-columns: repeat(3, 1fr);
  }
  
  .expand-button {
    right: 50px;
    width: 35px;
    height: 35px;
    font-size: 16px;
  }
}

@media (max-width: 640px) {
  .grid-cols-5 {
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
  }
  
  .btn-primary, .btn-secondary, .btn-success, .btn-danger, .btn-purple, .url-button {
    padding: 10px 18px;
    font-size: 14px;
  }
  
  .input-field {
    padding: 12px 14px;
    font-size: 15px;
  }
  
  .admin-tools-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .admin-tool-btn {
    height: 65px;
    padding: 10px 4px;
    font-size: 11px;
  }
}

@media (max-width: 480px) {
  .grid-cols-5 {
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
  }
  
  .subject-btn {
    padding: 12px 8px;
    font-size: 0.85rem;
    height: 70px;
  }
  
  .btn-primary, .btn-secondary, .btn-success, .btn-danger, .btn-purple, .url-button {
    padding: 9px 15px;
    font-size: 13px;
  }
  
  .input-field {
    padding: 11px 13px;
    font-size: 14px;
  }
  
  .admin-tools-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  .admin-tool-btn {
    height: 60px;
    padding: 8px 3px;
    font-size: 10px;
  }
  
  .expand-button {
    right: 45px;
    width: 32px;
    height: 32px;
    font-size: 14px;
  }
}

@media (max-width: 360px) {
  .grid-cols-5 {
    grid-template-columns: 1fr;
  }
  
  .grid-cols-2 {
    grid-template-columns: 1fr;
  }
  
  .subject-btn {
    padding: 10px 6px;
    font-size: 0.8rem;
    height: 65px;
  }
  
  .level-btn {
    height: 60px;
    padding: 8px 6px;
  }
  
  .admin-tools-grid {
    grid-template-columns: 1fr;
  }
  
  .admin-tool-btn {
    height: 55px;
  }
}
</style>
</head>
<body>

<div class="main-container">
  <!-- GLOBAL MENU CONTAINER -->
  <div id="globalResourceMenu"></div>

  <!-- Level Rename Modal -->
  <div id="levelRenameModal" class="modal-bg">
    <div class="modal-content">
      <h4 class="modal-header text-xl font-bold text-gray-800 mb-4">Rename Level</h4>
      <div class="mb-4">
        <p class="text-sm text-gray-600 mb-2">Rename level to Chapter name:</p>
        <input type="text" id="newChapterName" class="input-field mb-2" placeholder="e.g., Chapter 1, Chapter 2, etc.">
        <p class="text-xs text-gray-500">Or enter level number (1-20):</p>
        <input type="number" id="newLevelNumber" min="1" max="20" class="input-field" placeholder="New Level Number">
      </div>
      <div class="flex justify-between space-x-3">
        <button type="button" onclick="closeLevelRenameModal()" class="btn-secondary w-full py-3">Cancel</button>
        <button type="button" onclick="saveLevelRename()" class="btn-success w-full py-3">Rename</button>
      </div>
    </div>
  </div>

  <!-- Enhanced Add Modal -->
  <div id="addLevelModal" class="modal-bg">
    <div class="modal-content">
      <h4 class="modal-header text-xl font-bold text-gray-800">Add</h4>
      <div class="modal-body">
        <div class="mb-6">
          <div class="mb-4">
            <label class="block text-sm font-bold text-gray-700 mb-2">Select Type</label>
            <select id="addTypeSelect" class="input-field" onchange="toggleAddTypeFields()">
              <option value="level">Add Level</option>
              <option value="subject">Add Subject</option>
              <option value="chapter">Add Chapter</option>
            </select>
          </div>
          
          <!-- Level Fields -->
          <div id="levelFields" class="space-y-4">
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">Level Number</label>
              <input type="number" id="newLevelNumberInput" min="1" max="50" class="input-field" placeholder="Enter level number (1-50)">
            </div>
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">Level Name (Optional)</label>
              <input type="text" id="newLevelNameInput" class="input-field" placeholder="e.g., Chapter 1, Advanced Level, etc.">
            </div>
            <p class="text-xs text-gray-500">Level will be created for: <span id="addLevelSubjectName" class="font-bold text-blue-600"></span></p>
          </div>
          
          <!-- Subject Fields -->
          <div id="subjectFields" class="space-y-4 hidden">
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">Subject Name</label>
              <input type="text" id="newSubjectNameInput" class="input-field" placeholder="Enter subject name">
            </div>
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">Subject Icon (Optional)</label>
              <select id="newSubjectIcon" class="input-field">
                <option value="book">ðŸ“š Book</option>
                <option value="math">ðŸ§® Math</option>
                <option value="science">ðŸ”¬ Science</option>
                <option value="computer">ðŸ’» Computer</option>
                <option value="english">ðŸ“– English</option>
              </select>
            </div>
          </div>
          
          <!-- Chapter Fields -->
          <div id="chapterFields" class="space-y-4 hidden">
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">Chapter Name</label>
              <input type="text" id="newChapterNameInput" class="input-field" placeholder="e.g., Chapter 1: Introduction">
            </div>
            <div>
              <label class="block text-sm font-bold text-gray-700 mb-2">Chapter Description</label>
              <textarea id="newChapterDescInput" class="input-field" rows="3" placeholder="Brief description of the chapter"></textarea>
            </div>
            <p class="text-xs text-gray-500">Chapter will be added to: <span id="addChapterSubjectName" class="font-bold text-blue-600"></span></p>
          </div>
        </div>
      </div>
      <div class="modal-footer flex justify-between space-x-3">
        <button type="button" onclick="closeAddLevelModal()" class="btn-secondary w-full py-3">Cancel</button>
        <button type="button" onclick="saveNewItem()" class="btn-success w-full py-3">Add</button>
      </div>
    </div>
  </div>

  <!-- Registration Passcode Modal -->
  <div id="registrationPasscodeModal" class="modal-bg">
    <div class="modal-content">
      <h4 class="modal-header text-xl font-bold text-gray-800">Admin Approval Required</h4>
      <div class="modal-body">
        <div class="text-center mb-6">
          <div class="inline-block p-4 rounded-2xl bg-gradient-to-r from-yellow-100 to-amber-100 mb-4">
            <i class="fas fa-shield-alt text-4xl text-yellow-500"></i>
          </div>
          <h5 class="text-lg font-bold text-gray-800">First-Time Registration</h5>
          <p class="text-sm text-gray-600 mt-2 mb-4">
            As a first-time user, you need admin approval to register.
            Please enter the admin passcode provided by your administrator.
          </p>
        </div>
        
        <div class="mb-4">
          <label class="block text-sm font-bold text-gray-700 mb-2">Enter Admin Passcode:</label>
          <input type="password" id="registrationPasscodeInput" 
                 class="input-field text-center" 
                 placeholder="Enter admin passcode"
                 autocomplete="off">
          <p class="text-xs text-gray-500 mt-2">Passcode is case-sensitive</p>
        </div>
        
        <div id="registrationPasscodeError" class="text-red-500 text-sm mt-3 hidden text-center"></div>
        
        <div class="bg-gradient-to-r from-blue-50 to-cyan-50 p-3 rounded-lg mt-4">
          <p class="text-xs text-blue-600">
            <i class="fas fa-info-circle mr-2"></i>
            This passcode ensures only authorized users can join the application.
            Contact your administrator if you don't have the passcode.
          </p>
        </div>
      </div>
      
      <div class="modal-footer flex justify-between space-x-3">
        <button type="button" onclick="closeRegistrationPasscodeModal()" 
                class="btn-secondary w-full py-3">Cancel</button>
        <button type="button" onclick="checkRegistrationPasscode()" 
                class="btn-success w-full py-3">Verify & Register</button>
      </div>
    </div>
  </div>

  <!-- Exam Upload Options Modal -->
  <div id="examUploadOptionsModal" class="modal-bg">
    <div class="modal-content">
      <h4 class="modal-header text-xl font-bold text-gray-800">Exam Upload Options</h4>
      <div class="modal-body">
        <div class="text-center mb-6">
          <div class="inline-block p-4 rounded-2xl bg-gradient-to-r from-blue-100 to-cyan-100 mb-4">
            <i class="fas fa-file-upload text-4xl text-blue-500"></i>
          </div>
          <h5 class="text-lg font-bold text-gray-800">Exam Already Exists</h5>
          <p class="text-sm text-gray-600 mt-2 mb-4" id="examUploadMessage">
            An exam already exists for this subject and level.
          </p>
        </div>
        
        <div class="space-y-4">
          <button type="button" onclick="handleExamUploadOption('overwrite')" 
                  class="w-full btn-danger py-4 rounded-xl text-lg flex items-center justify-center">
            <i class="fas fa-sync-alt mr-3"></i> Overwrite Existing Exam
          </button>
          
          <button type="button" onclick="handleExamUploadOption('append')" 
                  class="w-full btn-success py-4 rounded-xl text-lg flex items-center justify-center">
            <i class="fas fa-plus-circle mr-3"></i> Append to Existing Exam
          </button>
          
          <button type="button" onclick="handleExamUploadOption('new')" 
                  class="w-full btn-primary py-4 rounded-xl text-lg flex items-center justify-center">
            <i class="fas fa-file-medical mr-3"></i> Create as New Exam
          </button>
        </div>
        
        <div class="bg-gradient-to-r from-blue-50 to-cyan-50 p-3 rounded-lg mt-6">
          <p class="text-xs text-blue-600">
            <i class="fas fa-info-circle mr-2"></i>
            <strong>Overwrite:</strong> Replace all existing questions<br>
            <strong>Append:</strong> Add new questions to existing ones<br>
            <strong>New:</strong> Create a separate exam with different level
          </p>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" onclick="closeExamUploadOptionsModal()" 
                class="btn-secondary w-full py-3">Cancel</button>
      </div>
    </div>
  </div>

  <div class="card-container">
    <div class="card" id="quizCard">
      <div class="card-header">
        <div id="quizTimerDisplay" class="text-base font-bold text-white bg-gradient-to-r from-green-400 to-blue-400 px-4 py-2 rounded-full shadow-lg hidden mb-2">
          01:00
        </div>
        <!-- Added graduation cap icon -->
        <i class="fas fa-graduation-cap"></i>
        <div id="headerTitle" class="text-2xl font-extrabold tracking-wide text-center">Your Digital Library !</div>
        
        <!-- FIX 2: Header buttons side by side -->
        <div class="card-header-buttons">
          <button id="headerSignOutBtn" class="header-signout-btn" onclick="handleSignOut()" title="Sign Out" style="display: none;">
            <i class="fas fa-sign-out-alt"></i>
          </button>
          <button id="fullscreenBtn" class="fullscreen-btn" onclick="toggleFullScreen()" title="Toggle Full Screen (F11)">
            <i class="fas fa-expand"></i>
          </button>
        </div>
      </div>

      <!-- NEW: Scrollable content area -->
      <div class="card-content-scrollable">
        <div class="card-content" id="quizApp"></div>
      </div>
      
      <!-- Password Modal -->
      <div id="passwordModal" class="modal-bg">
        <div class="modal-content">
          <h4 id="modalTitle" class="modal-header text-xl font-bold text-gray-800">Admin Access</h4>
          <input type="password" id="passwordInput" class="input-field mb-4 text-center" placeholder="Enter admin password">
          <div class="flex justify-center space-x-3">
            <button type="button" onclick="closeModal()" class="btn-secondary px-6 py-3">Cancel</button>
            <button type="button" onclick="checkAdminPassword()" class="btn-primary px-6 py-3">Enter</button>
          </div>
          <p id="passwordError" class="text-red-500 text-sm mt-3 hidden text-center">Incorrect password.</p>
        </div>
      </div>
      
      <!-- Reset Quiz Modal -->
      <div id="resetQuizModal" class="modal-bg">
        <div class="modal-content">
          <h4 id="resetModalTitle" class="modal-header text-xl font-bold text-gray-800">Reset Quiz Progress</h4>
          <div class="mb-6">
            <p class="text-sm text-gray-600 mb-3">This will reset ALL quiz progress for ALL users. This action cannot be undone.</p>
            <div class="bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 p-4 rounded-xl">
              <p class="text-sm font-bold text-red-600 mb-2">Warning:</p>
              <p class="text-xs text-red-500">All user progress, scores, and quiz attempts will be deleted.</p>
            </div>
          </div>
          <input type="password" id="resetPasswordInput" class="input-field mb-4 text-center" placeholder="Enter admin password">
          <div class="flex justify-between space-x-3">
            <button type="button" onclick="closeResetModal()" class="btn-secondary px-6 py-3">Cancel</button>
            <button type="button" onclick="confirmResetQuizProgress()" class="btn-danger px-6 py-3">Reset All Progress</button>
          </div>
          <p id="resetPasswordError" class="text-red-500 text-sm mt-3 hidden text-center">Incorrect password.</p>
        </div>
      </div>
      
      <!-- Subject Management Modal -->
      <div id="subjectManagementModal" class="modal-bg">
        <div class="modal-content">
          <button class="expand-button" onclick="toggleModalExpand('subjectManagementModal')">
            <i class="fas fa-expand"></i>
          </button>
          <h4 class="modal-header text-xl font-bold text-gray-800">Subject Management</h4>
          
          <div class="modal-body">
            <div class="mb-6">
              <div class="flex items-center mb-4">
                <input type="text" id="newSubjectName" placeholder="Enter new subject name" 
                       class="flex-grow p-3 border rounded-l-xl text-sm input-field" maxlength="50">
                <button type="button" onclick="addNewSubject()" 
                        class="btn-success p-3 rounded-r-xl text-sm">
                  <i class="fas fa-plus mr-2"></i> Add
                </button>
              </div>
              
              <div id="subjectListContainer" class="space-y-3 max-h-60 overflow-y-auto p-3 bg-gradient-to-b from-blue-50 to-transparent rounded-xl border border-blue-100">
                <!-- Subject items will be dynamically inserted here -->
              </div>
              
              <div class="mt-4 text-xs text-blue-600 bg-blue-50 p-3 rounded-lg">
                <p><i class="fas fa-info-circle mr-2"></i> Subjects with content cannot be deleted until all questions and resources are removed.</p>
              </div>
            </div>
          </div>
          
          <div class="modal-footer flex justify-between space-x-3">
            <button type="button" onclick="closeSubjectManagement()" class="btn-secondary w-full py-3">Close</button>
            <button type="button" onclick="saveSubjectChanges()" class="btn-primary w-full py-3">Save Changes</button>
          </div>
        </div>
      </div>
      
      <!-- Bulk Uploader Modal - FIX 1: Added expand button for fullscreen -->
      <div id="bulkUploaderModal" class="modal-bg">
        <div class="modal-content">
          <button class="expand-button" onclick="toggleModalExpand('bulkUploaderModal')">
            <i class="fas fa-expand"></i>
          </button>
          <h4 class="modal-header text-xl font-bold text-gray-800">Bulk Question Uploader</h4>
          
          <div class="modal-body">
            <div class="mb-4 text-sm text-blue-600 bg-blue-50 p-3 rounded-lg">
              <p class="mb-2 font-semibold">CSV Format: subject,level,question,options,answer,type,hint</p>
              <p class="mb-2">Options separated by "|". Example: <span class="font-mono bg-white p-1 rounded border">Math,1,2+2?,3|4|5,4,radio,Easy</span></p>
              <input type="file" id="csvFileInput" accept=".csv" class="w-full p-2 border rounded-lg mb-3 input-field">
              <p class="mb-2 font-semibold">OR JSON (Multiple Formats Supported):</p>
              <input type="file" id="jsonFileInput" accept=".json" class="w-full p-2 border rounded-lg input-field">
              <p class="text-xs text-gray-500 mt-2">Supports: Array of questions, Object with questions array, Multi-subject format, Exam format, Items format</p>
            </div>
            
            <div class="modal-grid-container mb-6">
              <div class="w-full">
                <label class="block text-sm font-bold text-gray-700 mb-2">Subject</label>
                <div class="flex w-full">
                  <select id="uploadSubject" class="flex-grow p-3 text-sm border rounded-l-xl consistent-input">
                    <!-- Subjects will be populated dynamically -->
                  </select>
                  <button type="button" onclick="openSubjectManagementFromUploader()" 
                          class="btn-secondary p-3 rounded-r-xl text-xs" title="Manage Subjects">
                    <i class="fas fa-cog"></i>
                  </button>
                </div>
              </div>
              <div class="w-full">
                <label class="block text-sm font-bold text-gray-700 mb-2">Level</label>
                <select id="uploadLevel" class="w-full p-3 text-sm border rounded-xl consistent-input">
                  <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
                  <option value="6">6</option><option value="7">7</option><option value="8">8</option>
                  <option value="9">9</option>
                  <option value="10">10</option>
                  <option value="11">11</option><option value="12">12</option><option value="13">13</option>
                  <option value="14">14</option><option value="15">15</option>
                </select>
              </div>
            </div>
          </div>
          
          <div class="modal-footer flex justify-between space-x-3">
            <button type="button" onclick="closeBulkUploader()" class="btn-secondary w-full py-3">Cancel</button>
            <button type="button" onclick="processBulkUpload()" class="btn-success w-full py-3">Upload</button>
          </div>
        </div>
      </div>
      
      <!-- Manual Exam Creator Modal -->
      <div id="manualExamModal" class="modal-bg">
        <div class="modal-content">
          <button class="expand-button" onclick="toggleModalExpand('manualExamModal')">
            <i class="fas fa-expand"></i>
          </button>
          <h4 class="modal-header text-xl font-bold text-gray-800">Manual Exam Creator</h4>
          
          <div class="modal-body">
            <div class="mb-4">
              <div class="modal-grid-container mb-4">
                <div class="flex w-full">
                  <select id="manualSubject" class="flex-grow p-3 text-sm border rounded-l-xl consistent-input">
                    <!-- Subjects will be populated dynamically -->
                  </select>
                  <button type="button" onclick="openSubjectManagementFromManual()" 
                          class="btn-secondary p-3 rounded-r-xl text-xs" title="Manage Subjects">
                    <i class="fas fa-cog"></i>
                  </button>
                </div>
                <select id="manualLevel" class="w-full p-3 text-sm border rounded-xl consistent-input">
                  <option value="1">Level 1</option><option value="2">Level 2</option><option value="3">Level 3</option><option value="4">Level 4</option><option value="5">Level 5</option>
                  <option value="6">Level 6</option><option value="7">Level 7</option><option value="8">Level 8</option><option value="9">Level 9</option>
                  <option value="10">Level 10</option><option value="11">Level 11</option><option value="12">Level 12</option><option value="13">Level 13</option>
                  <option value="14">Level 14</option><option value="15">Level 15</option>
                </select>
              </div>
              
              <div id="manualQuestionsContainer" class="space-y-4 overflow-y-auto pr-2"></div>
              
              <button type="button" onclick="addManualQuestion()" class="w-full mt-3 bg-gradient-to-r from-blue-100 to-blue-50 hover:from-blue-200 hover:to-blue-100 text-blue-700 font-bold py-3 rounded-xl text-sm flex items-center justify-center border border-blue-300 transition-all duration-300">
                <i class="fas fa-plus-circle mr-2 text-lg"></i> Add New Question
              </button>
            </div>
          </div>
          
          <div class="modal-footer flex justify-between space-x-3">
            <button type="button" onclick="closeManualExamCreator()" class="btn-secondary w-full py-3">Cancel</button>
            <button type="button" onclick="saveManualExam()" class="btn-success w-full py-3">Save Exam</button>
          </div>
        </div>
      </div>
      
      <!-- Resource Uploader Modal -->
      <div id="resourceUploaderModal" class="modal-bg">
        <div class="modal-content" style="display: flex; flex-direction: column; max-height: 85vh; width: 95%; max-width: 600px;">
          <div class="modal-header-container p-4 border-b flex justify-between items-center">
            <h4 class="text-xl font-bold text-gray-800">Resource Uploader</h4>
            <button class="expand-button" onclick="toggleModalExpand('resourceUploaderModal')">
              <i class="fas fa-expand"></i>
            </button>
          </div>
          
          <div class="modal-body" style="overflow-y: auto; padding: 20px; flex-grow: 1;">
            <div class="modal-grid-container mb-6">
              <div class="flex w-full mb-4">
                <select id="resourceSubject" class="flex-grow p-3 text-sm border rounded-l-xl consistent-input">
                </select>
                <button type="button" onclick="openSubjectManagementFromResource()" class="btn-secondary p-3 rounded-r-xl"><i class="fas fa-cog"></i></button>
              </div>
              <select id="resourceLevel" class="w-full p-3 text-sm border rounded-xl consistent-input">
                <option value="1">Level 1</option>
              </select>
            </div>
            
            <div class="resource-section mb-6">
              <label class="block text-sm font-bold mb-2">Add Document</label>
              <input type="file" id="pdfFileInput" class="w-full p-2 border rounded">
            </div>
            
            <div class="resource-section mb-6">
              <label class="block text-sm font-bold mb-2">Add Video</label>
              <input type="file" id="videoFileInput" class="w-full p-2 border rounded">
            </div>
            
            <div class="resource-section mb-6">
              <label class="block text-sm font-bold mb-2">Add Audio</label>
              <input type="file" id="audioFileInput" class="w-full p-2 border rounded">
            </div>

            <div class="resource-section mb-6">
              <label class="block text-sm font-bold mb-2">Add URL Links</label>
              <div id="urlInputsContainer">
                <div class="url-input-container flex gap-2 mb-2">
                  <input type="text" placeholder="Name" class="w-1/3 p-2 border rounded">
                  <input type="url" placeholder="URL" class="flex-grow p-2 border rounded">
                  <button type="button" onclick="addMoreUrlInput()" class="bg-green-500 text-white px-3 rounded">+</button>
                </div>
              </div>
            </div>
          </div>

          <div class="modal-footer p-4 border-t bg-gray-50 flex justify-between space-x-3">
            <button type="button" onclick="closeResourceUploader()" class="btn-secondary w-full py-3 border rounded-xl">Close</button>
            <button type="button" onclick="saveResources()" class="btn-purple w-full py-3 bg-purple-600 text-white rounded-xl font-bold">Upload & Save</button>
          </div>
        </div>
      </div>
      
      <!-- Admin Dashboard Footer Button -->
      <div id="adminFooter" style="display: none;">
        <div class="footer-buttons-container">
          <button type="button" onclick="handleSignOut()" class="btn-secondary py-3 rounded-xl shadow-lg transition-all duration-300 text-sm flex items-center justify-center">
            <i class="fas fa-sign-out-alt mr-2 text-lg"></i>
            Sign Out
          </button>
          <button type="button" onclick="openModal('dashboard')" class="btn-danger py-3 rounded-xl shadow-lg transition-all duration-300 text-sm flex items-center justify-center">
            <i class="fas fa-cogs mr-2 text-lg"></i>
            Admin Dashboard
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ========== FIX 2: Updated Registration Passcode ==========
const ADMIN_PASSKEY = "awa2026";
const REGISTRATION_PASSCODE = "awa2026";
let adminAuthorizationAttempts = {};
let adminPasskeyCache = {};
let pendingAdminUser = null;
let pendingRegistrationUser = null;

// ========== NEW: Fullscreen functionality ==========
let isFullScreen = false;

function toggleFullScreen() {
    const card = document.getElementById('quizCard');
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const body = document.body;
    
    if (!isFullScreen) {
        // Enter fullscreen
        if (card.requestFullscreen) {
            card.requestFullscreen();
        } else if (card.mozRequestFullScreen) {
            card.mozRequestFullScreen();
        } else if (card.webkitRequestFullscreen) {
            card.webkitRequestFullscreen();
        } else if (card.msRequestFullscreen) {
            card.msRequestFullscreen();
        }
        
        body.classList.add('fullscreen-mode');
        fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
        isFullScreen = true;
    } else {
        // Exit fullscreen
        if (document.exitFullscreen) {
            document.exitFullscreen();
        } else if (document.mozCancelFullScreen) {
            document.mozCancelFullScreen();
        } else if (document.webkitExitFullscreen) {
            document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
            document.msExitFullscreen();
        }
        
        body.classList.remove('fullscreen-mode');
        fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
        isFullScreen = false;
    }
}

// Listen for fullscreen change events
document.addEventListener('fullscreenchange', handleFullscreenChange);
document.addEventListener('mozfullscreenchange', handleFullscreenChange);
document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
document.addEventListener('msfullscreenchange', handleFullscreenChange);

function handleFullscreenChange() {
    const fullscreenBtn = document.getElementById('fullscreenBtn');
    const body = document.body;
    
    if (!document.fullscreenElement && 
        !document.mozFullScreenElement && 
        !document.webkitFullscreenElement && 
        !document.msFullscreenElement) {
        // Exited fullscreen
        body.classList.remove('fullscreen-mode');
        fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
        isFullScreen = false;
    } else {
        // Entered fullscreen
        body.classList.add('fullscreen-mode');
        fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
        isFullScreen = true;
    }
}

// Add keyboard shortcut for F11
document.addEventListener('keydown', function(event) {
    if (event.key === 'F11') {
        event.preventDefault();
        toggleFullScreen();
    }
});

// ========== FIX 1: Enhanced modal handling to prevent flickering ==========
function openBulkUploader() { 
    document.body.classList.add('modal-open');
    const modal = document.getElementById('bulkUploaderModal');
    modal.style.display = 'flex';
    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
}

function closeBulkUploader() { 
    document.body.classList.remove('modal-open');
    const modal = document.getElementById('bulkUploaderModal');
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}

// ========== FIX 2: Modal expand functionality ==========
function toggleModalExpand(modalId) {
    const modalContent = document.querySelector(`#${modalId} .modal-content`);
    const expandBtn = document.querySelector(`#${modalId} .expand-button i`);
    
    if (modalContent.classList.contains('modal-expanded')) {
        modalContent.classList.remove('modal-expanded');
        expandBtn.className = 'fas fa-expand';
    } else {
        modalContent.classList.add('modal-expanded');
        expandBtn.className = 'fas fa-compress';
    }
}

// ========== FIX 3: Updated header button visibility ==========
function updateHeaderButtons() {
    const headerSignOutBtn = document.getElementById('headerSignOutBtn');
    if (isAuthenticated && currentUser) {
        headerSignOutBtn.style.display = 'flex';
    } else {
        headerSignOutBtn.style.display = 'none';
    }
}

// Override handleSignOut to update header buttons
const originalHandleSignOut = window.handleSignOut;
window.handleSignOut = function() {
    originalHandleSignOut();
    updateHeaderButtons();
};

// ========== FIX 1: Added function to open subject dropdown for subject page ==========
function openSubjectDropdown(subject, button) {
    const existingMenus = document.querySelectorAll('.subject-dropdown-menu');
    existingMenus.forEach(menu => menu.remove());
    
    let hasContent = false;
    if (quizData[subject]) {
        const questionCount = Object.values(quizData[subject]).reduce((sum, level) => sum + (level.length || 0), 0);
        if (questionCount > 0) hasContent = true;
    }
    
    const dropdown = document.createElement('div');
    dropdown.className = 'subject-dropdown-menu';
    dropdown.innerHTML = `
        <button class="edit-btn" onclick="editSubjectOnPage('${subject}')">
            <i class="fas fa-edit"></i> Edit
        </button>
        <button class="delete-btn" onclick="deleteSubjectOnPage('${subject}')" ${hasContent ? 'style="opacity: 0.5; cursor: not-allowed;"' : ''}>
            <i class="fas fa-trash"></i> Delete
        </button>
    `;
    
    const buttonRect = button.getBoundingClientRect();
    
    const menuHeight = 80;
    const spaceBelow = window.innerHeight - buttonRect.bottom;
    const spaceAbove = buttonRect.top;
    
    let top, left;
    
    if (spaceBelow < menuHeight && spaceAbove >= menuHeight) {
        top = buttonRect.top + window.scrollY - menuHeight;
    } else {
        top = buttonRect.bottom + window.scrollY;
    }
    
    left = buttonRect.right + window.scrollX - 120;
    
    if (left < 10) left = 10;
    
    dropdown.style.position = 'fixed';
    dropdown.style.top = `${top}px`;
    dropdown.style.left = `${left}px`;
    dropdown.style.zIndex = '10000';
    
    document.body.appendChild(dropdown);
    
    setTimeout(() => {
        const closeHandler = function(e) {
            if (!dropdown.contains(e.target) && !button.contains(e.target)) {
                dropdown.remove();
                document.removeEventListener('click', closeHandler);
            }
        };
        document.addEventListener('click', closeHandler);
    }, 10);
}

// ========== FIX 1: COMPLETELY FIXED Exam Submit Button ==========
function submitEssayAnswer() {
    if (isAnswered) return;
    isAnswered = true;
    
    const essayAnswer = document.getElementById('essayAnswer').value.trim();
    const q = quizData[currentSubject][currentLevel][currentQuestionIndex];
    
    q.userAnswer = essayAnswer;
    
    const essayBtn = document.getElementById('essaySubmitBtn');
    const questions = quizData[currentSubject][currentLevel];
    const isLastQuestion = currentQuestionIndex === questions.length - 1;
    
    if (isLastQuestion) {
        // Immediately submit the exam
        essayBtn.textContent = "Submitting...";
        essayBtn.disabled = true;
        
        // Small delay to show the "Submitting..." text, then render results
        setTimeout(() => {
            renderResults();
        }, 100);
    } else {
        essayBtn.textContent = "Next â†’";
        essayBtn.classList.remove('btn-primary');
        essayBtn.classList.add('btn-success');
        essayBtn.onclick = nextQuestion;
    }
}

// Updated nextQuestion to properly handle last question
function nextQuestion() {
    const questions = quizData[currentSubject][currentLevel];
    
    // Check if we're at the last question
    if (currentQuestionIndex >= questions.length - 1) {
        renderResults();
        return;
    }
    
    currentQuestionIndex++;
    renderQuestion();
}

// ========== NEW: Exam Upload Options ==========
let pendingExamData = {
    type: null,
    subject: '',
    level: 0,
    questions: [],
    fileData: null,
    existingQuestionsCount: 0
};

function showExamUploadOptions(type, subject, level, questions, fileData = null) {
    const existingQuestions = quizData[subject] && quizData[subject][level] ? quizData[subject][level] : [];
    const existingCount = existingQuestions.length;
    
    pendingExamData = {
        type: type,
        subject: subject,
        level: level,
        questions: questions,
        fileData: fileData,
        existingQuestionsCount: existingCount
    };
    
    const message = document.getElementById('examUploadMessage');
    message.innerHTML = `
        An exam already exists for <strong>${subject}</strong> at Level ${level}.<br>
        Current exam has ${existingCount} questions.<br>
        New exam has ${questions.length} questions.
    `;
    
    document.body.classList.add('modal-open');
    document.getElementById('examUploadOptionsModal').classList.add('show');
}

function closeExamUploadOptionsModal() {
    document.body.classList.remove('modal-open');
    document.getElementById('examUploadOptionsModal').classList.remove('show');
    pendingExamData = {
        type: null,
        subject: '',
        level: 0,
        questions: [],
        fileData: null,
        existingQuestionsCount: 0
    };
}

function handleExamUploadOption(option) {
    const { type, subject, level, questions, fileData, existingQuestionsCount } = pendingExamData;
    
    closeExamUploadOptionsModal();
    
    if (option === 'new') {
        let newLevel = level;
        while (quizData[subject] && quizData[subject][newLevel]) {
            newLevel++;
        }
        
        if (type === 'manual') {
            saveManualExamToDatabase(subject, newLevel, questions);
        } else if (type === 'bulk') {
            processBulkQuestionsToDatabase(subject, newLevel, questions, fileData);
        }
        
        alertMessage(`Exam saved as new exam at Level ${newLevel}`, "bg-gradient-to-r from-green-500 to-teal-500");
    } else if (option === 'overwrite') {
        if (type === 'manual') {
            saveManualExamToDatabase(subject, level, questions, true);
        } else if (type === 'bulk') {
            processBulkQuestionsToDatabase(subject, level, questions, fileData, true);
        }
        
        alertMessage(`Exam overwritten at Level ${level}`, "bg-gradient-to-r from-green-500 to-teal-500");
    } else if (option === 'append') {
        const existingQuestions = quizData[subject] && quizData[subject][level] ? quizData[subject][level] : [];
        const allQuestions = [...existingQuestions, ...questions];
        
        if (type === 'manual') {
            saveManualExamToDatabase(subject, level, allQuestions, true);
        } else if (type === 'bulk') {
            processBulkQuestionsToDatabase(subject, level, allQuestions, fileData, true);
        }
        
        alertMessage(`Appended ${questions.length} questions to existing exam`, "bg-gradient-to-r from-green-500 to-teal-500");
    }
}

function saveManualExamToDatabase(subject, level, questions, overwrite = false) {
    if (!quizData[subject]) quizData[subject] = {};
    
    if (overwrite || !quizData[subject][level]) {
        quizData[subject][level] = [];
    }
    
    questions.forEach(q => {
        const processedOptions = q.options.map(opt => String(opt).trim()).filter(opt => opt !== '');
        
        if (q.type === 'truefalse' && processedOptions.length < 2) {
            processedOptions.push('True', 'False');
        }
        
        if (processedOptions.length < 2 && q.type !== 'essay') {
            processedOptions.push('Option B', 'Option C', 'Option D');
        }
        
        quizData[subject][level].push({
            question: q.question.trim(),
            options: processedOptions,
            answer: String(q.answer).trim(),
            type: q.type,
            hint: q.hint || ''
        });
    });
    
    saveQuizData();
    closeManualExamCreator();
    
    renderSubjectLevels(subject);
}

function processBulkQuestionsToDatabase(subject, level, questions, fileData = null, overwrite = false) {
    if (!quizData[subject]) quizData[subject] = {};
    
    if (overwrite || !quizData[subject][level]) {
        quizData[subject][level] = [];
    }
    
    questions.forEach(q => {
        quizData[subject][level].push(q);
    });
    
    saveQuizData();
    closeBulkUploader();
    
    renderSubjectLevels(subject);
}

// Function to handle first-time admin signup
function handleFirstTimeAdminSignup(userEmail) {
    if (userEmail === "admin@awa.com") {
        return true;
    }
    
    const adminAuthKey = `admin_auth_${userEmail}`;
    const hasAdminAuth = localStorage.getItem(adminAuthKey);
    
    if (!hasAdminAuth) {
        pendingAdminUser = userEmail;
        showAdminPasskeyPopup();
        return false;
    }
    
    return true;
}

// Check admin authorization status
function checkAdminAuthorization(userEmail) {
    if (userEmail === "admin@awa.com") {
        return true;
    }
    
    const adminAuthKey = `admin_auth_${userEmail}`;
    const isAuthorized = localStorage.getItem(adminAuthKey);
    return !!isAuthorized;
}

// Show passkey popup for first-time admin
function showAdminPasskeyPopup() {
    document.body.classList.add('modal-open');
    
    if (!document.getElementById('adminPasskeyModal')) {
        const modalHTML = `
            <div id="adminPasskeyModal" class="modal-bg">
                <div class="modal-content">
                    <h4 class="modal-header text-xl font-bold text-gray-800">Admin Authorization Required</h4>
                    <div class="modal-body">
                        <div class="text-center mb-6">
                            <div class="inline-block p-4 rounded-2xl bg-gradient-to-r from-yellow-100 to-amber-100 mb-4">
                                <i class="fas fa-shield-alt text-4xl text-yellow-500"></i>
                            </div>
                            <h5 class="text-lg font-bold text-gray-800">First-Time Admin Access</h5>
                            <p class="text-sm text-gray-600 mt-2 mb-4">
                                As a first-time admin, you need authorization from an existing admin (admin1).
                                Please contact admin1 to get the passkey.
                            </p>
                        </div>
                        
                        <div class="mb-4">
                            <label class="block text-sm font-bold text-gray-700 mb-2">Enter Admin1 Passkey:</label>
                            <input type="password" id="adminPasskeyInput" 
                                   class="input-field text-center" 
                                   placeholder="Enter passkey from admin1"
                                   autocomplete="off">
                            <p class="text-xs text-gray-500 mt-2">Passkey is case-sensitive</p>
                        </div>
                        
                        <div id="passkeyError" class="text-red-500 text-sm mt-3 hidden text-center"></div>
                        
                        <div class="bg-gradient-to-r from-blue-50 to-cyan-50 p-3 rounded-lg mt-4">
                            <p class="text-xs text-blue-600">
                                <i class="fas fa-info-circle mr-2"></i>
                                Once authorized, you'll be able to reset your admin settings and will be considered as admin1 for future authorizations.
                            </p>
                        </div>
                    </div>
                    
                    <div class="modal-footer flex justify-between space-x-3">
                        <button type="button" onclick="cancelAdminAuthorization()" 
                                class="btn-secondary w-full py-3">Cancel</button>
                        <button type="button" onclick="verifyAdminPasskey()" 
                                class="btn-success w-full py-3">Authorize</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    }
    
    document.getElementById('adminPasskeyModal').classList.add('show');
}

// Show registration passcode modal for first-time users
function showRegistrationPasscodeModal() {
    document.body.classList.add('modal-open');
    document.getElementById('registrationPasscodeModal').classList.add('show');
    document.getElementById('registrationPasscodeError').classList.add('hidden');
    document.getElementById('registrationPasscodeInput').value = '';
}

// Close registration passcode modal
function closeRegistrationPasscodeModal() {
    document.body.classList.remove('modal-open');
    document.getElementById('registrationPasscodeModal').classList.remove('show');
}

// Check registration passcode
function checkRegistrationPasscode() {
    const passcodeInput = document.getElementById('registrationPasscodeInput');
    const errorElement = document.getElementById('registrationPasscodeError');
    
    if (!passcodeInput.value) {
        errorElement.textContent = "Please enter the admin passcode";
        errorElement.classList.remove('hidden');
        return;
    }
    
    if (passcodeInput.value === REGISTRATION_PASSCODE) {
        completePendingRegistration();
        closeRegistrationPasscodeModal();
    } else {
        errorElement.textContent = "Incorrect admin passcode. Please contact your administrator.";
        errorElement.classList.remove('hidden');
        
        passcodeInput.value = '';
        passcodeInput.focus();
    }
}

// Complete the pending registration after passcode verification
function completePendingRegistration() {
    if (!pendingRegistrationUser) return;
    
    const { name, email, password, role, adminPasskey } = pendingRegistrationUser;
    
    if (role === 'admin') {
        if (email === "admin@awa.com") {
            // Main admin always gets access
        } else if (adminPasskey !== ADMIN_PASSKEY) {
            alertMessage('Invalid admin passkey. Contact existing admin1 for authorization.', 
                        'bg-gradient-to-r from-red-500 to-pink-500');
            pendingRegistrationUser = null;
            return;
        }
        
        const adminAuthKey = `admin_auth_${email}`;
        localStorage.setItem(adminAuthKey, 'authorized');
        localStorage.setItem(`${adminAuthKey}_timestamp`, Date.now().toString());
        localStorage.setItem(`${adminAuthKey}_is_admin1`, 'true');
    }
    
    const newUser = {
        username: name.replace(/\s/g, '').toLowerCase(),
        password: password,
        name: name,
        email: email,
        grade: role === 'student' ? "1st Grade" : "N/A",
        quizzesTaken: 0,
        lastAttempt: null,
        levelProgress: {},
        lastAttemptDetails: {},
        testHistory: [],
        role: role,
        canAuthorizeAdmins: role === 'admin'
    };
    
    mockUsers.push(newUser);
    saveUsers();
    isAuthenticated = true;
    currentUser = newUser;
    
    alertMessage(`Account Created Successfully! Welcome as ${role}.`, 
                'bg-gradient-to-r from-green-500 to-teal-500');
    
    pendingRegistrationUser = null;
    
    renderWelcomeScreen();
    updateHeaderButtons();
}

// Verify admin passkey
function verifyAdminPasskey() {
    const passkeyInput = document.getElementById('adminPasskeyInput');
    const errorElement = document.getElementById('passkeyError');
    
    if (!passkeyInput.value) {
        errorElement.textContent = "Please enter the passkey";
        errorElement.classList.remove('hidden');
        return;
    }
    
    if (passkeyInput.value === ADMIN_PASSKEY) {
        const userEmail = pendingAdminUser;
        const adminAuthKey = `admin_auth_${userEmail}`;
        localStorage.setItem(adminAuthKey, 'authorized');
        
        const authTimestamp = Date.now();
        localStorage.setItem(`${adminAuthKey}_timestamp`, authTimestamp.toString());
        
        localStorage.setItem(`${adminAuthKey}_is_admin1`, 'true');
        
        document.getElementById('adminPasskeyModal').classList.remove('show');
        document.body.classList.remove('modal-open');
        
        const userIndex = mockUsers.findIndex(u => u.email === userEmail);
        if (userIndex !== -1) {
            mockUsers[userIndex].role = 'admin';
            mockUsers[userIndex].canAuthorizeAdmins = true;
            saveUsers();
            
            if (currentUser && currentUser.email === userEmail) {
                currentUser.role = 'admin';
                currentUser.canAuthorizeAdmins = true;
            }
        }
        
        alertMessage("Admin authorization successful! You now have full admin privileges.", 
                    "bg-gradient-to-r from-green-500 to-teal-500");
        
        renderWelcomeScreen();
        updateHeaderButtons();
        
    } else {
        errorElement.textContent = "Incorrect passkey. Please contact admin1 for the correct passkey.";
        errorElement.classList.remove('hidden');
        
        if (!adminAuthorizationAttempts[pendingAdminUser]) {
            adminAuthorizationAttempts[pendingAdminUser] = 0;
        }
        adminAuthorizationAttempts[pendingAdminUser]++;
        
        passkeyInput.value = '';
        passkeyInput.focus();
    }
}

// Cancel admin authorization
function cancelAdminAuthorization() {
    if (document.getElementById('adminPasskeyModal')) {
        document.getElementById('adminPasskeyModal').classList.remove('show');
    }
    document.body.classList.remove('modal-open');
    
    pendingAdminUser = null;
    
    if (currentUser) {
        currentUser.role = 'student';
        renderWelcomeScreen();
        updateHeaderButtons();
    }
}

// Initialize role permissions
function initializeRolePermissions() {
    const rolePermissions = {
        'student': {
            canUploadResources: false,
            canCreateExams: false,
            canManageSubjects: false,
            canAccessAdminTools: false
        },
        'parent': {
            canUploadResources: true,
            canCreateExams: true,
            canManageSubjects: false,
            canAccessAdminTools: false,
            allowedTools: ['bulkUploader', 'manualExam', 'resourceUploader']
        },
        'teacher': {
            canUploadResources: true,
            canCreateExams: true,
            canManageSubjects: true,
            canAccessAdminTools: false,
            allowedTools: ['bulkUploader', 'manualExam', 'resourceUploader', 'subjectManagement']
        },
        'admin': {
            canUploadResources: true,
            canCreateExams: true,
            canManageSubjects: true,
            canAccessAdminTools: true,
            allowedTools: ['bulkUploader', 'manualExam', 'resourceUploader', 'subjectManagement', 'adminDashboard']
        }
    };
    
    localStorage.setItem('rolePermissions', JSON.stringify(rolePermissions));
}

// Check if user has permission for specific action
function checkUserPermission(user, action) {
    const permissions = JSON.parse(localStorage.getItem('rolePermissions')) || initializeRolePermissions();
    const userRole = user?.role || 'student';
    
    if (permissions[userRole]) {
        return permissions[userRole][action] || false;
    }
    
    return false;
}

// Update signup form to include parent and teacher roles
function renderSignUpFormWithRoles() {
    headerTitle.textContent = "Create Account";
    document.getElementById('adminFooter').style.display = 'none';
    
    quizApp.innerHTML = `
        <div class="space-y-8 flex flex-col h-full justify-center">
            <div class="text-center">
                <div class="inline-block p-4 rounded-2xl bg-gradient-to-r from-green-100 to-teal-100 mb-4">
                    <i class="fas fa-user-plus text-4xl text-green-500"></i>
                </div>
                <h3 class="text-2xl font-bold text-blue-700 mb-1">Join the Learning Community!</h3>
            </div>
            
            <form onsubmit="event.preventDefault(); handleSignUpWithRole()">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-blue-700 mb-2">Your Name</label>
                        <input type="text" id="signUpName" placeholder="John Smith" required 
                               class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-blue-700 mb-2">Your Email</label>
                        <input type="email" id="signUpUsername" placeholder="student@example.com" required 
                               class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-blue-700 mb-2">Password</label>
                        <input type="password" id="signUpPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required 
                               class="input-field">
                    </div>
                    
                    <!-- Role Selection -->
                    <div>
                        <label class="block text-sm font-semibold text-blue-700 mb-2">Account Type</label>
                        <select id="signUpRole" class="input-field" onchange="toggleAdminPasskeyField()">
                            <option value="student">Student</option>
                            <option value="parent">Parent</option>
                            <option value="teacher">Teacher</option>
                            <option value="admin">Administrator</option>
                        </select>
                    </div>
                    
                    <!-- Admin Passkey Field (Hidden by default) -->
                    <div id="adminPasskeyField" class="hidden">
                        <label class="block text-sm font-semibold text-blue-700 mb-2">Admin Authorization Passkey</label>
                        <input type="password" id="adminSignupPasskey" 
                               class="input-field" 
                               placeholder="Enter admin1 passkey">
                        <p class="text-xs text-gray-500 mt-1">Required for first-time admin access. Contact existing admin1.</p>
                    </div>
                </div>
                
                <button type="submit" 
                        class="btn-success w-full py-4 rounded-xl text-lg mt-8 shadow-lg">
                    <i class="fas fa-user-check mr-2"></i> Create Account
                </button>
            </form>
            
            <div class="text-center mt-4">
                <!-- Back Button -->
                <button onclick="goBack()" class="back-button" style="position: relative; top: 0; left: 0; margin-bottom: 15px;">
                    <i class="fas fa-arrow-left"></i>
                </button>
            </div>
        </div>`;
}

// Toggle admin passkey field based on role selection
function toggleAdminPasskeyField() {
    const roleSelect = document.getElementById('signUpRole');
    const adminPasskeyField = document.getElementById('adminPasskeyField');
    
    if (roleSelect.value === 'admin') {
        adminPasskeyField.classList.remove('hidden');
    } else {
        adminPasskeyField.classList.add('hidden');
    }
}

// Updated signup handler with role support and admin approval
function handleSignUpWithRole() {
    const name = document.getElementById('signUpName').value.trim();
    const email = document.getElementById('signUpUsername').value;
    const password = document.getElementById('signUpPassword').value;
    const role = document.getElementById('signUpRole').value;
    const adminPasskey = document.getElementById('adminSignupPasskey')?.value || '';
    
    if (!name || !email || !password) {
        alertMessage('All fields required', 'bg-gradient-to-r from-red-500 to-pink-500');
        return;
    }
    
    if (mockUsers.some(u => u.email === email)) {
        alertMessage('Email already exists', 'bg-gradient-to-r from-red-500 to-pink-500');
        return;
    }
    
    pendingRegistrationUser = {
        name: name,
        email: email,
        password: password,
        role: role,
        adminPasskey: adminPasskey
    };
    
    showRegistrationPasscodeModal();
}

// Update welcome screen to show appropriate tools based on role
function updateWelcomeScreenForRoles() {
    const isAdmin = currentUser.role === 'admin';
    const isTeacher = currentUser.role === 'teacher';
    const isParent = currentUser.role === 'parent';
    
    if (isAdmin || isTeacher || isParent) {
        let toolsHTML = '';
        
        if (isAdmin) {
            toolsHTML = `
                <div class="admin-tools-scroll-container">
                    <div class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl border border-blue-200 shadow-sm">
                        <p class="text-xs text-blue-700 uppercase font-bold text-center mb-3">ADMIN TOOLS</p>
                        <div class="admin-tools-grid">
                            <button onclick="openBulkUploader()" class="admin-tool-btn btn-primary">
                                <i class="fas fa-file-upload mb-1 text-lg"></i> Bulk
                            </button>
                            <button onclick="openManualExamCreator()" class="admin-tool-btn btn-success">
                                <i class="fas fa-edit mb-1 text-lg"></i> Manual
                            </button>
                            <button onclick="openResourceUploader()" class="admin-tool-btn btn-purple">
                                <i class="fas fa-folder-open mb-1 text-lg"></i> Res.
                            </button>
                            <button onclick="openUrlManager()" class="admin-tool-btn url-button">
                                <i class="fas fa-link mb-1 text-lg"></i> URLs
                            </button>
                            <button onclick="openSubjectManagement()" class="admin-tool-btn bg-gradient-to-r from-indigo-500 to-purple-500 text-white">
                                <i class="fas fa-book mb-1 text-lg"></i> Subjects
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="adminWelcomeFooter" class="mt-4">
                    <div class="footer-buttons-container">
                        <button type="button" onclick="handleSignOut()" class="btn-secondary py-3 rounded-xl shadow-lg transition-all duration-300 text-sm flex items-center justify-center">
                            <i class="fas fa-sign-out-alt mr-2 text-lg"></i>
                            Sign Out
                        </button>
                        <button type="button" onclick="openModal('dashboard')" class="btn-danger py-3 rounded-xl shadow-lg transition-all duration-300 text-sm flex items-center justify-center">
                            <i class="fas fa-cogs mr-2 text-lg"></i>
                            Admin Dashboard
                        </button>
                    </div>
                </div>`;
        } else if (isTeacher) {
            toolsHTML = `
                <div class="admin-tools-scroll-container">
                    <div class="p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-2xl border border-green-200 shadow-sm">
                        <p class="text-xs text-green-700 uppercase font-bold text-center mb-3">TEACHER TOOLS</p>
                        <div class="admin-tools-grid">
                            <button onclick="openBulkUploader()" class="admin-tool-btn btn-primary">
                                <i class="fas fa-file-upload mb-1 text-lg"></i> Bulk Upload
                            </button>
                            <button onclick="openManualExamCreator()" class="admin-tool-btn btn-success">
                                <i class="fas fa-edit mb-1 text-lg"></i> Create Exam
                            </button>
                            <button onclick="openResourceUploader()" class="admin-tool-btn btn-purple">
                                <i class="fas fa-folder-open mb-1 text-lg"></i> Resources
                            </button>
                            <button onclick="openSubjectManagement()" class="admin-tool-btn bg-gradient-to-r from-green-500 to-emerald-500 text-white">
                                <i class="fas fa-book mb-1 text-lg"></i> Subjects
                            </button>
                        </div>
                    </div>
                </div>`;
        } else if (isParent) {
            toolsHTML = `
                <div class="admin-tools-scroll-container">
                    <div class="p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-2xl border border-purple-200 shadow-sm">
                        <p class="text-xs text-purple-700 uppercase font-bold text-center mb-3">PARENT TOOLS</p>
                        <div class="admin-tools-grid">
                            <button onclick="openBulkUploader()" class="admin-tool-btn btn-primary">
                                <i class="fas fa-file-upload mb-1 text-lg"></i> Bulk Upload
                            </button>
                            <button onclick="openManualExamCreator()" class="admin-tool-btn btn-success">
                                <i class="fas fa-edit mb-1 text-lg"></i> Create Exam
                            </button>
                            <button onclick="openResourceUploader()" class="admin-tool-btn btn-purple">
                                <i class="fas fa-folder-open mb-1 text-lg"></i> Resources
                            </button>
                        </div>
                    </div>
                </div>`;
        }
        
        return toolsHTML;
    }
    
    return '';
}

// Override existing handleSignIn to check for admin authorization
function handleSignIn() {
    const email = document.getElementById('signInUsername').value;
    const password = document.getElementById('signInPassword').value;
    const user = mockUsers.find(u => u.email === email && u.password === password);
    
    if (user) {
        if (user.role === 'admin' && !checkAdminAuthorization(user.email)) {
            pendingAdminUser = user.email;
            showAdminPasskeyPopup();
            return;
        }
        
        isAuthenticated = true;
        currentUser = user;
        if(!currentUser.testHistory) currentUser.testHistory = [];
        alertMessage(`Welcome back, ${currentUser.name}!`, 'bg-gradient-to-r from-green-500 to-teal-500');
        renderWelcomeScreen();
        updateHeaderButtons();
    } else {
        alertMessage('Sign In failed. Check credentials.', 'bg-gradient-to-r from-red-500 to-pink-500');
    }
}

// Override existing renderWelcomeScreen to include role-based tools
function renderWelcomeScreen() {
    if (!isAuthenticated) return renderAuthScreen();
    
    headerTitle.textContent = `Welcome, ${currentUser.name}!`;
    
    document.getElementById('adminFooter').style.display = 'none';
    
    const isAdmin = currentUser.role === 'admin';
    const isTeacher = currentUser.role === 'teacher';
    const isParent = currentUser.role === 'parent';
    
    quizApp.innerHTML = `
        <div class="flex flex-col h-full">
            <div class="flex justify-between items-center px-2 mb-4">
                <button onclick="renderStudentProfile()" class="btn-primary px-4 py-2 rounded-xl text-sm flex items-center">
                    <i class="fas fa-user-graduate mr-2"></i> My Profile
                </button>
                ${(isAdmin || isTeacher || isParent) ? `
                <button onclick="renderSubjectPage()" class="btn-success px-4 py-2 rounded-xl text-sm flex items-center">
                    <i class="fas fa-book mr-2"></i> Subjects
                </button>
                ` : ''}
            </div>
            
            <!-- Scroll container for subjects -->
            <div class="welcome-scroll-container mb-4">
                <h3 class="text-xl font-bold text-blue-700 text-center mb-4">Choose a Subject</h3>
                <div class="grid grid-cols-2 gap-4 mb-6">
                    ${subjects.map(subject => `
                        <button onclick="renderSubjectLevels('${subject}')" 
                                class="subject-btn">
                            <i class="fas fa-book-open text-2xl mb-2 opacity-80"></i>
                            ${subject.replace(/ â€“ level| - level/i, '')}
                        </button>
                    `).join('')}
                </div>
            </div>
            
            ${updateWelcomeScreenForRoles()}
        </div>
    `;
    
    setTimeout(ensureQuizPreviewScroll, 100);
}

// Override existing renderAuthScreen to use new signup form
function renderAuthScreen() {
    document.getElementById('adminFooter').style.display = 'none';
    
    quizApp.innerHTML = `
        <div class="space-y-8 flex flex-col h-full justify-center">
            <div class="text-center">
                <div class="inline-block p-4 rounded-2xl bg-gradient-to-r from-blue-100 to-cyan-100 mb-4">
                    <i class="fas fa-graduation-cap text-4xl text-blue-500"></i>
                </div>
                <h3 class="text-2xl font-bold text-blue-700 mb-1">Welcome !</h3>
            </div>
            <form onsubmit="event.preventDefault(); handleSignIn()">
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-blue-700 mb-2">Your Email</label>
                        <input type="email" id="signInUsername" placeholder="student@example.com" required 
                               class="input-field">
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-blue-700 mb-2">Password</label>
                        <input type="password" id="signInPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required 
                               class="input-field">
                    </div>
                </div>
                <button type="submit" 
                        class="btn-primary w-full py-4 rounded-xl text-lg mt-8 shadow-lg">
                    <i class="fas fa-sign-in-alt mr-2"></i> Sign In
                </button>
            </form>
            <div class="text-center mt-4">
                <p class="text-blue-600 text-sm mb-2">Don't have an account?</p>
                <button onclick="renderSignUpFormWithRoles()" class="text-blue-600 font-semibold hover:text-blue-800 text-sm border border-blue-300 hover:border-blue-500 px-4 py-2 rounded-lg transition-all duration-300">
                    Create an Account
                </button>
            </div>
        </div>`;
}

// ==== ACCORDION FUNCTIONS ====
function toggleAccordion(level) {
    const content = document.getElementById(`accordion-content-${level}`);
    const icon = document.getElementById(`accordion-icon-${level}`);
    
    if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        icon.className = 'fas fa-chevron-down';
    } else {
        document.querySelectorAll('.accordion-content').forEach(acc => {
            acc.classList.remove('expanded');
        });
        document.querySelectorAll('.accordion-header i').forEach(icon => {
            icon.className = 'fas fa-chevron-down';
        });
        
        content.classList.add('expanded');
        icon.className = 'fas fa-chevron-up';
    }
}

// ==== INDEXEDDB HELPERS ====
const DB_NAME = 'SofanitDB';
const DB_VERSION = 3;
const STORE_NAME = 'resources';

function openDB() {
    return new Promise((resolve, reject) => {
        const request = indexedDB.open(DB_NAME, DB_VERSION);
        request.onupgradeneeded = (event) => {
            const db = event.target.result;
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                db.createObjectStore(STORE_NAME, { keyPath: 'id' });
            }
        };
        request.onsuccess = (event) => resolve(event.target.result);
        request.onerror = (event) => reject(event.target.error);
    });
}

async function saveFileToDB(fileBlob, id) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readwrite');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.put({ id: id, file: fileBlob });
        request.onsuccess = () => resolve();
        request.onerror = (e) => reject(e.target.error);
    });
}

async function getFileFromDB(id) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
        const transaction = db.transaction([STORE_NAME], 'readonly');
        const store = transaction.objectStore(STORE_NAME);
        const request = store.get(id);
        request.onsuccess = (event) => {
            const result = event.target.result;
            resolve(result ? result.file : null);
        };
        request.onerror = (e) => reject(e.target.error);
    });
}

// ========== Audio Player Functions ==========
function createAudioPlayer(audioId, audioName) {
    const playerId = `audio-player-${audioId}`;
    const controlsId = `audio-controls-${audioId}`;
    
    return `
        <div class="audio-player-container">
            <div class="flex items-center justify-between mb-2">
                <div class="flex items-center">
                    <i class="fas fa-music text-purple-500 mr-2"></i>
                    <span class="text-sm font-semibold text-gray-800 truncate">${audioName}</span>
                </div>
                <button onclick="playPauseAudio('${audioId}', '${playerId}', '${controlsId}')" 
                        class="audio-control-btn play-btn" id="play-btn-${audioId}">
                    <i class="fas fa-play"></i> Play
                </button>
            </div>
            <audio id="${playerId}" preload="metadata" class="audio-player">
                <source src="" type="audio/mpeg">
                Your browser does not support the audio element.
            </audio>
            <div class="audio-controls" id="${controlsId}">
                <button onclick="rewindAudio('${audioId}', '${playerId}')" class="audio-control-btn">
                    <i class="fas fa-backward"></i>
                </button>
                <div class="audio-progress">
                    <div class="audio-progress-bar" id="progress-bar-${audioId}"></div>
                </div>
                <button onclick="forwardAudio('${audioId}', '${playerId}')" class="audio-control-btn">
                    <i class="fas fa-forward"></i>
                </button>
                <span class="audio-time" id="current-time-${audioId}">0:00</span>
                <span class="audio-time">/</span>
                <span class="audio-time" id="duration-${audioId}">0:00</span>
                <button onclick="downloadAudio('${audioId}')" class="audio-control-btn">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        </div>
    `;
}

async function playAudioResource(audioId, audioName, subject, level) {
    try {
        const audioBlob = await getFileFromDB(audioId);
        if (!audioBlob) {
            alertMessage("Audio file not found in database", "bg-gradient-to-r from-red-500 to-pink-500");
            return;
        }
        
        const audioUrl = URL.createObjectURL(audioBlob);
        
        const modal = document.createElement('div');
        modal.className = 'modal-bg';
        modal.style.display = 'flex';
        modal.style.zIndex = '2000';
        
        modal.innerHTML = `
            <div class="modal-content" style="max-width: 500px;">
                <h4 class="modal-header text-xl font-bold text-gray-800">Audio Player</h4>
                <div class="modal-body">
                    <div class="text-center mb-4">
                        <div class="inline-block p-4 rounded-2xl bg-gradient-to-r from-purple-100 to-pink-100 mb-4">
                            <i class="fas fa-music text-4xl text-purple-500"></i>
                        </div>
                        <h5 class="text-lg font-bold text-gray-800">${audioName}</h5>
                        <p class="text-sm text-gray-600">${subject.replace(/ â€“ level| - level/i, '')} - Level ${level}</p>
                    </div>
                    ${createAudioPlayer(audioId, audioName)}
                </div>
                <div class="modal-footer">
                    <button type="button" onclick="this.closest('.modal-bg').remove()" class="btn-secondary w-full py-3">Close</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        setTimeout(() => {
            const audioElement = document.getElementById(`audio-player-${audioId}`);
            if (audioElement) {
                audioElement.src = audioUrl;
                
                audioElement.addEventListener('loadedmetadata', function() {
                    const durationElement = document.getElementById(`duration-${audioId}`);
                    durationElement.textContent = formatTime(audioElement.duration);
                });
                
                audioElement.addEventListener('timeupdate', function() {
                    updateAudioProgress(audioId, audioElement);
                });
                
                audioElement.addEventListener('ended', function() {
                    const playBtn = document.getElementById(`play-btn-${audioId}`);
                    if (playBtn) {
                        playBtn.innerHTML = '<i class="fas fa-play"></i> Play';
                    }
                });
            }
        }, 100);
        
    } catch (error) {
        console.error('Error playing audio:', error);
        alertMessage("Error playing audio file", "bg-gradient-to-r from-red-500 to-pink-500");
    }
}

function playPauseAudio(audioId, playerId, controlsId) {
    const audioElement = document.getElementById(playerId);
    const playBtn = document.getElementById(`play-btn-${audioId}`);
    
    if (!audioElement) return;
    
    if (audioElement.paused) {
        audioElement.play();
        playBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
    } else {
        audioElement.pause();
        playBtn.innerHTML = '<i class="fas fa-play"></i> Play';
    }
}

function rewindAudio(audioId, playerId) {
    const audioElement = document.getElementById(playerId);
    if (!audioElement) return;
    
    audioElement.currentTime = Math.max(0, audioElement.currentTime - 10);
    updateAudioProgress(audioId, audioElement);
}

function forwardAudio(audioId, playerId) {
    const audioElement = document.getElementById(playerId);
    if (!audioElement) return;
    
    audioElement.currentTime = Math.min(audioElement.duration, audioElement.currentTime + 10);
    updateAudioProgress(audioId, audioElement);
}

function updateAudioProgress(audioId, audioElement) {
    const progressBar = document.getElementById(`progress-bar-${audioId}`);
    const currentTimeElement = document.getElementById(`current-time-${audioId}`);
    
    if (progressBar && currentTimeElement && audioElement) {
        const progress = (audioElement.currentTime / audioElement.duration) * 100;
        progressBar.style.width = `${progress}%`;
        currentTimeElement.textContent = formatTime(audioElement.currentTime);
    }
}

function formatTime(seconds) {
    if (isNaN(seconds)) return "0:00";
    
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
}

async function downloadAudio(audioId) {
    try {
        const audioBlob = await getFileFromDB(audioId);
        if (!audioBlob) {
            alertMessage("Audio file not found", "bg-gradient-to-r from-red-500 to-pink-500");
            return;
        }
        
        const audioUrl = URL.createObjectURL(audioBlob);
        const a = document.createElement('a');
        a.href = audioUrl;
        a.download = `audio-${audioId}.mp3`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(audioUrl);
        
        alertMessage("Audio download started", "bg-gradient-to-r from-green-500 to-teal-500");
    } catch (error) {
        console.error('Error downloading audio:', error);
        alertMessage("Error downloading audio", "bg-gradient-to-r from-red-500 to-pink-500");
    }
}

// ==== GLOBAL VARIABLES ====
let quizApp, headerTitle, timerDisplay;
let isAuthenticated = false;
let currentUser = null;
let mockUsers = [];
const adminPassword = "admin2121";

// Storage keys
const STORAGE_KEY = 'awa_users';
const SETTINGS_KEY = 'awa_settings';
const QUIZ_DATA_KEY = 'awa_quiz_data';
const RESOURCES_KEY = 'awa_resources_v4';
const SUBJECTS_KEY = 'awa_subjects';

// Quiz state
let currentSubject = '';
let currentLevel = 0;
let currentQuestionIndex = 0;
let score = 0;
let startTime = null;
let isAnswered = false;
let selectedOptions = []; 
let quizSettings = {
    timerEnabled: true,
    minutesPerQuestion: 1
};

// Quiz data structure
let quizData = {};
let resources = {};
let manualQuestions = [];
let subjects = [];
let pendingSubjectChanges = [];

// Level display names
let levelDisplayNames = {};

// URL management
let urlInputs = [{
    name: '',
    url: ''
}];

// Level rename state
let levelRenameState = {
    subject: '',
    oldLevel: 0,
    newLevel: 0
};

// Add Level state
let addLevelState = {
    subject: '',
    isOpen: false,
    type: 'level'
};

// Subject page state
let subjectPageOpen = false;

// ========== FIX 1: Enhanced Answer Checking Function ==========
function normalizeText(text) {
    if (text === null || text === undefined) return "";
    
    let str = String(text).trim();
    
    if (/[\u0000-\u007F]/.test(str)) {
        str = str.toLowerCase();
    }
    
    str = str.replace(/\s+/g, ' ');
    
    str = str
        .replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, '')
        .replace(/\s+/g, ' ');
    
    return str;
}

function isAnswerCorrect(userAnswer, question) {
    const userStr = String(userAnswer || '').trim();
    const correctStr = String(question.answer || '').trim();
    
    if (Array.isArray(question.answer)) {
        let correctAnswerText = '';
        if (question.answer.length === 1) {
            const index = question.answer[0];
            if (index >= 0 && index < question.options.length) {
                correctAnswerText = question.options[index];
            }
        } else {
            const answerTexts = question.answer
                .filter(idx => idx >= 0 && idx < question.options.length)
                .map(idx => question.options[idx]);
            correctAnswerText = answerTexts.join(',');
        }
        
        const normalizedUser = normalizeText(userStr);
        const normalizedCorrect = normalizeText(correctAnswerText);
        
        return normalizedUser === normalizedCorrect;
    }
    
    if (/^\d+$/.test(correctStr)) {
        const index = parseInt(correctStr) - 1;
        if (index >= 0 && index < question.options.length) {
            const correctOption = question.options[index];
            const normalizedUser = normalizeText(userStr);
            const normalizedCorrect = normalizeText(correctOption);
            
            return normalizedUser === normalizedCorrect;
        }
    }
    
    if (correctStr.includes(',') || correctStr.includes('|')) {
        const separator = correctStr.includes(',') ? ',' : '|';
        const correctAnswers = correctStr.split(separator).map(a => normalizeText(a.trim()));
        const userAnswers = userStr.split(separator).map(a => normalizeText(a.trim()));
        
        if (question.type === 'checkbox') {
            const allCorrect = correctAnswers.every(ca => 
                userAnswers.some(ua => ua === ca)
            );
            
            return allCorrect;
        }
        
        const singleCorrect = correctAnswers.some(ca => ca === normalizeText(userStr));
        
        return singleCorrect;
    }
    
    const normalizedUser = normalizeText(userStr);
    const normalizedCorrect = normalizeText(correctStr);
    
    return normalizedUser === normalizedCorrect;
}

// ==== UPDATE 1: Enhanced Add Modal Functions ====
function toggleAddTypeFields() {
    const type = document.getElementById('addTypeSelect').value;
    document.getElementById('levelFields').classList.toggle('hidden', type !== 'level');
    document.getElementById('subjectFields').classList.toggle('hidden', type !== 'subject');
    document.getElementById('chapterFields').classList.toggle('hidden', type !== 'chapter');
}

function openAddModal(subject, type = 'level') {
    addLevelState.subject = subject;
    addLevelState.isOpen = true;
    addLevelState.type = type;
    
    document.getElementById('addTypeSelect').value = type;
    toggleAddTypeFields();
    
    if (type === 'level' || type === 'chapter') {
        document.getElementById('addLevelSubjectName').textContent = subject;
        document.getElementById('addChapterSubjectName').textContent = subject;
        
        if (quizData[subject]) {
            const existingLevels = Object.keys(quizData[subject]).map(Number);
            const maxLevel = existingLevels.length > 0 ? Math.max(...existingLevels) : 0;
            document.getElementById('newLevelNumberInput').value = maxLevel + 1;
        } else {
            document.getElementById('newLevelNumberInput').value = 1;
        }
    }
    
    document.body.classList.add('modal-open');
    document.getElementById('addLevelModal').classList.add('show');
}

function saveNewItem() {
    const type = document.getElementById('addTypeSelect').value;
    
    if (type === 'level') {
        saveNewLevel();
    } else if (type === 'subject') {
        saveNewSubjectFromModal();
    } else if (type === 'chapter') {
        saveNewChapter();
    }
}

function saveNewSubjectFromModal() {
    const subjectName = document.getElementById('newSubjectNameInput').value.trim();
    const subjectIcon = document.getElementById('newSubjectIcon').value;
    
    if (!subjectName) {
        alertMessage("Please enter a subject name", "bg-gradient-to-r from-red-500 to-pink-500");
        return;
    }
    
    if (subjects.includes(subjectName)) {
        alertMessage(`Subject "${subjectName}" already exists`, "bg-gradient-to-r from-red-500 to-pink-500");
        return;
    }
    
    subjects.push(subjectName);
    saveSubjects();
    
    if (!quizData[subjectName]) {
        quizData[subjectName] = {};
    }
    if (!resources[subjectName]) {
        resources[subjectName] = {};
    }
    
    saveQuizData();
    saveResourcesMeta();
    updateSubjectSelects();
    
    closeAddLevelModal();
    alertMessage(`Subject "${subjectName}" added successfully`, "bg-gradient-to-r from-green-500 to-teal-500");
    
    if (subjectPageOpen) {
        renderSubjectPage();
    } else {
        renderWelcomeScreen();
    }
}

function saveNewChapter() {
    const chapterName = document.getElementById('newChapterNameInput').value.trim();
    const chapterDesc = document.getElementById('newChapterDescInput').value.trim();
    const subject = addLevelState.subject;
    
    if (!chapterName) {
        alertMessage("Please enter a chapter name", "bg-gradient-to-r from-red-500 to-pink-500");
        return;
    }
    
    if (!subject) {
        alertMessage("No subject selected", "bg-gradient-to-r from-red-500 to-pink-500");
        return;
    }
    
    let nextLevel = 1;
    if (quizData[subject]) {
        const existingLevels = Object.keys(quizData[subject]).map(Number);
        nextLevel = existingLevels.length > 0 ? Math.max(...existingLevels) + 1 : 1;
    }
    
    if (!quizData[subject]) quizData[subject] = {};
    if (!resources[subject]) resources[subject] = {};
    
    quizData[subject][nextLevel] = [];
    resources[subject][nextLevel] = { pdfs: [], videos: [], urls: [], audios: [] };
    
    setLevelDisplayName(subject, nextLevel, chapterName);
    
    saveQuizData();
    saveResourcesMeta();
    saveLevelDisplayNames();
    
    closeAddLevelModal();
    alertMessage(`Chapter "${chapterName}" added to ${subject}`, "bg-gradient-to-r from-green-500 to-teal-500");
    
    renderSubjectLevels(subject);
}

// ========== CRITICAL FIX 1: Enhanced Quiz Results Calculator ==========
function renderResults() {
    stopTimer();
    const endTime = new Date();
    const durationSec = Math.floor((endTime - startTime) / 1000);
    
    const questions = quizData[currentSubject][currentLevel];
    const total = questions.length;
    
    let correctCount = 0;
    let userAnswers = [];
    
    questions.forEach((q, index) => {
        if (q.userAnswer) {
            userAnswers.push(q.userAnswer);
            
            if (isAnswerCorrect(q.userAnswer, q)) {
                correctCount++;
            }
        }
    });
    
    const pct = total > 0 ? Math.round((correctCount / total) * 100) : 0;
    
    const uIdx = mockUsers.findIndex(u => u.email === currentUser.email);
    if (uIdx !== -1) {
        mockUsers[uIdx].quizzesTaken++;
        if (!mockUsers[uIdx].levelProgress[currentSubject]) mockUsers[uIdx].levelProgress[currentSubject] = {};
        mockUsers[uIdx].levelProgress[currentSubject][currentLevel] = Math.max(
            mockUsers[uIdx].levelProgress[currentSubject][currentLevel] || 0, 
            pct
        );
        
        const newAttempt = {
            subject: currentSubject,
            level: currentLevel,
            score: pct,
            date: endTime.toLocaleDateString(),
            time: endTime.toLocaleTimeString(),
            duration: `${Math.floor(durationSec / 60)}m ${durationSec % 60}s`,
            scoreRaw: `${correctCount}/${total}`,
            userAnswers: userAnswers
        };

        mockUsers[uIdx].lastAttemptDetails = newAttempt;

        if (!mockUsers[uIdx].testHistory) mockUsers[uIdx].testHistory = [];
        mockUsers[uIdx].testHistory.unshift(newAttempt);

        saveUsers();
    }

    headerTitle.textContent = "Quiz Complete";
    quizApp.innerHTML = `
        <div class="flex flex-col h-full justify-center text-center space-y-6">
            <button onclick="goBack()" class="back-button">
                <i class="fas fa-arrow-left"></i>
            </button>
            
            <div>
                <div class="text-7xl mb-3">${pct >= 80 ? 'ðŸ†' : (pct >= 50 ? 'ðŸ“š' : 'ðŸŽ¯')}</div>
                <h3 class="text-2xl font-bold ${pct >= 80 ? 'text-green-600' : (pct >= 50 ? 'text-blue-600' : 'text-orange-600')}">
                    ${pct >= 80 ? 'Excellent!' : (pct >= 50 ? 'Good Job!' : 'Keep Practicing!')}
                </h3>
                <p class="text-blue-500 text-sm mt-2">Your Score</p>
                <p class="text-6xl font-black ${pct >= 80 ? 'text-green-600' : (pct >= 50 ? 'text-blue-600' : 'text-orange-600')} my-3">
                    ${correctCount}/${total}
                </p>
                <p class="text-xl font-bold text-gray-400">${pct}%</p>
                
                <div class="mt-4 bg-gradient-to-r from-blue-50 to-cyan-50 p-4 rounded-xl border border-blue-200">
                    <h4 class="font-bold text-blue-700 text-sm mb-2">Score Breakdown</h4>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <div class="text-green-600">âœ“ Correct: ${correctCount}</div>
                        <div class="text-red-600">âœ— Incorrect: ${total - correctCount}</div>
                        <div class="text-blue-600">â± Time: ${Math.floor(durationSec / 60)}:${(durationSec % 60).toString().padStart(2, '0')}</div>
                        <div class="text-purple-600">ðŸ“Š Accuracy: ${pct}%</div>
                    </div>
                </div>
            </div>
            
            <div class="space-y-3">
                <button type="button" onclick="reviewQuiz()" class="btn-purple w-full py-4 rounded-xl shadow-lg">
                    <i class="fas fa-chart-bar mr-2"></i> Review Answers
                </button>
                
                ${pct < 80 ? `
                    <button type="button" onclick="retryQuiz()" class="btn-success w-full py-4 rounded-xl shadow-lg">
                        <i class="fas fa-redo mr-2"></i> Try Again
                    </button>
                ` : ''}
                
                <button type="button" onclick="renderSubjectLevels('${currentSubject}')" class="btn-primary w-full py-4 rounded-xl shadow-lg">
                    <i class="fas fa-book mr-2"></i> Back to ${currentSubject.replace(/ â€“ level| - level/i, '')}
                </button>
            </div>
        </div>`;
}

function reviewQuiz() {
    const questions = quizData[currentSubject][currentLevel];
    
    let reviewHTML = `
        <div class="flex flex-col h-full">
            <button onclick="renderResults()" class="back-button">
                <i class="fas fa-arrow-left"></i>
            </button>
            
            <div class="text-center mb-6">
                <h3 class="text-xl font-bold text-blue-700">Quiz Review</h3>
                <p class="text-sm text-blue-500">${currentSubject.replace(/ â€“ level| - level/i, '')} - Level ${currentLevel}</p>
            </div>
            
            <div class="space-y-4 overflow-y-auto flex-grow pr-2">
    `;
    
    questions.forEach((q, index) => {
        const userAnswer = q.userAnswer || 'Not answered';
        const isCorrect = q.userAnswer ? isAnswerCorrect(q.userAnswer, q) : false;
        let correctAnswerDisplay = q.answer;
        
        if (Array.isArray(q.answer)) {
            correctAnswerDisplay = q.answer.map(idx => {
                if (idx >= 0 && idx < q.options.length) {
                    return q.options[idx];
                }
                return `Option ${idx + 1}`;
            }).join(', ');
        } else if (/^\d+$/.test(q.answer)) {
            const idx = parseInt(q.answer) - 1;
            if (idx >= 0 && idx < q.options.length) {
                correctAnswerDisplay = q.options[idx];
            }
        }
        
        reviewHTML += `
            <div class="bg-gradient-to-r ${isCorrect ? 'from-green-50 to-emerald-50 border-green-200' : 'from-red-50 to-pink-50 border-red-200'} border rounded-xl p-4">
                <div class="flex justify-between items-start mb-2">
                    <span class="font-bold text-gray-800">Q${index + 1}:</span>
                    <span class="text-sm ${isCorrect ? 'text-green-600' : 'text-red-600'} font-bold">
                        ${isCorrect ? 'âœ“ Correct' : 'âœ— Incorrect'}
                    </span>
                </div>
                <p class="text-gray-700 mb-3">${q.question}</p>
                
                <div class="space-y-2">
                    <div class="text-sm">
                        <span class="font-bold text-blue-600">Your Answer:</span>
                        <span class="ml-2 ${isCorrect ? 'text-green-700' : 'text-red-700'}">${userAnswer}</span>
                    </div>
                    ${!isCorrect ? `
                        <div class="text-sm">
                            <span class="font-bold text-green-600">Correct Answer:</span>
                            <span class="ml-2 text-green-700">${correctAnswerDisplay}</span>
                        </div>
                    ` : ''}
                    
                    ${q.hint ? `
                        <div class="text-sm mt-2">
                            <span class="font-bold text-purple-600">Hint:</span>
                            <span class="ml-2 text-purple-700">${q.hint}</span>
                        </div>
                    ` : ''}
                </div>
            </div>
        `;
    });
    
    reviewHTML += `
            </div>
            
            <div class="mt-4">
                <button onclick="renderResults()" class="btn-primary w-full py-3 rounded-xl">
                    <i class="fas fa-arrow-left mr-2"></i> Back to Results
                </button>
            </div>
        </div>
    `;
    
    headerTitle.textContent = "Quiz Review";
    quizApp.innerHTML = reviewHTML;
}

function retryQuiz() {
    const questions = quizData[currentSubject][currentLevel];
    questions.forEach(q => {
        delete q.userAnswer;
    });
    
    currentQuestionIndex = 0;
    score = 0;
    startTime = new Date();
    isAnswered = false;
    selectedOptions = [];
    
    startQuiz(currentSubject, currentLevel);
}

// ==== INITIALIZATION ====
document.addEventListener('DOMContentLoaded', function() {
    quizApp = document.getElementById('quizApp');
    headerTitle = document.getElementById('headerTitle');
    timerDisplay = document.getElementById('quizTimerDisplay');
    
    loadUsers();
    loadSettings();
    loadSubjects();
    loadQuizData();
    loadResources();
    loadLevelDisplayNames();
    initializeRolePermissions();
    
    if (!mockUsers.some(user => user.username === 'admin')) {
        mockUsers.push({
            username: "admin",
            password: adminPassword,
            name: "Admin User",
            email: "admin@awa.com",
            grade: "N/A",
            quizzesTaken: 0,
            lastAttempt: null,
            levelProgress: {},
            lastAttemptDetails: {},
            testHistory: [],
            role: "admin",
            canAuthorizeAdmins: true
        });
        saveUsers();
    }
    
    const mainAdminAuthKey = `admin_auth_admin@awa.com`;
    if (!localStorage.getItem(mainAdminAuthKey)) {
        localStorage.setItem(mainAdminAuthKey, 'authorized');
        localStorage.setItem(`${mainAdminAuthKey}_timestamp`, Date.now().toString());
        localStorage.setItem(`${mainAdminAuthKey}_is_admin1`, 'true');
    }
    
    updateUrlInputs();
    
    setTimeout(() => {
        updateSubjectSelects();
        
        mockUsers.forEach(user => {
            if (user.role === 'admin' && !checkAdminAuthorization(user.email)) {
                console.log(`Admin ${user.email} needs authorization`);
            }
        });
        
        updateHeaderButtons();
    }, 100);
    
    renderAuthScreen();
    
    window.addEventListener('message', function(event) {
        if (event.data && event.data.type === 'QUIZ_RESULT') {
            const { score: rScore, total: rTotal, subject: rSub, level: rLvl, userId } = event.data;
            
            let targetUser = currentUser;
            if (userId) {
                const foundUser = mockUsers.find(u => u.email === userId || u.username === userId);
                if (foundUser) targetUser = foundUser;
            }
            
            if (!targetUser) return;
            
            const finalSub = rSub || currentSubject || "External";
            const finalLvl = parseInt(rLvl) || currentLevel || 1;
            const score = parseInt(rScore) || 0;
            const total = parseInt(rTotal) || 1;

            const uIdx = mockUsers.findIndex(u => u.email === targetUser.email);
            if (uIdx !== -1) {
                const pct = Math.round((score / total) * 100);
                mockUsers[uIdx].quizzesTaken++;
                
                if (!mockUsers[uIdx].levelProgress[finalSub]) {
                    mockUsers[uIdx].levelProgress[finalSub] = {};
                }
                
                const currentProgress = mockUsers[uIdx].levelProgress[finalSub][finalLvl] || 0;
                mockUsers[uIdx].levelProgress[finalSub][finalLvl] = Math.max(currentProgress, pct);
                
                const newAttempt = {
                    subject: finalSub,
                    level: finalLvl,
                    score: pct,
                    date: new Date().toLocaleDateString(),
                    time: new Date().toLocaleTimeString(),
                    duration: "External HTML Quiz",
                    rawScore: `${score}/${total}`
                };
                
                mockUsers[uIdx].lastAttemptDetails = newAttempt;
                
                if (!mockUsers[uIdx].testHistory) mockUsers[uIdx].testHistory = [];
                mockUsers[uIdx].testHistory.unshift(newAttempt);
                
                saveUsers();
                
                alertMessage(`External Quiz Recorded: ${score}/${total} (${pct}%)`, "bg-gradient-to-r from-green-500 to-blue-500");
                
                if (currentSubject === finalSub) {
                    renderSubjectLevels(finalSub);
                }
                
                if (headerTitle.textContent.includes("Admin Dashboard")) {
                    renderAdminDashboard();
                }
            }
        }
    });
});

// ==== LEVEL DISPLAY NAMES FUNCTIONS ====
function loadLevelDisplayNames() {
    const saved = localStorage.getItem('sofanit_level_names');
    if (saved) {
        levelDisplayNames = JSON.parse(saved);
    } else {
        levelDisplayNames = {};
    }
}

function saveLevelDisplayNames() {
    localStorage.setItem('sofanit_level_names', JSON.stringify(levelDisplayNames));
}

function getLevelDisplayName(subject, level) {
    const key = `${subject}_${level}`;
    if (levelDisplayNames[key]) {
        return levelDisplayNames[key];
    }
    return `Lvl ${level}`;
}

function setLevelDisplayName(subject, level, name) {
    const key = `${subject}_${level}`;
    if (name && name.trim()) {
        levelDisplayNames[key] = name.trim();
    } else {
        delete levelDisplayNames[key];
    }
    saveLevelDisplayNames();
}

// ==== LEVEL RENAME FUNCTIONS ====
function openLevelRenameModal(subject, level) {
    levelRenameState.subject = subject;
    levelRenameState.oldLevel = level;
    
    const currentDisplayName = getLevelDisplayName(subject, level);
    const isChapterName = currentDisplayName.startsWith('Chapter ') || currentDisplayName.startsWith('Chap ');
    
    document.getElementById('newChapterName').value = isChapterName ? currentDisplayName : '';
    document.getElementById('newLevelNumber').value = level;
    document.getElementById('levelRenameModal').classList.add('show');
}

function closeLevelRenameModal() {
    document.getElementById('levelRenameModal').classList.remove('show');
    levelRenameState = {
        subject: '',
        oldLevel: 0,
        newLevel: 0
    };
}

function saveLevelRename() {
    const chapterName = document.getElementById('newChapterName').value.trim();
    const newLevel = parseInt(document.getElementById('newLevelNumber').value);
    
    const subject = levelRenameState.subject;
    const oldLevel = levelRenameState.oldLevel;
    
    if (chapterName) {
        setLevelDisplayName(subject, oldLevel, chapterName);
        saveLevelDisplayNames();
        
        closeLevelRenameModal();
        alertMessage(`Level ${oldLevel} renamed to "${chapterName}"`, "bg-gradient-to-r from-green-500 to-teal-500");
        
        renderSubjectLevels(subject);
        return;
    }
    
    if (!newLevel || newLevel < 1 || newLevel > 20) {
        alertMessage("Please enter a valid level number (1-20)", "bg-gradient-to-r from-red-500 to-pink-500");
        return;
    }
    
    if (newLevel === oldLevel) {
        closeLevelRenameModal();
        return;
    }
    
    if (quizData[subject] && quizData[subject][newLevel]) {
        if (!confirm(`Level ${newLevel} already exists. Overwrite it?`)) {
            return;
        }
    }
    
    if (quizData[subject] && quizData[subject][oldLevel]) {
        if (!quizData[subject][newLevel]) quizData[subject][newLevel] = [];
        quizData[subject][newLevel] = [...quizData[subject][oldLevel]];
        delete quizData[subject][oldLevel];
        
        const oldKey = `${subject}_${oldLevel}`;
        const newKey = `${subject}_${newLevel}`;
        if (levelDisplayNames[oldKey]) {
            levelDisplayNames[newKey] = levelDisplayNames[oldKey];
            delete levelDisplayNames[oldKey];
            saveLevelDisplayNames();
        }
    }
    
    if (resources[subject] && resources[subject][oldLevel]) {
        if (!resources[subject][newLevel]) resources[subject][newLevel] = { pdfs: [], videos: [], urls: [], audios: [] };
        resources[subject][newLevel] = { ...resources[subject][oldLevel] };
        delete resources[subject][oldLevel];
    }
    
    mockUsers.forEach(user => {
        if (user.levelProgress && user.levelProgress[subject]) {
            if (user.levelProgress[subject][oldLevel] !== undefined) {
                user.levelProgress[subject][newLevel] = user.levelProgress[subject][oldLevel];
                delete user.levelProgress[subject][oldLevel];
            }
        }
        
        if (user.testHistory) {
            user.testHistory.forEach(test => {
                if (test.subject === subject && test.level === oldLevel) {
                    test.level = newLevel;
                }
            });
        }
    });
    
    saveQuizData();
    saveResourcesMeta();
    saveUsers();
    
    closeLevelRenameModal();
    alertMessage(`Level ${oldLevel} renamed to Level ${newLevel}`, "bg-gradient-to-r from-green-500 to-teal-500");
    
    renderSubjectLevels(subject);
}

// Add Level Functionality
function openAddLevelModal(subject) {
    openAddModal(subject, 'level');
}

function closeAddLevelModal() {
    addLevelState.subject = '';
    addLevelState.isOpen = false;
    addLevelState.type = 'level';
    
    document.body.classList.remove('modal-open');
    document.getElementById('addLevelModal').classList.remove('show');
}

function saveNewLevel() {
    const levelNumber = parseInt(document.getElementById('newLevelNumberInput').value);
    const levelName = document.getElementById('newLevelNameInput').value.trim();
    const subject = addLevelState.subject;
    
    if (!levelNumber || levelNumber < 1 || levelNumber > 50) {
        alertMessage("Please enter a valid level number (1-50)", "bg-gradient-to-r from-red-500 to-pink-500");
        return;
    }
    
    if (!subject) {
        alertMessage("No subject selected", "bg-gradient-to-r from-red-500 to-pink-500");
        return;
    }
    
    if ((quizData[subject] && quizData[subject][levelNumber]) || 
        (resources[subject] && resources[subject][levelNumber])) {
        alertMessage(`Level ${levelNumber} already exists for ${subject}`, "bg-gradient-to-r from-yellow-500 to-amber-500");
        return;
    }
    
    if (!quizData[subject]) quizData[subject] = {};
    if (!resources[subject]) resources[subject] = {};
    
    quizData[subject][levelNumber] = [];
    resources[subject][levelNumber] = { pdfs: [], videos: [], urls: [], audios: [] };
    
    if (levelName) {
        setLevelDisplayName(subject, levelNumber, levelName);
    } else {
        setLevelDisplayName(subject, levelNumber, `Level ${levelNumber}`);
    }
    
    saveQuizData();
    saveResourcesMeta();
    saveLevelDisplayNames();
    
    closeAddLevelModal();
    alertMessage(`Level ${levelNumber} added to ${subject}`, "bg-gradient-to-r from-green-500 to-teal-500");
    
    renderSubjectLevels(subject);
}

// ==== URL INPUT MANAGEMENT ====
function updateUrlInputs() {
    const container = document.getElementById('urlInputsContainer');
    if (!container) return;
    
    container.innerHTML = '';
    urlInputs.forEach((url, index) => {
        const div = document.createElement('div');
        div.className = 'url-input-container';
        div.innerHTML = `
            <input type="text" placeholder="URL Name" class="url-name-input consistent-input" value="${url.name}" 
                   oninput="updateUrlInput(${index}, 'name', this.value)">
            <input type="url" placeholder="https://example.com" class="url-link-input consistent-input" value="${url.url}" 
                   oninput="updateUrlInput(${index}, 'url', this.value)">
            ${index === 0 ? 
                '<button type="button" class="add-more-url" onclick="addMoreUrlInput()">+</button>' : 
                '<button type="button" class="add-more-url" onclick="removeUrlInput(' + index + ')">-</button>'
            }
        `;
        container.appendChild(div);
    });
}

function updateUrlInput(index, field, value) {
    if (!urlInputs[index]) urlInputs[index] = { name: '', url: '' };
    urlInputs[index][field] = value;
}

function addMoreUrlInput() {
    urlInputs.push({ name: '', url: '' });
    updateUrlInputs();
}

function removeUrlInput(index) {
    if (urlInputs.length > 1) {
        urlInputs.splice(index, 1);
        updateUrlInputs();
    }
}

function resetUrlInputs() {
    urlInputs = [{ name: '', url: '' }];
    updateUrlInputs();
}

// ==== SUBJECT MANAGEMENT FUNCTIONS ====
const DEFAULT_SUBJECTS = ["Math", "English", "Science", "Computer", "Social", "Chemistry", "Chemical Engineering", "Social Science"];

function loadSubjects() {
    const savedSubjects = localStorage.getItem(SUBJECTS_KEY);
    if (savedSubjects) {
        subjects = JSON.parse(savedSubjects);
    } else {
        subjects = [...DEFAULT_SUBJECTS];
        saveSubjects();
    }
}

function saveSubjects() {
    localStorage.setItem(SUBJECTS_KEY, JSON.stringify(subjects));
}

function updateSubjectSelects() {
    const subjectSelects = [
        'uploadSubject',
        'manualSubject',
        'resourceSubject'
    ];
    
    subjectSelects.forEach(selectId => {
        const select = document.getElementById(selectId);
        if (select) {
            select.innerHTML = subjects.map(subject => 
                `<option value="${subject}">${subject}</option>`
            ).join('');
        }
    });
}

function addNewSubject() {
    const newSubjectInput = document.getElementById('newSubjectName');
    const subjectName = newSubjectInput.value.trim();
    
    if (!subjectName) {
        alertMessage("Please enter a subject name", "bg-gradient-to-r from-red-500 to-pink-500");
        return;
    }
    
    if (subjects.includes(subjectName)) {
        alertMessage(`Subject "${subjectName}" already exists`, "bg-gradient-to-r from-red-500 to-pink-500");
        return;
    }
    
    if (subjectName.length > 50) {
        alertMessage("Subject name too long (max 50 characters)", "bg-gradient-to-r from-red-500 to-pink-500");
        return;
    }
    
    subjects.push(subjectName);
    saveSubjects();
    
    if (!quizData[subjectName]) {
        quizData[subjectName] = {};
    }
    if (!resources[subjectName]) {
        resources[subjectName] = {};
    }
    
    saveQuizData();
    saveResourcesMeta();
    
    renderSubjectManagementList();
    updateSubjectSelects();
    
    newSubjectInput.value = '';
    
    alertMessage(`Subject "${subjectName}" added successfully`, "bg-gradient-to-r from-green-500 to-teal-500");
}

function renameSubject(oldName, newName) {
    if (oldName === newName) return;
    
    if (!subjects.includes(oldName)) {
        alertMessage("Subject not found", "bg-gradient-to-r from-red-500 to-pink-500");
        return;
    }
    
    if (subjects.includes(newName)) {
        alertMessage(`Subject "${newName}" already exists`, "bg-gradient-to-r from-red-500 to-pink-500");
        return;
    }
    
    pendingSubjectChanges.push({
        type: 'rename',
        oldName: oldName,
        newName: newName
    });
    
    const index = subjects.indexOf(oldName);
    subjects[index] = newName;
    renderSubjectManagementList();
    updateSubjectSelects();
    
    alertMessage(`Subject will be renamed from "${oldName}" to "${newName}"`, "bg-gradient-to-r from-blue-500 to-cyan-500");
}

function deleteSubject(subjectName) {
    if (!subjects.includes(subjectName)) {
        alertMessage("Subject not found", "bg-gradient-to-r from-red-500 to-pink-500");
        return;
    }
    
    let hasContent = false;
    let contentDetails = [];
    
    if (quizData[subjectName]) {
        const questionCount = Object.values(quizData[subjectName]).reduce((sum, level) => sum + (level.length || 0), 0);
        if (questionCount > 0) {
            hasContent = true;
            contentDetails.push(`${questionCount} questions`);
        }
    }
    
    if (resources[subjectName]) {
        let resourceCount = 0;
        Object.values(resources[subjectName]).forEach(level => {
            if (level.pdfs) resourceCount += level.pdfs.length;
            if (level.videos) resourceCount += level.videos.length;
            if (level.urls) resourceCount += level.urls.length;
            if (level.audios) resourceCount += level.audios.length;
        });
        if (resourceCount > 0) {
            hasContent = true;
            contentDetails.push(`${resourceCount} resources`);
        }
    }
    
    let userProgressCount = 0;
    mockUsers.forEach(user => {
        if (user.levelProgress && user.levelProgress[subjectName]) {
            userProgressCount += Object.keys(user.levelProgress[subjectName]).length;
        }
    });
    if (userProgressCount > 0) {
        hasContent = true;
        contentDetails.push(`${userProgressCount} user progress records`);
    }
    
    if (hasContent) {
        alertMessage(
            `Cannot delete "${subjectName}" because it contains: ${contentDetails.join(', ')}. ` +
            `Please remove all content first.`,
            "bg-gradient-to-r from-red-500 to-pink-500"
        );
        return;
    }
    
    if (!confirm(`Are you sure you want to delete subject "${subjectName}"?`)) {
        return;
    }
    
    pendingSubjectChanges.push({
        type: 'delete',
        subjectName: subjectName
    });
    
    subjects = subjects.filter(s => s !== subjectName);
    renderSubjectManagementList();
    updateSubjectSelects();
    
    alertMessage(`Subject "${subjectName}" will be deleted`, "bg-gradient-to-r from-blue-500 to-cyan-500");
}

function saveSubjectChanges() {
    pendingSubjectChanges.forEach(change => {
        if (change.type === 'rename') {
            if (quizData[change.oldName]) {
                quizData[change.newName] = quizData[change.oldName];
                delete quizData[change.oldName];
            }
            
            if (resources[change.oldName]) {
                resources[change.newName] = resources[change.oldName];
                delete resources[change.oldName];
            }
            
            mockUsers.forEach(user => {
                if (user.levelProgress && user.levelProgress[change.oldName]) {
                    user.levelProgress[change.newName] = user.levelProgress[change.oldName];
                    delete user.levelProgress[change.oldName];
                }
                
                if (user.testHistory) {
                    user.testHistory.forEach(test => {
                        if (test.subject === change.oldName) {
                            test.subject = change.newName;
                        }
                    });
                }
                
                if (user.lastAttemptDetails && user.lastAttemptDetails.subject === change.oldName) {
                    user.lastAttemptDetails.subject = change.newName;
                }
            });
            
        } else if (change.type === 'delete') {
            delete quizData[change.subjectName];
            delete resources[change.subjectName];
            
            mockUsers.forEach(user => {
                if (user.levelProgress) {
                    delete user.levelProgress[change.subjectName];
                }
                
                if (user.testHistory) {
                    user.testHistory = user.testHistory.filter(test => test.subject !== change.subjectName);
                }
                
                if (user.lastAttemptDetails && user.lastAttemptDetails.subject === change.subjectName) {
                    user.lastAttemptDetails = {};
                }
            });
        }
    });
    
    pendingSubjectChanges = [];
    
    saveSubjects();
    saveQuizData();
    saveResourcesMeta();
    saveUsers();
    
    if (currentSubject && !subjects.includes(currentSubject)) {
        currentSubject = subjects[0] || '';
        renderWelcomeScreen();
    }
    
    closeSubjectManagement();
    alertMessage("Subject changes saved successfully", "bg-gradient-to-r from-green-500 to-teal-500");
}

function openSubjectManagement() {
    document.body.classList.add('modal-open');
    document.getElementById('subjectManagementModal').classList.add('show');
    renderSubjectManagementList();
}

function closeSubjectManagement() {
    document.body.classList.remove('modal-open');
    document.getElementById('subjectManagementModal').classList.remove('show');
    pendingSubjectChanges = [];
    loadSubjects();
    updateSubjectSelects();
}

// Subject management list
function renderSubjectManagementList() {
    const container = document.getElementById('subjectListContainer');
    if (!container) return;
    
    if (subjects.length === 0) {
        container.innerHTML = `
            <div class="text-center py-6 text-blue-600">
                <i class="fas fa-book-open text-3xl mb-3"></i>
                <p class="font-semibold">No subjects yet. Add your first subject above!</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = subjects.map((subject, index) => {
        let hasContent = false;
        if (quizData[subject]) {
            const questionCount = Object.values(quizData[subject]).reduce((sum, level) => sum + (level.length || 0), 0);
            if (questionCount > 0) hasContent = true;
        }
        
        return `
            <div class="subject-management-item">
                <div class="flex-grow">
                    <div class="font-bold text-gray-800 text-lg">${subject.replace(/ â€“ level| - level/i, '')}</div>
                    <div class="text-sm ${hasContent ? 'text-amber-600' : 'text-green-600'}">
                        ${hasContent ? '<i class="fas fa-exclamation-circle mr-2"></i> Contains content' : '<i class="fas fa-check-circle mr-2"></i> Ready'}
                    </div>
                </div>
                <div class="relative">
                    <button class="subject-three-dots" onclick="openSubjectManagementMenu(event, '${subject}', this)">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

// Function to handle subject management menu
function openSubjectManagementMenu(event, subject, buttonElement) {
    event.stopPropagation();
    event.preventDefault();
    
    const existingMenus = document.querySelectorAll('.subject-dropdown-menu');
    existingMenus.forEach(menu => menu.remove());
    
    let hasContent = false;
    if (quizData[subject]) {
        const questionCount = Object.values(quizData[subject]).reduce((sum, level) => sum + (level.length || 0), 0);
        if (questionCount > 0) hasContent = true;
    }
    
    const menu = document.createElement('div');
    menu.className = 'subject-dropdown-menu';
    menu.innerHTML = `
        <button class="edit-btn" onclick="editSubjectName('${subject}')">
            <i class="fas fa-edit"></i> Edit
        </button>
        <button class="delete-btn" onclick="deleteSubject('${subject}')" ${hasContent ? 'style="opacity: 0.5; cursor: not-allowed;"' : ''}>
            <i class="fas fa-trash"></i> Delete
        </button>
    `;
    
    const buttonRect = buttonElement.getBoundingClientRect();
    
    const menuHeight = 80;
    const spaceBelow = window.innerHeight - buttonRect.bottom;
    const spaceAbove = buttonRect.top;
    
    let top, left;
    
    if (spaceBelow < menuHeight && spaceAbove >= menuHeight) {
        top = buttonRect.top + window.scrollY - menuHeight;
    } else {
        top = buttonRect.bottom + window.scrollY;
    }
    
    left = buttonRect.right + window.scrollX - 120;
    
    if (left < 10) left = 10;
    
    menu.style.position = 'fixed';
    menu.style.top = `${top}px`;
    menu.style.left = `${left}px`;
    menu.style.zIndex = '10000';
    
    document.body.appendChild(menu);
    
    setTimeout(() => {
        const closeHandler = function(e) {
            if (!menu.contains(e.target) && !buttonElement.contains(e.target)) {
                menu.remove();
                document.removeEventListener('click', closeHandler);
            }
        };
        document.addEventListener('click', closeHandler);
    }, 10);
}

function editSubjectName(oldName) {
    const newName = prompt(`Rename "${oldName.replace(/ â€“ level| - level/i, '')}" to:`, oldName.replace(/ â€“ level| - level/i, ''));
    if (newName && newName.trim() && newName !== oldName) {
        renameSubject(oldName, newName.trim());
    }
}

function openSubjectManagementFromUploader() {
    closeBulkUploader();
    setTimeout(() => openSubjectManagement(), 100);
}

function openSubjectManagementFromManual() {
    closeManualExamCreator();
    setTimeout(() => openSubjectManagement(), 100);
}

function openSubjectManagementFromResource() {
    closeResourceUploader();
    setTimeout(() => openSubjectManagement(), 100);
}

// ==== SUBJECT PAGE FUNCTIONS ====
function renderSubjectPage() {
    subjectPageOpen = true;
    headerTitle.textContent = "Subjects";
    
    if (currentUser.role === 'admin') {
        document.getElementById('adminFooter').style.display = 'block';
    } else {
        document.getElementById('adminFooter').style.display = 'none';
    }
    
    quizApp.innerHTML = `
        <div class="flex flex-col h-full">
            <button onclick="goBack()" class="back-button">
                <i class="fas fa-arrow-left"></i>
            </button>
            
            <div class="text-center mb-6">
                <div class="inline-block p-4 rounded-2xl bg-gradient-to-r from-blue-100 to-cyan-100 mb-4">
                    <i class="fas fa-book text-4xl text-blue-500"></i>
                </div>
                <h3 class="text-xl font-bold text-blue-700 mb-1">Subjects</h3>
                <p class="text-sm text-blue-500">Manage your study subjects</p>
            </div>
            
            <div class="subjects-scroll-container">
                ${subjects.length === 0 ? `
                    <div class="text-center py-10 text-blue-400">
                        <i class="fas fa-book-open text-4xl mb-3"></i>
                        <p class="font-semibold">No subjects yet!</p>
                        <p class="text-xs mt-1">Add subjects to get started</p>
                    </div>
                ` : `
                    <div class="space-y-3">
                        ${subjects.map(subject => {
                            const questionCount = quizData[subject] ? 
                                Object.values(quizData[subject]).reduce((sum, level) => sum + (level.length || 0), 0) : 0;
                            
                            let resourceCount = 0;
                            if (resources[subject]) {
                                Object.values(resources[subject]).forEach(level => {
                                    if (level.pdfs) resourceCount += level.pdfs.length;
                                    if (level.videos) resourceCount += level.videos.length;
                                    if (level.urls) resourceCount += level.urls.length;
                                    if (level.audios) resourceCount += level.audios.length;
                                });
                            }
                            
                            return `
                                <div class="subject-page-item">
                                    <div class="flex-grow">
                                        <div class="font-bold text-gray-800 text-lg flex items-center">
                                            <i class="fas fa-book mr-3 text-blue-500"></i>
                                            ${subject.replace(/ â€“ level| - level/i, '')}
                                        </div>
                                        <div class="flex space-x-4 mt-2 text-xs">
                                            <span class="text-green-600 font-semibold"><i class="fas fa-question-circle mr-1"></i> ${questionCount} Qs</span>
                                            <span class="text-purple-600 font-semibold"><i class="fas fa-file-alt mr-1"></i> ${resourceCount} Res</span>
                                        </div>
                                    </div>
                                    <div class="relative">
                                        <button class="subject-three-dots" onclick="openSubjectDropdown('${subject}', this)">
                                            <i class="fas fa-ellipsis-v"></i>
                                        </button>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                `}
            </div>
            
            ${currentUser.role === 'admin' || currentUser.role === 'teacher' ? `
            <div class="mt-6">
                <button onclick="openSubjectManagement()" class="w-full btn-success py-3 rounded-xl text-sm flex items-center justify-center">
                    <i class="fas fa-plus mr-2"></i> Manage Subjects
                </button>
            </div>
            ` : ''}
        </div>
    `;
}

function editSubjectOnPage(subjectName) {
    const newName = prompt(`Rename "${subjectName.replace(/ â€“ level| - level/i, '')}" to:`, subjectName.replace(/ â€“ level| - level/i, ''));
    if (newName && newName.trim() && newName !== subjectName) {
        renameSubject(subjectName, newName.trim());
        renderSubjectPage();
    }
}

function deleteSubjectOnPage(subjectName) {
    deleteSubject(subjectName);
    setTimeout(() => {
        renderSubjectPage();
    }, 100);
}

function goBack() {
    if (subjectPageOpen) {
        subjectPageOpen = false;
        renderWelcomeScreen();
    } else {
        renderWelcomeScreen();
    }
}

// ==== DATA MANAGEMENT ====
function loadUsers() {
    const users = localStorage.getItem(STORAGE_KEY);
    if (users) mockUsers = JSON.parse(users);
    mockUsers.forEach(u => {
        if(!u.testHistory) u.testHistory = [];
    });
}

function saveUsers() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(mockUsers));
}

function loadSettings() {
    const settings = localStorage.getItem(SETTINGS_KEY);
    if (settings) quizSettings = JSON.parse(settings);
    if(!quizSettings.minutesPerQuestion || quizSettings.minutesPerQuestion <= 0) quizSettings.minutesPerQuestion = 1;
}

function saveSettings() {
    localStorage.setItem(SETTINGS_KEY, JSON.stringify(quizSettings));
}

function loadQuizData() {
    const data = localStorage.getItem(QUIZ_DATA_KEY);
    if (data) {
        const savedData = JSON.parse(data);
        
        if (savedData.Math && savedData.Reading && savedData.Science && savedData["Computer Science"]) {
            quizData = savedData;
        } else {
            quizData = savedData;
            
            subjects.forEach(subject => {
                if (!quizData[subject]) {
                    quizData[subject] = {};
                }
            });
        }
    } else {
        subjects.forEach(subject => {
            quizData[subject] = {};
        });
    }
}

function saveQuizData() {
    localStorage.setItem(QUIZ_DATA_KEY, JSON.stringify(quizData));
}

function loadResources() {
    const res = localStorage.getItem(RESOURCES_KEY);
    if (res) {
        resources = JSON.parse(res);
        
        subjects.forEach(subject => {
            if (!resources[subject]) {
                resources[subject] = {};
            }
            
            for (let level = 1; level <= 10; level++) {
                if (resources[subject][level]) {
                    if (!resources[subject][level].pdfs) resources[subject][level].pdfs = [];
                    if (!resources[subject][level].videos) resources[subject][level].videos = [];
                    if (!resources[subject][level].urls) resources[subject][level].urls = [];
                    if (!resources[subject][level].audios) resources[subject][level].audios = [];
                }
            }
        });
    } else {
        subjects.forEach(subject => {
            resources[subject] = {};
        });
    }
}

function saveResourcesMeta() {
    localStorage.setItem(RESOURCES_KEY, JSON.stringify(resources));
}

// ==== RESOURCE HANDLING ====
async function openResource(id) {
    alertMessage("Opening resource...", "bg-gradient-to-r from-blue-500 to-cyan-500");
    try {
        const fileBlob = await getFileFromDB(id);
        if (fileBlob) {
            const url = URL.createObjectURL(fileBlob);
            window.open(url, '_blank');
        } else {
            alertMessage("Resource not found locally.", "bg-gradient-to-r from-red-500 to-pink-500");
        }
    } catch (e) {
        console.error(e);
        alertMessage("Error opening resource.", "bg-gradient-to-r from-red-500 to-pink-500");
    }
}

// ==== URL RESOURCE HANDLING ====
function openUrlResource(url) {
    if (url && url.startsWith('http')) {
        window.open(url, '_blank');
    } else {
        alertMessage("Invalid URL", "bg-gradient-to-r from-red-500 to-pink-500");
    }
}

// ==== GLOBAL RESOURCE MENU SYSTEM ====
function openGlobalMenu(btn, event, subject, level, type, index, resourceId = null) {
    if (event) event.stopPropagation();
    
    const menu = document.getElementById('globalResourceMenu');
    
    if (type === 'exam') {
        menu.innerHTML = `
            <button onclick="editExam('${subject}', ${level})">
                <i class="fas fa-edit"></i> Edit Exam
            </button>
            <button onclick="deleteExam('${subject}', ${level})" class="text-red-500 font-bold">
                <i class="fas fa-trash"></i> Delete Exam
            </button>
            <button onclick="renameExam('${subject}', ${level})" class="text-blue-500 font-bold">
                <i class="fas fa-tag"></i> Rename Exam
            </button>
        `;
    } else if (type === 'urls') {
        menu.innerHTML = `
            <button onclick="renameUrlResource('${subject}', ${level}, ${index}, event)">
                <i class="fas fa-edit"></i> Rename
            </button>
            <button onclick="deleteUrlResource('${subject}', ${level}, ${index}, event)" class="text-red-500 font-bold">
                <i class="fas fa-trash"></i> Delete
            </button>
        `;
    } else {
        menu.innerHTML = `
            <button onclick="renameResource('${subject}', '${level}', '${type}', ${index}, event)">
                <i class="fas fa-edit"></i> Rename
            </button>
            <button onclick="deleteResource('${subject}', '${level}', '${type}', ${index}, event)" class="text-red-500 font-bold">
                <i class="fas fa-trash"></i> Delete
            </button>
        `;
    }
    
    const rect = btn.getBoundingClientRect();
    menu.style.display = 'block';
    menu.style.top = `${rect.bottom + 5}px`;
    
    const menuWidth = 150;
    let leftPos = rect.right - menuWidth;
    if (leftPos < 5) leftPos = 5; 
    
    menu.style.left = `${leftPos}px`;
    
    setTimeout(() => {
        const closeMenuHandler = function(e) {
            if (!menu.contains(e.target) && e.target !== btn) {
                menu.style.display = 'none';
                document.removeEventListener('click', closeMenuHandler);
            }
        };
        document.addEventListener('click', closeMenuHandler);
    }, 10);
}

// ==== LEVEL MANAGEMENT FUNCTIONS ====
function openLevelMenu(btn, event, subject, level) {
    if (event) event.stopPropagation();
    
    const menu = document.getElementById('globalResourceMenu');
    menu.innerHTML = `
        <button onclick="openLevelRenameModal('${subject}', ${level})">
            <i class="fas fa-edit"></i> Rename Level
        </button>
        <button onclick="editLevelSettings('${subject}', ${level})">
            <i class="fas fa-cog"></i> Edit Level Content
        </button>
        <button onclick="deleteLevel('${subject}', ${level})" class="text-red-500 font-bold">
            <i class="fas fa-trash"></i> Delete Level
        </button>
        <button onclick="openAddModal('${subject}', 'level')" class="text-green-500 font-bold">
            <i class="fas fa-plus"></i> Add New Level
        </button>
    `;
    
    const rect = btn.getBoundingClientRect();
    menu.style.display = 'block';
    menu.style.top = `${rect.bottom + 5}px`;
    menu.style.left = `${rect.left}px`;
    
    setTimeout(() => {
        const closeMenuHandler = function(e) {
            if (!menu.contains(e.target) && e.target !== btn) {
                menu.style.display = 'none';
                document.removeEventListener('click', closeMenuHandler);
            }
        };
        document.addEventListener('click', closeMenuHandler);
    }, 10);
}

function editLevelSettings(subject, level) {
    document.getElementById('globalResourceMenu').style.display = 'none';
    openManualExamCreatorForSubject(subject, level, true);
}

function deleteLevel(subject, level) {
    document.getElementById('globalResourceMenu').style.display = 'none';
    
    if(confirm(`Are you sure you want to delete Level ${level} for ${subject.replace(/ â€“ level| - level/i, '')}? This will remove all questions and resources for this level.`)) {
        if (quizData[subject] && quizData[subject][level]) {
            delete quizData[subject][level];
            saveQuizData();
        }
        
        if (resources[subject] && resources[subject][level]) {
            delete resources[subject][level];
            saveResourcesMeta();
        }
        
        const key = `${subject}_${level}`;
        if (levelDisplayNames[key]) {
            delete levelDisplayNames[key];
            saveLevelDisplayNames();
        }
        
        mockUsers.forEach(user => {
            if (user.levelProgress && user.levelProgress[subject]) {
                delete user.levelProgress[subject][level];
            }
            
            if (user.testHistory) {
                user.testHistory = user.testHistory.filter(test => 
                    !(test.subject === subject && test.level === level)
                );
            }
        });
        saveUsers();
        
        alertMessage(`Level ${level} deleted for ${subject.replace(/ â€“ level| - level/i, '')}`, "bg-gradient-to-r from-green-500 to-teal-500");
        renderSubjectLevels(subject);
    }
}

function renameResource(subject, level, type, index, event) {
    if (event) event.stopPropagation();
    document.getElementById('globalResourceMenu').style.display = 'none';
    
    const item = resources[subject][level][type][index];
    const newName = prompt("Rename resource to:", item.name);
    if(newName && newName.trim() !== "") {
        resources[subject][level][type][index].name = newName.trim();
        saveResourcesMeta();
        renderSubjectLevels(subject);
    }
}

function renameUrlResource(subject, level, index, event) {
    if (event) event.stopPropagation();
    document.getElementById('globalResourceMenu').style.display = 'none';
    
    const item = resources[subject][level].urls[index];
    const newName = prompt("Rename URL to:", item.name);
    if(newName && newName.trim() !== "") {
        resources[subject][level].urls[index].name = newName.trim();
        saveResourcesMeta();
        renderSubjectLevels(subject);
    }
}

function deleteResource(subject, level, type, index, event) {
    if (event) event.stopPropagation();
    document.getElementById('globalResourceMenu').style.display = 'none';
    
    if(confirm("Are you sure you want to delete this file?")) {
        resources[subject][level][type].splice(index, 1);
        saveResourcesMeta();
        renderSubjectLevels(subject);
    }
}

function deleteUrlResource(subject, level, index, event) {
    if (event) event.stopPropagation();
    document.getElementById('globalResourceMenu').style.display = 'none';
    
    if(confirm("Are you sure you want to delete this URL?")) {
        resources[subject][level].urls.splice(index, 1);
        saveResourcesMeta();
        renderSubjectLevels(subject);
    }
}

// ==== EXAM EDIT/DELETE/RENAME FUNCTIONS ====
function editExam(subject, level) {
    document.getElementById('globalResourceMenu').style.display = 'none';
    
    const questions = quizData[subject]?.[level] || [];
    if (questions.length === 0) {
        alertMessage("No questions found for this exam", "bg-gradient-to-r from-yellow-500 to-amber-500");
        return;
    }
    
    openManualExamCreatorForSubject(subject, level, true);
}

function renameExam(subject, level) {
    document.getElementById('globalResourceMenu').style.display = 'none';
    
    const currentName = getLevelDisplayName(subject, level);
    const newName = prompt(`Rename exam for Level ${level} to:`, currentName);
    
    if (newName && newName.trim() !== "") {
        setLevelDisplayName(subject, level, newName.trim());
        saveLevelDisplayNames();
        alertMessage(`Exam renamed to "${newName.trim()}"`, "bg-gradient-to-r from-green-500 to-teal-500");
        renderSubjectLevels(subject);
    }
}

function deleteExam(subject, level) {
    document.getElementById('globalResourceMenu').style.display = 'none';
    
    if(confirm("Are you sure you want to delete this entire exam? This will remove all questions for this level.")) {
        if (quizData[subject] && quizData[subject][level]) {
            delete quizData[subject][level];
            saveQuizData();
            alertMessage(`Exam deleted for ${subject.replace(/ â€“ level| - level/i, '')} Level ${level}`, "bg-gradient-to-r from-green-500 to-teal-500");
            renderSubjectLevels(subject);
        }
    }
}

// ==== QUIZ FUNCTIONS ====
function renderStudentProfile() {
    if (!isAuthenticated) return renderAuthScreen();
    headerTitle.textContent = "My Profile";
    
    document.getElementById('adminFooter').style.display = 'none';
    
    const history = currentUser.testHistory || [];
    const avgScore = history.length > 0 ? Math.round(history.reduce((a, b) => a + (b.score || 0), 0) / history.length) : 0;

    quizApp.innerHTML = `
        <div class="flex flex-col h-full">
            <button onclick="goBack()" class="back-button">
                <i class="fas fa-arrow-left"></i>
            </button>
            
            <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-2xl p-5 shadow-sm mb-6 flex items-center space-x-5">
                <div class="bg-gradient-to-r from-blue-500 to-cyan-500 rounded-full p-4 text-white text-3xl">
                    <i class="fas fa-user"></i>
                </div>
                <div>
                    <h2 class="text-xl font-bold text-gray-800">${currentUser.name}</h2>
                    <p class="text-sm text-blue-600">${currentUser.email}</p>
                    <div class="flex space-x-3 mt-3">
                        <span class="text-xs font-bold bg-gradient-to-r from-green-100 to-green-200 text-green-700 px-3 py-1.5 rounded-full">Tests: ${history.length}</span>
                        <span class="text-xs font-bold bg-gradient-to-r from-yellow-100 to-yellow-200 text-yellow-700 px-3 py-1.5 rounded-full">Avg: ${avgScore}%</span>
                    </div>
                </div>
            </div>

            <h3 class="text-sm font-bold text-blue-700 mb-3 uppercase tracking-wide flex items-center">
                <i class="fas fa-history mr-2"></i> Test History
            </h3>
            
            <div class="student-profile-scroll-container">
                ${history.length === 0 ? 
                    `<div class="text-center text-blue-400 py-10 flex flex-col items-center">
                        <i class="fas fa-clipboard-check text-4xl mb-3"></i>
                        <p class="font-semibold">No tests taken yet!</p>
                        <p class="text-xs mt-1">Start learning to see your progress here</p>
                    </div>` : 
                    history.map(test => `
                    <div class="bg-gradient-to-r ${test.score >= 80 ? 'from-green-50 to-emerald-50 border-l-4 border-green-500' : (test.score >= 50 ? 'from-yellow-50 to-amber-50 border-l-4 border-yellow-500' : 'from-red-50 to-pink-50 border-l-4 border-red-500')} rounded-r-xl shadow-sm p-4 hover:shadow-md transition-all duration-300 mb-3">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="font-bold text-gray-800 text-sm">${test.subject.replace(/ â€“ level| - level/i, '')} <span class="text-xs font-normal text-blue-600">Level ${test.level}</span></p>
                                <p class="text-xs text-blue-500 mt-1.5"><i class="far fa-clock mr-1"></i> ${test.date} ${test.time ? `at ${test.time}` : ''}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-bold ${test.score >= 80 ? 'text-green-600' : (test.score >= 50 ? 'text-yellow-600' : 'text-red-600')}">${test.score}%</p>
                                <p class="text-xs text-gray-500">${test.scoreRaw || ''}</p>
                            </div>
                        </div>
                        <div class="mt-3 pt-3 border-t border-blue-100 flex justify-between text-xs text-blue-500">
                            <span><i class="fas fa-stopwatch text-blue-400 mr-1"></i> Time: ${test.duration || 'N/A'}</span>
                            <span><i class="fas fa-chart-line text-green-400 mr-1"></i> Performance</span>
                        </div>
                    </div>
                `).join('')}
            </div>
        </div>
    `;
}

// Updated renderSubjectLevels with Add Level button and scrollbars
function renderSubjectLevels(subject) {
    if (!isAuthenticated) return renderAuthScreen();
    currentSubject = subject;
    headerTitle.textContent = subject.replace(/ â€“ level| - level/i, '');
    
    document.getElementById('adminFooter').style.display = 'none';
    
    const subRes = resources[subject] || {};
    const getResList = (level, type) => {
        if(subRes[level] && subRes[level][type] && Array.isArray(subRes[level][type])) {
            return subRes[level][type];
        }
        return [];
    };
    
    const existingLevels = new Set();
    
    if (quizData[subject]) {
        Object.keys(quizData[subject]).forEach(level => {
            if (quizData[subject][level] && quizData[subject][level].length > 0) {
                existingLevels.add(parseInt(level));
            }
        });
    }
    
    if (resources[subject]) {
        Object.keys(resources[subject]).forEach(level => {
            const levelRes = resources[subject][level];
            if (levelRes && (levelRes.pdfs?.length > 0 || levelRes.videos?.length > 0 || levelRes.urls?.length > 0 || levelRes.audios?.length > 0)) {
                existingLevels.add(parseInt(level));
            }
        });
    }
    
    const levels = Array.from(existingLevels).sort((a, b) => a - b);
    const displayLevels = levels.length > 0 ? levels : [1, 2, 3, 4, 5, 6, 7, 8, 9, 10];
    
    quizApp.innerHTML = `
        <div class="flex flex-col h-full">
            <button onclick="goBack()" class="back-button">
                <i class="fas fa-arrow-left"></i>
            </button>
            
            ${currentUser.role === 'admin' || currentUser.role === 'teacher' || currentUser.role === 'parent' ? `
            <div class="flex space-x-2 mb-4 justify-end">
                ${currentUser.role === 'admin' || currentUser.role === 'teacher' || currentUser.role === 'parent' ? `
                <button onclick="openManualExamCreatorForSubject('${subject}')" class="btn-success px-3 py-1.5 text-xs font-bold rounded-lg"><i class="fas fa-plus mr-1"></i> Questions</button>
                ` : ''}
                ${currentUser.role === 'admin' || currentUser.role === 'teacher' || currentUser.role === 'parent' ? `
                <button onclick="openResourceUploaderForSubject('${subject}')" class="btn-purple px-3 py-1.5 text-xs font-bold rounded-lg"><i class="fas fa-upload mr-1"></i> Resources</button>
                ` : ''}
                ${currentUser.role === 'admin' ? `
                <button onclick="openAddModal('${subject}', 'level')" class="btn-primary px-3 py-1.5 text-xs font-bold rounded-lg"><i class="fas fa-plus-circle mr-1"></i> Add</button>
                ` : ''}
            </div>` : ''}

            <div class="levels-scrollable-container">
                <div class="grid grid-cols-5 gap-3">
                    ${displayLevels.map(level => {
                        const count = quizData[subject]?.[level]?.length || 0;
                        const progress = currentUser.levelProgress?.[subject]?.[level] || 0;
                        const pdfs = getResList(level, 'pdfs');
                        const videos = getResList(level, 'videos');
                        const audios = getResList(level, 'audios');
                        const urls = subRes[level]?.urls || [];
                        const hasRes = pdfs.length > 0 || videos.length > 0 || urls.length > 0 || audios.length > 0;
                        const hasExam = count > 0;
                        const displayName = getLevelDisplayName(subject, level);
                        
                        let colorClass = count === 0 ? "bg-gradient-to-b from-gray-100 to-gray-200 text-gray-600 border-gray-400 gray-hover" : 
                                        (progress >= 80 ? "bg-gradient-to-b from-green-100 to-emerald-200 text-green-800 border-green-300 hover:from-green-200 hover:to-emerald-300" : 
                                        "bg-gradient-to-b from-gray-100 to-gray-200 text-gray-700 border-gray-300 gray-hover");
                        
                        return `
                        <div class="relative">
                            <button onclick="startQuiz('${subject}', ${level})" class="level-btn ${colorClass} w-full">
                                <span class="text-sm font-bold">${displayName}</span>
                                <span class="text-xs opacity-80 mt-1">${count} Qs</span>
                                ${hasRes ? '<i class="fas fa-paperclip absolute top-2 right-2 text-xs text-purple-500"></i>' : ''}
                                ${hasExam ? '<i class="fas fa-file-alt absolute top-2 left-2 text-xs text-green-500"></i>' : ''}
                                ${progress > 0 ? `<div class="absolute bottom-8 w-4/5 h-1.5 bg-gray-300 rounded-full overflow-hidden"><div class="bg-gradient-to-r from-gray-500 to-gray-700 h-full rounded-full" style="width: ${Math.min(progress, 100)}%"></div></div>` : ''}
                            </button>
                            ${currentUser.role === 'admin' ? `
                            <div class="level-three-dots" onclick="openLevelMenu(this, event, '${subject}', ${level})">â‹®</div>
                            ` : ''}
                        </div>`;
                    }).join('')}
                    
                    ${currentUser.role === 'admin' ? `
                    <div class="relative">
                        <button onclick="openAddModal('${subject}', 'level')" class="level-btn bg-gradient-to-b from-blue-100 to-blue-200 text-blue-800 border-blue-300 hover:from-blue-200 hover:to-blue-300 w-full">
                            <span class="text-sm font-bold">+ Add</span>
                            <span class="text-xs opacity-80 mt-1">Level/Subject/Chapter</span>
                            <i class="fas fa-plus-circle absolute top-2 right-2 text-xs text-blue-500"></i>
                        </button>
                    </div>` : ''}
                </div>
            </div>
            
            <div class="learning-materials mt-4">
                <h4 class="font-bold text-blue-800 text-sm uppercase mb-2">Learning Materials</h4>
                <div class="accordion-scroll-container">
                    ${displayLevels.map(level => {
                        const pdfs = getResList(level, 'pdfs');
                        const videos = getResList(level, 'videos');
                        const audios = getResList(level, 'audios');
                        const urls = subRes[level]?.urls || [];
                        const examQuestions = quizData[subject]?.[level] || [];
                        const hasExam = examQuestions.length > 0;
                        const hasResources = pdfs.length > 0 || videos.length > 0 || urls.length > 0 || audios.length > 0;
                        
                        if(!hasExam && !hasResources) return '';
                        
                        const displayName = getLevelDisplayName(subject, level);
                        
                        return `
                        <div class="accordion-item">
                            <div class="accordion-header" onclick="toggleAccordion(${level})">
                                <span>${displayName}</span>
                                <i id="accordion-icon-${level}" class="fas fa-chevron-down"></i>
                            </div>
                            <div id="accordion-content-${level}" class="accordion-content">
                                <div class="accordion-resources-container">
                                    ${hasExam ? `
                                    <div class="accordion-resource-item w-full flex items-center hover:bg-gradient-to-r hover:from-green-50 hover:to-emerald-50 text-green-700 relative">
                                        <button type="button" onclick="startQuiz('${subject}', ${level})" class="flex-grow text-left flex items-center truncate">
                                            <i class="fas fa-question-circle mr-3 w-5 text-green-500"></i> 
                                            <span class="truncate w-36 font-semibold">Exam (${examQuestions.length} questions)</span>
                                        </button>
                                        ${currentUser.role === 'admin' ? `
                                        <button type="button" onclick="event.stopPropagation(); openGlobalMenu(this, event, '${subject}', ${level}, 'exam', 0)" class="text-red-500 hover:text-red-700 px-2 font-bold text-lg hover:bg-red-50 p-1 rounded">â‹®</button>
                                        ` : ''}
                                    </div>
                                    ` : ''}
                                    
                                    ${pdfs.map((pdf, idx) => `
                                        <div class="accordion-resource-item w-full flex items-center hover:bg-gradient-to-r hover:from-red-50 hover:to-pink-50 text-red-700 relative">
                                            <button type="button" onclick="openResourceWithTracking('${pdf.id}', '${pdf.name}', '${subject}', ${level})" class="flex-grow text-left flex items-center truncate">
                                                <i class="fas ${pdf.name.endsWith('.html') || pdf.name.endsWith('.htm') ? 'fa-globe' : (pdf.name.endsWith('.zip') ? 'fa-file-archive' : 'fa-file-pdf')} mr-3 w-5 text-red-500"></i> 
                                                <span class="truncate w-36">${pdf.name}</span>
                                            </button>
                                            ${currentUser.role === 'admin' ? `
                                            <button type="button" onclick="event.stopPropagation(); openGlobalMenu(this, event, '${subject}', ${level}, 'pdfs', ${idx})" class="text-red-500 hover:text-red-700 px-2 font-bold text-lg hover:bg-red-50 p-1 rounded">â‹®</button>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                    
                                    ${videos.map((vid, idx) => `
                                        <div class="accordion-resource-item w-full flex items-center hover:bg-gradient-to-r hover:from-blue-50 hover:to-cyan-50 text-blue-700 relative">
                                            <button type="button" onclick="openResourceWithTracking('${vid.id}', '${vid.name}', '${subject}', ${level})" class="flex-grow text-left flex items-center truncate">
                                                <i class="fas fa-video mr-3 w-5 text-blue-500"></i> 
                                                <span class="truncate w-36">${vid.name}</span>
                                            </button>
                                            ${currentUser.role === 'admin' ? `
                                            <button type="button" onclick="event.stopPropagation(); openGlobalMenu(this, event, '${subject}', ${level}, 'videos', ${idx})" class="text-red-500 hover:text-red-700 px-2 font-bold text-lg hover:bg-red-50 p-1 rounded">â‹®</button>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                    
                                    ${audios.map((audio, idx) => `
                                        <div class="audio-resource-item w-full flex items-center hover:bg-gradient-to-r hover:from-purple-50 hover:to-pink-50 text-purple-700 relative">
                                            <button type="button" onclick="playAudioResource('${audio.id}', '${audio.name}', '${subject}', ${level})" class="flex-grow text-left flex items-center truncate">
                                                <i class="fas fa-music mr-3 w-5 text-purple-500"></i> 
                                                <span class="truncate w-36">${audio.name}</span>
                                            </button>
                                            ${currentUser.role === 'admin' ? `
                                            <button type="button" onclick="event.stopPropagation(); openGlobalMenu(this, event, '${subject}', ${level}, 'audios', ${idx})" class="text-red-500 hover:text-red-700 px-2 font-bold text-lg hover:bg-red-50 p-1 rounded">â‹®</button>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                    
                                    ${urls.map((urlItem, idx) => `
                                        <div class="accordion-resource-item w-full flex items-center hover:bg-gradient-to-r hover:from-green-50 hover:to-emerald-50 text-green-700 relative">
                                            <button type="button" onclick="openUrlResource('${urlItem.url}')" class="flex-grow text-left flex items-center truncate">
                                                <i class="fas fa-link mr-3 w-5 text-green-500"></i> 
                                                <span class="truncate w-36">${urlItem.name}</span>
                                            </button>
                                            ${currentUser.role === 'admin' ? `
                                            <button type="button" onclick="event.stopPropagation(); openGlobalMenu(this, event, '${subject}', ${level}, 'urls', ${idx})" class="text-red-500 hover:text-red-700 px-2 font-bold text-lg hover:bg-red-50 p-1 rounded">â‹®</button>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
            </div>
        </div>
    `;
    
    setTimeout(() => {
        document.querySelectorAll('.accordion-content').forEach(content => {
            content.classList.remove('expanded');
        });
        document.querySelectorAll('.accordion-header i').forEach(icon => {
            icon.className = 'fas fa-chevron-down';
        });
    }, 50);
}

// ========== FIX 1: Ensure quiz preview scroll functionality ==========
function ensureQuizPreviewScroll() {
    const quizApp = document.getElementById('quizApp');
    if (!quizApp) return;
    
    const isQuizMode = quizApp.innerHTML.includes('quiz-option') || 
                       quizApp.innerHTML.includes('selectAnswer') ||
                       quizApp.innerHTML.includes('submitEssayAnswer');
    
    if (isQuizMode) {
        const optionsContainer = quizApp.querySelector('.space-y-3');
        if (optionsContainer && !optionsContainer.classList.contains('quiz-preview-container')) {
            optionsContainer.classList.add('quiz-preview-container');
        }
        
        if (window.innerWidth <= 767) {
            quizApp.style.overflowY = 'auto';
            quizApp.style.maxHeight = 'calc(100% - 100px)';
        } else {
            quizApp.style.overflowY = 'hidden';
            quizApp.style.maxHeight = 'none';
        }
    }
}

// ==== QUIZ FUNCTIONS ====
function startQuiz(subject, level) {
    const questions = quizData[subject]?.[level] || [];
    if (questions.length === 0) {
        alertMessage("No questions yet!", "bg-gradient-to-r from-yellow-500 to-amber-500");
        return;
    }
    currentSubject = subject;
    currentLevel = level;
    currentQuestionIndex = 0;
    score = 0;
    startTime = new Date(); 
    startTimer();
    renderQuestion();
}

function renderQuestion() {
    isAnswered = false; 
    selectedOptions = [];
    const questions = quizData[currentSubject][currentLevel];
    
    if (currentQuestionIndex >= questions.length) {
        renderResults();
        return;
    }
    
    const q = questions[currentQuestionIndex];
    const isMulti = q.type === 'checkbox' || (q.type === 'checkbox' && q.options.length > 2);
    const isEssay = q.type === 'essay';
    
    headerTitle.textContent = `${currentSubject.replace(/ â€“ level| - level/i, '')} ${getLevelDisplayName(currentSubject, currentLevel)} | ${currentQuestionIndex + 1}/${questions.length}`;
    
    let optionsHtml = '';
    let buttonHtml = '';

    if (isEssay) {
        optionsHtml = `
            <div class="space-y-3">
                <textarea id="essayAnswer" rows="6" class="w-full p-4 border-2 border-blue-300 rounded-xl text-sm bg-white" placeholder="Type your answer here..."></textarea>
            </div>`;
        const isLastQuestion = currentQuestionIndex === questions.length - 1;
        buttonHtml = `
            <div class="flex justify-between border-t border-blue-200 pt-5 mt-3">
                <button onclick="prevQuestion()" ${currentQuestionIndex === 0 ? 'disabled class="opacity-50 cursor-not-allowed text-gray-400 font-bold text-sm"' : 'class="text-blue-600 hover:text-blue-800 font-bold text-sm border border-blue-300 hover:border-blue-500 px-4 py-2 rounded-lg transition-all duration-300"'}><i class="fas fa-arrow-left mr-1"></i> Prev</button>
                <button id="essaySubmitBtn" onclick="submitEssayAnswer()" class="${isLastQuestion ? 'btn-success' : 'btn-primary'} px-6 py-3 rounded-xl text-sm shadow-lg">${isLastQuestion ? 'Submit Exam' : 'Submit Answer'}</button>
            </div>`;
    } else if (isMulti) {
        optionsHtml = `
            <div class="space-y-3 quiz-preview-container">
                ${q.options.map((opt, i) => `
                    <label class="flex items-center w-full p-4 bg-gradient-to-r from-blue-50 to-cyan-50 text-blue-800 font-medium rounded-xl border-2 border-blue-200 hover:border-blue-300 hover:from-blue-100 hover:to-cyan-100 transition-all duration-300 text-sm cursor-pointer" id="opt-label-${i}">
                        <input type="checkbox" value="${opt}" onchange="toggleMultiSelect(this)" class="mr-4 h-5 w-5 text-blue-600">
                        ${opt}
                    </label>
                `).join('')}
            </div>`;
        const isLastQuestion = currentQuestionIndex === questions.length - 1;
        buttonHtml = `
            <div class="flex justify-between border-t border-blue-200 pt-5 mt-3">
                <button onclick="prevQuestion()" ${currentQuestionIndex === 0 ? 'disabled class="opacity-50 cursor-not-allowed text-gray-400 font-bold text-sm"' : 'class="text-blue-600 hover:text-blue-800 font-bold text-sm border border-blue-300 hover:border-blue-500 px-4 py-2 rounded-lg transition-all duration-300"'}><i class="fas fa-arrow-left mr-1"></i> Prev</button>
                <button id="actionBtn" onclick="submitMultiAnswer()" class="${isLastQuestion ? 'btn-success' : 'btn-primary'} px-6 py-3 rounded-xl text-sm shadow-lg">${isLastQuestion ? 'Submit Exam' : 'Check Answer'}</button>
            </div>`;
    } else {
        optionsHtml = `
            <div class="space-y-3 quiz-preview-container">
                ${q.options.map((opt, i) => `
                    <button onclick="selectAnswer('${opt}', this)" class="quiz-option">
                        <span class="group-hover:pl-2 transition-all duration-200">${opt}</span>
                    </button>
                `).join('')}
            </div>`;
        const isLastQuestion = currentQuestionIndex === questions.length - 1;
        buttonHtml = `
            <div class="flex justify-between border-t border-blue-200 pt-5 mt-3">
                <button onclick="prevQuestion()" ${currentQuestionIndex === 0 ? 'disabled class="opacity-50 cursor-not-allowed text-gray-400 font-bold text-sm"' : 'class="text-blue-600 hover:text-blue-800 font-bold text-sm border border-blue-300 hover:border-blue-500 px-4 py-2 rounded-lg transition-all duration-300"'}><i class="fas fa-arrow-left mr-1"></i> Prev</button>
                <button id="nextBtn" onclick="nextQuestion()" class="text-blue-600 hover:text-blue-800 font-bold text-sm border border-blue-300 hover:border-blue-500 px-4 py-2 rounded-lg transition-all duration-300 hidden">${isLastQuestion ? 'Submit Exam' : 'Next'} <i class="fas fa-arrow-right ml-1"></i></button>
            </div>`;
    }

    quizApp.innerHTML = `
        <div class="flex flex-col h-full justify-between">
            <button onclick="goBackFromQuiz()" class="back-button">
                <i class="fas fa-arrow-left"></i>
            </button>
            
            <div>
                <div class="bg-gradient-to-r from-blue-50 to-cyan-50 p-5 rounded-2xl shadow-sm border border-blue-200 mb-6">
                    <p class="text-xl font-bold text-gray-800 text-center">${q.question}</p>
                </div>
                ${optionsHtml}
            </div>
            ${buttonHtml}
        </div>`;
    
    setTimeout(ensureQuizPreviewScroll, 100);
}

function goBackFromQuiz() {
    if (confirm("Exit quiz? Your progress will not be saved.")) {
        stopTimer();
        renderSubjectLevels(currentSubject);
    }
}

function toggleMultiSelect(checkbox) {
    if (checkbox.checked) selectedOptions.push(checkbox.value);
    else selectedOptions = selectedOptions.filter(o => o !== checkbox.value);
}

function selectAnswer(ans, btn) {
    if (isAnswered) return; 
    isAnswered = true;
    
    const q = quizData[currentSubject][currentLevel][currentQuestionIndex];
    
    const isCorrect = isAnswerCorrect(ans, q);
    
    q.userAnswer = ans;
    
    if (isCorrect) {
        score++;
        btn.classList.remove('bg-gradient-to-r', 'from-blue-50', 'to-cyan-50', 'text-blue-800', 'border-blue-200', 'hover:border-blue-300', 'hover:from-blue-100', 'hover:to-cyan-100');
        btn.classList.add('bg-gradient-to-r', 'from-green-100', 'to-emerald-200', 'text-green-800', 'border-green-400');
    } else {
        btn.classList.remove('bg-gradient-to-r', 'from-blue-50', 'to-cyan-50', 'text-blue-800', 'border-blue-200', 'hover:border-blue-300', 'hover:from-blue-100', 'hover:to-cyan-100');
        btn.classList.add('bg-gradient-to-r', 'from-red-100', 'to-pink-200', 'text-red-800', 'border-red-400');
        
        setTimeout(() => {
            const correctAnswer = String(q.answer).trim();
            let correctOptionText = correctAnswer;
            
            if (/^\d+$/.test(correctAnswer)) {
                const index = parseInt(correctAnswer) - 1;
                if (index >= 0 && index < q.options.length) {
                    correctOptionText = q.options[index];
                }
            }
            
            const allButtons = document.querySelectorAll('button[onclick^="selectAnswer"]');
            allButtons.forEach(button => {
                const buttonText = button.textContent.trim();
                if (normalizeText(buttonText) === normalizeText(correctOptionText)) {
                    button.classList.remove('bg-gradient-to-r', 'from-blue-50', 'to-cyan-50', 'text-blue-800', 'border-blue-200', 'hover:border-blue-300', 'hover:from-blue-100', 'hover:to-cyan-100');
                    button.classList.remove('bg-gradient-to-r', 'from-red-100', 'to-pink-200', 'text-red-800', 'border-red-400');
                    button.classList.add('bg-gradient-to-r', 'from-green-100', 'to-emerald-200', 'text-green-800', 'border-green-400');
                }
            });
        }, 500);
    }
    
    const nextBtn = document.getElementById('nextBtn');
    if(nextBtn) {
        nextBtn.classList.remove('hidden');
        nextBtn.classList.add('flex', 'items-center');
    }
}

function submitMultiAnswer() {
    const btn = document.getElementById('actionBtn');
    const isLastQuestion = currentQuestionIndex === quizData[currentSubject][currentLevel].length - 1;
    
    if (isAnswered) {
        if (isLastQuestion) {
            btn.textContent = "Submitting...";
            setTimeout(() => {
                renderResults();
            }, 50);
        } else {
            nextQuestion();
        }
        return;
    }

    isAnswered = true;
    const q = quizData[currentSubject][currentLevel][currentQuestionIndex];
    
    let correctAnswerArray = [];
    const correctAnswer = String(q.answer).trim();
    
    if (correctAnswer.includes(',') || correctAnswer.includes('|')) {
        const separator = correctAnswer.includes(',') ? ',' : '|';
        correctAnswerArray = correctAnswer.split(separator).map(a => normalizeText(a.trim()));
    } else {
        correctAnswerArray = [normalizeText(correctAnswer)];
    }
    
    if (/^\d+([,|]\d+)*$/.test(correctAnswer)) {
        const indices = correctAnswer.split(/[,|]/).map(num => parseInt(num.trim()) - 1);
        correctAnswerArray = indices
            .filter(idx => idx >= 0 && idx < q.options.length)
            .map(idx => normalizeText(q.options[idx]));
    }
    
    const userAnswers = selectedOptions.map(a => normalizeText(a));
    
    const sortedCorrect = [...correctAnswerArray].sort();
    const sortedUser = [...userAnswers].sort();
    
    let isCorrect = sortedCorrect.length === sortedUser.length && 
                    sortedCorrect.every((val, idx) => val === sortedUser[idx]);
    
    if (isCorrect) {
        score++;
        alertMessage("Correct!", "bg-gradient-to-r from-green-500 to-teal-500");
    } else {
        alertMessage("Incorrect", "bg-gradient-to-r from-red-500 to-pink-500");
    }

    q.userAnswer = selectedOptions.join(', ');

    q.options.forEach((opt, idx) => {
        const label = document.getElementById(`opt-label-${idx}`);
        const checkbox = label.querySelector('input[type="checkbox"]');
        const isSelected = checkbox.checked;
        const isOptionCorrect = sortedCorrect.includes(normalizeText(opt));

        label.classList.remove('bg-gradient-to-r', 'from-blue-50', 'to-cyan-50', 'text-blue-800', 'border-blue-200', 'hover:border-blue-300', 'hover:from-blue-100', 'hover:to-cyan-100');

        if (isSelected && isOptionCorrect) {
            label.classList.add('bg-gradient-to-r', 'from-green-100', 'to-emerald-200', 'text-green-800', 'border-green-400');
        } else if (isSelected && !isOptionCorrect) {
            label.classList.add('bg-gradient-to-r', 'from-red-100', 'to-pink-200', 'text-red-800', 'border-red-400');
        } else if (!isSelected && isOptionCorrect) {
            label.classList.add('bg-gradient-to-r', 'from-green-100', 'to-emerald-200', 'text-green-800', 'border-green-400');
        } else {
            label.classList.add('bg-gradient-to-r', 'from-gray-100', 'to-gray-200', 'text-gray-500', 'border-gray-300');
        }
    });

    if (isLastQuestion) {
        btn.textContent = "Submitting...";
        btn.disabled = true;
        setTimeout(() => {
            renderResults();
        }, 100);
    } else {
        btn.textContent = "Next â†’";
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-success');
        btn.onclick = nextQuestion;
    }
}

function prevQuestion() {
    if (currentQuestionIndex > 0) {
        currentQuestionIndex--;
        renderQuestion();
    }
}

let timeLeft, timerInterval;
function startTimer() {
    if (!quizSettings.timerEnabled) {
        timerDisplay.classList.add('hidden');
        return;
    }
    stopTimer();
    const qCount = quizData[currentSubject][currentLevel].length;
    timeLeft = qCount * (quizSettings.minutesPerQuestion * 60); 
    timerDisplay.classList.remove('hidden');
    updateTimerUI();
    timerInterval = setInterval(() => {
        timeLeft--;
        updateTimerUI();
        if (timeLeft <= 0) {
            stopTimer();
            alertMessage("Time's up!", "bg-gradient-to-r from-red-500 to-pink-500");
            renderResults();
        }
    }, 1000);
}

function stopTimer() {
    if (timerInterval) clearInterval(timerInterval);
    timerDisplay.classList.add('hidden');
}

function updateTimerUI() {
    const m = Math.floor(timeLeft / 60);
    const s = timeLeft % 60;
    timerDisplay.textContent = `${m}:${s < 10 ? '0' : ''}${s}`;
    timerDisplay.className = `text-base font-bold px-4 py-2 rounded-full shadow-lg text-white mb-2 ${timeLeft < 30 ? 'bg-gradient-to-r from-red-500 to-pink-500' : (timeLeft < 60 ? 'bg-gradient-to-r from-yellow-500 to-amber-500' : 'bg-gradient-to-r from-green-500 to-teal-500')}`;
}

// ==== ADMIN FUNCTIONS ====
function openModal(id) {
    document.body.classList.add('modal-open');
    document.getElementById('passwordModal').classList.add('show');
}

function closeModal() {
    document.body.classList.remove('modal-open');
    document.getElementById('passwordModal').classList.remove('show');
}

function checkAdminPassword() {
    if (document.getElementById('passwordInput').value === adminPassword) {
        closeModal();
        renderAdminDashboard();
    } else {
        document.getElementById('passwordError').classList.remove('hidden');
    }
}

// FIX 6: Updated renderAdminDashboard to show delete button for all users including admin
function renderAdminDashboard() {
    headerTitle.textContent = "Admin Dashboard";
    
    document.getElementById('adminFooter').style.display = 'block';
    
    const allUsers = mockUsers; 
    const qTotal = Object.values(quizData).reduce((acc, sub) => acc + Object.values(sub).reduce((a, l) => a + l.length, 0), 0);
    
    updateSubjectSelects();
    
    quizApp.innerHTML = `
        <div class="flex flex-col h-full relative">
            <button onclick="goBack()" class="back-button">
                <i class="fas fa-arrow-left"></i>
            </button>
            
            <div class="admin-dashboard-scroll-container">
                <div class="mt-10 grid grid-cols-2 gap-4 mb-6">
                    <div onclick="scrollToUserList()" class="dashboard-stat-card p-4 rounded-xl text-center hover:shadow-lg">
                        <div class="text-3xl font-bold text-blue-700">${mockUsers.length}</div>
                        <div class="text-xs text-blue-600 uppercase font-bold mt-1">Total Users</div>
                    </div>
                    <div onclick="showQuestionSummary()" class="dashboard-stat-card p-4 rounded-xl text-center hover:shadow-lg">
                        <div class="text-3xl font-bold text-green-700">${qTotal}</div>
                        <div class="text-xs text-green-600 uppercase font-bold mt-1">Total Questions</div>
                    </div>
                    <div onclick="scrollToUserList()" class="dashboard-stat-card p-4 rounded-xl text-center hover:shadow-lg">
                        <div class="text-3xl font-bold text-purple-700">${mockUsers.filter(u=>u.role!=='admin').length}</div>
                        <div class="text-xs text-purple-600 uppercase font-bold mt-1">Students</div>
                    </div>
                    <div onclick="showSubjectSummary()" class="dashboard-stat-card p-4 rounded-xl text-center hover:shadow-lg">
                        <div class="text-3xl font-bold text-indigo-700">${subjects.length}</div>
                        <div class="text-xs text-indigo-600 uppercase font-bold mt-1">Subjects</div>
                    </div>
                </div>

                <div class="mb-6">
                    <div class="admin-tools-grid">
                        <button type="button" onclick="openBulkUploader()" class="admin-tool-btn btn-primary">
                            <i class="fas fa-file-csv mb-1 text-lg"></i> Bulk
                        </button>
                        <button type="button" onclick="openManualExamCreator()" class="admin-tool-btn btn-success">
                            <i class="fas fa-edit mb-1 text-lg"></i> Manual
                        </button>
                        <button type="button" onclick="openResourceUploader()" class="admin-tool-btn btn-purple">
                            <i class="fas fa-photo-video mb-1 text-lg"></i> Res
                        </button>
                        <button type="button" onclick="openUrlManager()" class="admin-tool-btn url-button">
                            <i class="fas fa-link mb-1 text-lg"></i> URLs
                        </button>
                        <button type="button" onclick="openSubjectManagement()" class="admin-tool-btn bg-gradient-to-r from-indigo-500 to-purple-500 text-white">
                            <i class="fas fa-book mb-1 text-lg"></i> Subjects
                            </button>
                    </div>
                </div>
                
                <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border border-blue-200 rounded-2xl p-4 mb-6">
                    <div class="flex justify-between items-center">
                        <span class="text-sm font-bold text-blue-700">Timer (Mins/Q)</span>
                        <div class="flex items-center space-x-3">
                            <input type="number" id="adminTimerInput" value="${quizSettings.minutesPerQuestion}" class="w-16 p-2 border border-blue-300 rounded-lg text-center text-sm bg-white">
                            <button onclick="updateTimerSettings()" class="btn-primary px-3 py-2 rounded-lg text-xs">Set</button>
                            <button onclick="toggleTimer()" class="px-3 py-2 rounded-lg text-xs font-bold text-white ${quizSettings.timerEnabled ? 'bg-gradient-to-r from-green-500 to-teal-500' : 'bg-gradient-to-r from-red-500 to-pink-500'}">${quizSettings.timerEnabled ? 'ON' : 'OFF'}</button>
                        </div>
                    </div>
                </div>

                <div class="bg-gradient-to-r from-red-50 to-orange-50 border border-red-200 rounded-2xl p-4 mb-6">
                    <h4 class="text-sm font-bold text-red-700 mb-2 flex items-center"><i class="fas fa-exclamation-triangle mr-2"></i> Danger Zone</h4>
                    <p class="text-xs text-red-600 mb-3">Reset all quiz progress and scores</p>
                    <button type="button" onclick="openResetQuizModal()" class="btn-danger w-full py-3 rounded-xl text-sm flex items-center justify-center">
                        <i class="fas fa-trash-alt mr-2"></i> Reset All Quiz Progress
                    </button>
                </div>

                <div class="flex-grow flex flex-col min-h-0 bg-gradient-to-b from-white to-blue-50 border border-blue-200 rounded-2xl overflow-hidden shadow-sm" id="userManagementSection">
                    <div class="bg-gradient-to-r from-blue-100 to-cyan-100 p-3 border-b border-blue-200 flex justify-between items-center">
                        <h4 class="font-bold text-blue-700 text-sm">User Management (${allUsers.length})</h4>
                        <span class="text-xs text-blue-600">Scroll to view all</span>
                    </div>
                    <div class="overflow-y-auto p-3 space-y-3 flex-grow">
                        ${allUsers.length === 0 ? '<p class="text-center text-blue-400 text-sm py-6">No users yet.</p>' : ''}
                        ${allUsers.map(u => {
                            const last = u.lastAttemptDetails;
                            const lastAttemptStr = last && last.date ? 
                                `Last: ${last.subject.replace(/ â€“ level| - level/i, '')} Lvl ${last.level} (${last.score}%) - ${last.duration} on ${last.date}` : 
                                'No attempts yet';
                            const isAdmin = u.role === 'admin';
                                
                            return `
                            <div class="flex justify-between items-center p-3 bg-gradient-to-r from-white to-blue-50 border border-blue-100 rounded-xl shadow-sm hover:shadow-md hover:from-blue-50 hover:to-cyan-50 transition-all duration-300">
                                <div>
                                    <div class="font-bold text-gray-800 text-sm">${u.name} ${isAdmin ? '<span class="text-red-500 text-xs bg-red-50 px-2 py-0.5 rounded-full">Admin</span>' : ''}</div>
                                    <div class="text-xs text-blue-600">${u.email}</div>
                                    <div class="text-xs text-blue-500 mt-1 font-semibold">${lastAttemptStr}</div>
                                </div>
                                <!-- FIX 6: Show delete button for ALL users including admin -->
                                <button type="button" onclick="deleteUser('${u.email}')" class="btn-danger p-2 rounded-lg text-xs"><i class="fas fa-trash"></i></button>
                            </div>
                        `;}).join('')}
                    </div>
                </div>
            </div>
        </div>
    `;
}

// FIX 6: Updated deleteUser function to handle admin deletion
function deleteUser(email) {
    // Prevent deleting yourself if you're logged in
    if (currentUser && currentUser.email === email) {
        alertMessage("You cannot delete your own account while logged in.", "bg-gradient-to-r from-red-500 to-pink-500");
        return;
    }
    
    // Check if it's the main admin
    if (email === "admin@awa.com") {
        if (!confirm("Warning: This is the main admin account. Are you absolutely sure you want to delete this account? This action cannot be undone.")) {
            return;
        }
    } else {
        if (!confirm(`Are you sure you want to delete user ${email}?`)) {
            return;
        }
    }
    
    mockUsers = mockUsers.filter(u => u.email !== email);
    saveUsers();
    
    // If the deleted user was the current user and they somehow got deleted, log them out
    if (currentUser && currentUser.email === email) {
        isAuthenticated = false;
        currentUser = null;
        renderAuthScreen();
    }
    
    renderAdminDashboard();
}

function showSubjectSummary() {
    let summaryHtml = '<div class="text-left space-y-3">';
    subjects.forEach(subject => {
        let questionCount = 0;
        let resourceCount = 0;
        
        if (quizData[subject]) {
            questionCount = Object.values(quizData[subject]).reduce((sum, level) => sum + (level.length || 0), 0);
        }
        
        if (resources[subject]) {
            Object.values(resources[subject]).forEach(level => {
                if (level.pdfs) resourceCount += level.pdfs.length;
                if (level.videos) resourceCount += level.videos.length;
                if (level.urls) resourceCount += level.urls.length;
                if (level.audios) resourceCount += level.audios.length;
            });
        }
        
        summaryHtml += `
            <div class="flex justify-between border-b border-blue-200 pb-2 text-sm">
                <span class="font-semibold text-blue-700">${subject.replace(/ â€“ level| - level/i, '')}</span>
                <div class="flex space-x-4">
                    <span class="font-bold text-green-600">${questionCount} Qs</span>
                    <span class="text-blue-500">${resourceCount} Res</span>
                </div>
            </div>`;
    });
    summaryHtml += '</div>';
    
    const modal = document.createElement('div');
    modal.className = 'fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-[1100] backdrop-filter backdrop-blur-sm';
    modal.innerHTML = `
        <div class="bg-gradient-to-b from-white to-blue-50 p-6 rounded-2xl w-96 shadow-2xl border border-blue-200">
            <h3 class="text-lg font-bold text-blue-800 mb-4 text-center">Subject Summary</h3>
            ${summaryHtml}
            <button type="button" onclick="this.parentElement.parentElement.remove()" class="mt-6 w-full btn-primary py-3 rounded-xl text-sm font-bold">Close</button>
        </div>`;
    document.body.appendChild(modal);
}

function openResetQuizModal() {
    document.body.classList.add('modal-open');
    document.getElementById('resetQuizModal').classList.add('show');
}

function closeResetModal() {
    document.body.classList.remove('modal-open');
    document.getElementById('resetQuizModal').classList.remove('show');
}

function confirmResetQuizProgress() {
    const password = document.getElementById('resetPasswordInput').value;
    
    if (password !== adminPassword) {
        document.getElementById('resetPasswordError').classList.remove('hidden');
        return;
    }
    
    mockUsers.forEach(user => {
        user.quizzesTaken = 0;
        user.lastAttempt = null;
        user.levelProgress = {};
        user.lastAttemptDetails = {};
        user.testHistory = [];
        
        if (user.role === 'admin') {
            user.role = 'admin';
        }
    });
    
    saveUsers();
    closeResetModal();
    
    if (currentUser) {
        const userIndex = mockUsers.findIndex(u => u.email === currentUser.email);
        if (userIndex !== -1) {
            currentUser = mockUsers[userIndex];
        }
    }
    
    alertMessage("All quiz progress has been reset!", "bg-gradient-to-r from-green-500 to-teal-500");
    renderAdminDashboard();
}

function scrollToUserList() {
    const el = document.getElementById('userManagementSection');
    if (el) el.scrollIntoView({ behavior: 'smooth' });
}

function showQuestionSummary() {
    let summaryHtml = '<div class="text-left space-y-3">';
    subjects.forEach(s => {
        let count = 0;
        if (quizData[s]) {
            for(let l in quizData[s]) count += quizData[s][l].length;
        }
        summaryHtml += `<div class="flex justify-between border-b border-blue-200 pb-2 text-sm"><span class="font-semibold text-blue-700">${s.replace(/ â€“ level| - level/i, '')}</span><span class="font-bold text-green-600">${count}</span></div>`;
    });
    summaryHtml += '</div>';
    
    const modal = document.createElement('div');
    modal.className = 'fixed top-0 left-0 w-full h-full bg-black bg-opacity-50 flex items-center justify-center z-[1100] backdrop-filter backdrop-blur-sm';
    modal.innerHTML = `
        <div class="bg-gradient-to-b from-white to-blue-50 p-6 rounded-2xl w-80 shadow-2xl border border-blue-200">
            <h3 class="text-lg font-bold text-blue-800 mb-4 text-center">Question Breakdown</h3>
            ${summaryHtml}
            <button type="button" onclick="this.parentElement.parentElement.remove()" class="mt-6 w-full btn-primary py-3 rounded-xl text-sm font-bold">Close</button>
        </div>`;
    document.body.appendChild(modal);
}

function updateTimerSettings() {
    const val = parseFloat(document.getElementById('adminTimerInput').value);
    if (val > 0) {
        quizSettings.minutesPerQuestion = val;
        saveSettings();
        alertMessage(`Timer set to ${val} min/question`, "bg-gradient-to-r from-green-500 to-teal-500");
    }
}

function toggleTimer() {
    quizSettings.timerEnabled = !quizSettings.timerEnabled;
    saveSettings();
    renderAdminDashboard();
}

function scrollToUserList() {
    const el = document.getElementById('userManagementSection');
    if (el) el.scrollIntoView({ behavior: 'smooth' });
}

// ========== FIX 2: Manual Exam Creator with "x" button to remove extra options ==========
let isEditMode = false;
let editSubject = '';
let editLevel = 0;

function openManualExamCreator(editMode = false, subject = '', level = 0) { 
    document.body.classList.add('modal-open');
    document.getElementById('manualExamModal').classList.add('show'); 
    document.getElementById('manualQuestionsContainer').innerHTML = '';
    
    isEditMode = editMode;
    editSubject = subject;
    editLevel = level;
    
    if (!editMode) {
        manualQuestions = [];
        addManualQuestion(); 
    } else {
        renderManualQuestions();
    }
}

function addManualQuestion() {
    const id = manualQuestions.length;
    manualQuestions.push({ type: 'radio', question: '', options: ['', ''], answer: '', hint: '' });
    
    renderManualQuestions();
}

function renderManualQuestions() {
    const container = document.getElementById('manualQuestionsContainer');
    container.innerHTML = '';
    
    manualQuestions.forEach((q, id) => {
        const d = document.createElement('div');
        d.className = 'question-item bg-gradient-to-r from-blue-50 to-cyan-50 p-4 rounded-xl border border-blue-200 mb-3';
        d.id = `q-item-${id}`;
        d.innerHTML = renderManualQuestionInputs(id);
        container.appendChild(d);
    });
}

// FIXED: Added remove button (x) for options beyond the first two
function renderManualQuestionInputs(id) {
    const q = manualQuestions[id];
    let optionsHtml = '';

    if (q.type === 'radio' || q.type === 'checkbox') {
        optionsHtml = `
            <div class="space-y-3 mb-3">
                ${q.options.map((opt, i) => `
                    <div class="flex items-center space-x-2 relative w-full">
                        <div class="flex items-center space-x-3 w-full">
                            ${q.type === 'radio' ? 
                                `<input type="radio" name="correct-${id}" onclick="updateManualAnswer(${id}, '${i}')" ${q.answer === opt ? 'checked' : ''} class="h-5 w-5 text-blue-600 flex-shrink-0">` : 
                                `<input type="checkbox" onchange="updateManualMultiAnswer(${id}, this, ${i})" ${q.answer && q.answer.includes(opt) ? 'checked' : ''} class="h-5 w-5 text-blue-600 flex-shrink-0">`
                            }
                            <input type="text" placeholder="Option ${String.fromCharCode(65 + i)}" value="${opt}" 
                                   class="flex-grow border border-blue-300 p-3 rounded-lg text-sm consistent-input" 
                                   oninput="updateManualOption(${id}, ${i}, this.value)">
                        </div>
                        <!-- FIX: Add remove button (x) for options beyond the first two -->
                        ${i > 1 ? `<button type="button" class="option-remove-btn" onclick="removeManualOption(${id}, ${i})" title="Remove option">x</button>` : ''}
                    </div>
                `).join('')}
            </div>
            <button type="button" onclick="addManualOptionInput(${id})" class="text-sm text-blue-600 font-bold hover:text-blue-800 mb-4"><i class="fas fa-plus-circle mr-1"></i> Add Option</button>
        `;
    } else if (q.type === 'truefalse') {
        optionsHtml = `
            <div class="space-y-3 mb-3">
                <div class="flex items-center space-x-3">
                    <input type="radio" name="correct-${id}" onclick="updateManualAnswer(${id}, '0')" ${q.answer === 'True' ? 'checked' : ''} class="h-5 w-5 text-blue-600">
                    <span class="text-sm font-semibold text-blue-700">True</span>
                </div>
                <div class="flex items-center space-x-3">
                    <input type="radio" name="correct-${id}" onclick="updateManualAnswer(${id}, '1')" ${q.answer === 'False' ? 'checked' : ''} class="h-5 w-5 text-blue-600">
                    <span class="text-sm font-semibold text-blue-700">False</span>
                </div>
            </div>
        `;
    } else if (q.type === 'essay') {
        optionsHtml = `<div class="text-sm text-blue-500 italic mb-3 p-3 bg-blue-50 rounded-lg border border-blue-200">Essay: No options required.</div>`;
    }

    return `
        <div class="flex justify-between mb-3">
            <span class="font-bold text-sm text-blue-700">Question ${id+1}</span>
            <select class="text-sm border border-blue-300 p-2 rounded-lg consistent-input" onchange="changeManualType(${id}, this.value)">
                <option value="radio" ${q.type==='radio'?'selected':''}>Single Choice</option>
                <option value="checkbox" ${q.type==='checkbox'?'selected':''}>Multiple Choice</option>
                <option value="truefalse" ${q.type==='truefalse'?'selected':''}>True/False</option>
                <option value="essay" ${q.type==='essay'?'selected':''}>Essay</option>
            </select>
        </div>
        <input placeholder="Question Text" value="${q.question}" class="w-full border border-blue-300 p-3 rounded-lg mb-3 text-sm font-bold consistent-input" oninput="manualQuestions[${id}].question = this.value">
        <div class="mb-3">
            <label class="text-sm font-bold text-blue-700 mb-2 block">Options & Correct Answer:</label>
            ${optionsHtml}
        </div>
        <input id="q-ans-${id}" placeholder="Correct Answer (Auto-filled)" value="${q.answer}" class="w-full border border-green-300 p-2.5 rounded-lg mb-2 text-sm bg-gradient-to-r from-green-50 to-emerald-50 consistent-input" readonly>
    `;
}

// NEW: Function to remove an option from a question
function removeManualOption(questionId, optionIndex) {
    if (manualQuestions[questionId].options.length <= 2) {
        alertMessage("At least two options are required", "bg-gradient-to-r from-red-500 to-pink-500");
        return;
    }

    const removedOption = manualQuestions[questionId].options[optionIndex];
    manualQuestions[questionId].options.splice(optionIndex, 1);

    const question = manualQuestions[questionId];
    if (question.type === 'radio') {
        if (question.answer === removedOption) {
            question.answer = question.options.length > 0 ? question.options[0] : '';
        }
    } else if (question.type === 'checkbox') {
        let answers = question.answer ? question.answer.split(',') : [];
        answers = answers.filter(ans => ans.trim() !== removedOption.trim());
        question.answer = answers.join(',');
    }

    renderManualQuestions();
}

function changeManualType(id, newType) {
    manualQuestions[id].type = newType;
    manualQuestions[id].answer = ''; 
    
    if (newType === 'truefalse') {
        manualQuestions[id].options = ['True', 'False'];
    } else if (newType === 'essay') {
        manualQuestions[id].options = [];
    } else if (manualQuestions[id].options.length < 2) {
        manualQuestions[id].options = ['', ''];
    }
    
    document.getElementById(`q-item-${id}`).innerHTML = renderManualQuestionInputs(id);
}

function addManualOptionInput(id) {
    manualQuestions[id].options.push('');
    document.getElementById(`q-item-${id}`).innerHTML = renderManualQuestionInputs(id);
}

function updateManualOption(id, idx, val) {
    manualQuestions[id].options[idx] = val;
}

function updateManualAnswer(id, idx) {
    const val = manualQuestions[id].options[idx];
    manualQuestions[id].answer = val;
    document.getElementById(`q-ans-${id}`).value = val;
}

function updateManualMultiAnswer(id, checkbox, idx) {
    const val = manualQuestions[id].options[idx];
    let curr = manualQuestions[id].answer ? manualQuestions[id].answer.split(',') : [];
    if(checkbox.checked) curr.push(val);
    else curr = curr.filter(v => v !== val);
    manualQuestions[id].answer = curr.join(',');
    document.getElementById(`q-ans-${id}`).value = manualQuestions[id].answer;
}

function saveManualExam() {
    const sub = document.getElementById('manualSubject').value;
    const lev = parseInt(document.getElementById('manualLevel').value); 
    
    const valid = manualQuestions.every((q, index) => {
        if (!q.question.trim()) {
            alertMessage(`Question ${index + 1} has no question text`, "bg-gradient-to-r from-red-500 to-pink-500");
            return false;
        }
        
        if (q.type !== 'essay' && q.options.length < 2) {
            alertMessage(`Question ${index + 1} needs at least 2 options`, "bg-gradient-to-r from-red-500 to-pink-500");
            return false;
        }
        
        if (q.type !== 'essay' && !q.answer.trim()) {
            alertMessage(`Question ${index + 1} has no correct answer selected`, "bg-gradient-to-r from-red-500 to-pink-500");
            return false;
        }
        
        return true;
    });
    
    if (!valid) return;

    const existingQuestions = quizData[sub] && quizData[sub][lev] ? quizData[sub][lev] : [];
    
    if (existingQuestions.length > 0 && !isEditMode) {
        showExamUploadOptions('manual', sub, lev, manualQuestions);
        return;
    }
    
    saveManualExamToDatabase(sub, lev, manualQuestions, isEditMode);
}

function openManualExamCreatorForSubject(s, level = null, editMode = false) {
    document.getElementById('manualSubject').value = s;
    if (level) {
        document.getElementById('manualLevel').value = level;
        
        if (editMode) {
            manualQuestions = [];
            const existingQuestions = quizData[s]?.[level] || [];
            existingQuestions.forEach(q => {
                manualQuestions.push({
                    type: q.type || 'radio',
                    question: q.question || '',
                    options: q.options || ['', ''],
                    answer: q.answer || '',
                    hint: q.hint || ''
                });
            });
            
            if (manualQuestions.length === 0) {
                manualQuestions.push({ type: 'radio', question: '', options: ['', ''], answer: '', hint: '' });
            }
        } else {
            manualQuestions = [];
            addManualQuestion();
        }
    } else {
        manualQuestions = [];
        addManualQuestion();
    }
    openManualExamCreator(editMode, s, level);
}

// ==== UPLOADER LOGIC ====
function closeManualExamCreator() { 
    document.body.classList.remove('modal-open');
    document.getElementById('manualExamModal').classList.remove('show'); 
    isEditMode = false;
    editSubject = '';
    editLevel = 0;
}

function openResourceUploader() { 
    document.body.classList.add('modal-open');
    document.getElementById('resourceUploaderModal').classList.add('show'); 
    resetUrlInputs();
}

function closeResourceUploader() { 
    document.body.classList.remove('modal-open');
    document.getElementById('resourceUploaderModal').classList.remove('show'); 
}

function openResourceUploaderForSubject(s) { 
    document.getElementById('resourceSubject').value = s; 
    openResourceUploader(); 
}

async function saveResources() {
    const subject = document.getElementById('resourceSubject').value;
    const level = parseInt(document.getElementById('resourceLevel').value);
    const pdf = document.getElementById('pdfFileInput').files[0];
    const video = document.getElementById('videoFileInput').files[0];
    const audio = document.getElementById('audioFileInput').files[0];
    const status = document.getElementById('resourceUploadStatus');

    if (!pdf && !video && !audio && urlInputs.every(url => !url.name.trim() && !url.url.trim())) {
        return alertMessage("Select a file or add a URL first", "bg-gradient-to-r from-red-500 to-pink-500");
    }
    
    status.textContent = "Saving to Database... do not close.";
    status.classList.remove('hidden');

    try {
        if (!resources[subject]) resources[subject] = {};
        if (!resources[subject][level]) resources[subject][level] = { pdfs: [], videos: [], urls: [], audios: [] };
        if (!resources[subject][level].pdfs) resources[subject][level].pdfs = [];
        if (!resources[subject][level].videos) resources[subject][level].videos = [];
        if (!resources[subject][level].urls) resources[subject][level].urls = [];
        if (!resources[subject][level].audios) resources[subject][level].audios = [];

        const date = new Date().toISOString();

        if (pdf) {
            const id = `pdf_${Date.now()}`;
            await saveFileToDB(pdf, id);
            resources[subject][level].pdfs.unshift({ id: id, name: pdf.name, date: date });
        }
        if (video) {
            const id = `vid_${Date.now()}`;
            await saveFileToDB(video, id);
            resources[subject][level].videos.unshift({ id: id, name: video.name, date: date });
        }
        
        if (audio) {
            const id = `audio_${Date.now()}`;
            await saveFileToDB(audio, id);
            resources[subject][level].audios.unshift({ id: id, name: audio.name, date: date });
        }
        
        urlInputs.forEach(url => {
            if (url.name.trim() && url.url.trim()) {
                const id = `url_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                resources[subject][level].urls.unshift({ 
                    id: id, 
                    name: url.name.trim(), 
                    url: url.url.trim(), 
                    date: date 
                });
            }
        });
        
        saveResourcesMeta();
        closeResourceUploader();
        alertMessage("Saved to Local Database!", "bg-gradient-to-r from-green-500 to-teal-500");
        if(currentSubject === subject) renderSubjectLevels(subject);
        
        document.getElementById('pdfFileInput').value = '';
        document.getElementById('videoFileInput').value = '';
        document.getElementById('audioFileInput').value = '';
        resetUrlInputs();
        
    } catch (e) {
        console.error(e);
        alertMessage("Error saving file. Device might be full.", "bg-gradient-to-r from-red-500 to-pink-500");
    }
    status.classList.add('hidden');
}

function processQuestionArray(questionsArray, defaultSubject, defaultLevel) {
    const processed = [];
    
    questionsArray.forEach((item, index) => {
        try {
            const questionText = item.question || item.Question || item.text || item.q || '';
            const rawAnswer = item.answer || item.Answer || item.correct || item.correct_answer || '';
            let options = item.options || item.Options || item.choices || [];
            const questionType = item.type || item.Type || item.question_type || 'radio';
            const hint = item.hint || item.Hint || item.explanation || '';
            const subject = item.subject || item.Subject || defaultSubject;
            const level = item.level || item.Level || defaultLevel;
            
            if (typeof options === 'string') {
                options = options.split('|').map(opt => opt.trim());
            } else if (!Array.isArray(options)) {
                options = [];
            }
            
            let answer = '';
            
            if (Array.isArray(rawAnswer)) {
                if (rawAnswer.every(a => typeof a === 'number')) {
                    if (rawAnswer.length === 1) {
                        const idx = rawAnswer[0];
                        if (idx >= 0 && idx < options.length) {
                            answer = options[idx];
                        } else {
                            answer = (idx + 1).toString();
                        }
                    } else {
                        const answerTexts = rawAnswer
                            .filter(idx => idx >= 0 && idx < options.length)
                            .map(idx => options[idx]);
                        answer = answerTexts.join(',');
                    }
                } else if (rawAnswer.every(a => typeof a === 'string')) {
                    answer = rawAnswer.join(',');
                }
            }
            else if (typeof rawAnswer === 'string') {
                answer = rawAnswer;
            }
            else if (typeof rawAnswer === 'number') {
                if (rawAnswer >= 0 && rawAnswer < options.length) {
                    answer = options[rawAnswer];
                } else if (rawAnswer > 0 && rawAnswer <= options.length) {
                    answer = rawAnswer.toString();
                } else {
                    answer = rawAnswer.toString();
                }
            }
            
            let internalType = 'radio';
            const typeLower = questionType.toLowerCase();
            if (typeLower.includes('single') || typeLower === 'radio' || typeLower === 'singleselect') {
                internalType = 'radio';
            } else if (typeLower.includes('multiple') || typeLower.includes('multi') || typeLower === 'checkbox' || typeLower === 'multipleselect') {
                internalType = 'checkbox';
            } else if (typeLower.includes('truefalse') || typeLower.includes('true_false')) {
                internalType = 'truefalse';
            } else if (typeLower.includes('essay')) {
                internalType = 'essay';
            }
            
            if (options.length === 0 && answer && internalType !== 'essay') {
                options = [
                    String(answer).trim(),
                    "Incorrect Option 1",
                    "Incorrect Option 2",
                    "Incorrect Option 3"
                ];
            }
            
            if (questionText && answer) {
                processed.push({
                    subject,
                    level: parseInt(level),
                    question: {
                        question: questionText.trim(),
                        options: options,
                        answer: answer,
                        type: internalType,
                        hint: hint
                    }
                });
            }
        } catch (error) {
            console.error(`Error processing question ${index}:`, error);
        }
    });
    
    return processed;
}

function extractQuestionsFromObject(obj, defaultSubject, defaultLevel) {
    const questions = [];
    
    function traverseObject(currentObj, path = '') {
        if (Array.isArray(currentObj)) {
            const potentialQuestions = currentObj.filter(item => 
                item && typeof item === 'object' && (item.question || item.Question)
            );
            
            if (potentialQuestions.length > 0) {
                const processed = processQuestionArray(potentialQuestions, defaultSubject, defaultLevel);
                questions.push(...processed);
            }
            
            currentObj.forEach((item, index) => {
                if (typeof item === 'object' && item !== null) {
                    traverseObject(item, `${path}[${index}]`);
                }
            });
        } else if (typeof currentObj === 'object' && currentObj !== null) {
            if (currentObj.question || currentObj.Question) {
                const processed = processQuestionArray([currentObj], defaultSubject, defaultLevel);
                questions.push(...processed);
            }
            
            Object.entries(currentObj).forEach(([key, value]) => {
                if (typeof value === 'object' && value !== null) {
                    traverseObject(value, `${path}.${key}`);
                }
            });
        }
    }
    
    traverseObject(obj);
    return questions;
}

function processItemsFormat(data, defaultSubject, defaultLevel) {
    const processed = [];
    
    if (data.items && Array.isArray(data.items)) {
        data.items.forEach((item, index) => {
            try {
                const questionText = item.prompt || item.question || item.text || '';
                const choices = item.choices || item.options || [];
                const correctChoiceLabel = item.correctChoice || item.answer || '';
                const questionType = item.type || item.questionType || 'radio';
                const hint = item.hint || item.explanation || '';
                const subject = item.subject || data.subject || defaultSubject;
                const level = item.level || data.level || defaultLevel;
                
                let options = [];
                if (Array.isArray(choices)) {
                    if (choices.length > 0 && typeof choices[0] === 'object') {
                        options = choices.map(choice => choice.text || choice.label || '');
                        
                        let answer = '';
                        if (correctChoiceLabel) {
                            const correctChoice = choices.find(choice => 
                                String(choice.label).trim().toUpperCase() === String(correctChoiceLabel).trim().toUpperCase()
                            );
                            if (correctChoice) {
                                answer = correctChoice.text || correctChoice.label || '';
                            } else {
                                answer = correctChoiceLabel;
                            }
                        }
                        
                        if (questionText && answer) {
                            processed.push({
                                subject,
                                level: parseInt(level),
                                question: {
                                    question: questionText.trim(),
                                    options: options.filter(opt => opt !== ''),
                                    answer: answer,
                                    type: questionType.toLowerCase().includes('multiple') ? 'checkbox' : 'radio',
                                    hint: hint
                                }
                            });
                        }
                    } else {
                        options = choices.map(choice => String(choice).trim());
                        
                        if (questionText && correctChoiceLabel) {
                            processed.push({
                                subject,
                                level: parseInt(level),
                                question: {
                                    question: questionText.trim(),
                                    options: options.filter(opt => opt !== ''),
                                    answer: correctChoiceLabel,
                                    type: questionType.toLowerCase().includes('multiple') ? 'checkbox' : 'radio',
                                    hint: hint
                                }
                            });
                        }
                    }
                }
            } catch (error) {
                console.error(`Error processing item ${index}:`, error);
            }
        });
    }
    
    return processed;
}

// ========== FIX 2: JSON Exam Upload without flickering ==========
function processBulkUpload() {
    const file = document.getElementById('csvFileInput').files[0];
    const jsonFile = document.getElementById('jsonFileInput').files[0];

    if (jsonFile) {
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const data = JSON.parse(e.target.result);
                let processedQuestions = [];

                if (Array.isArray(data)) {
                    processedQuestions = processQuestionArray(data, 
                        document.getElementById('uploadSubject').value, 
                        parseInt(document.getElementById('uploadLevel').value));
                } else if (data.questions && Array.isArray(data.questions)) {
                    processedQuestions = processQuestionArray(data.questions, 
                        data.subject || document.getElementById('uploadSubject').value, 
                        data.level || parseInt(document.getElementById('uploadLevel').value));
                } else if (data.exam && data.exam.questions) {
                    processedQuestions = processQuestionArray(data.exam.questions, 
                        data.exam.subject || document.getElementById('uploadSubject').value, 
                        data.exam.level || parseInt(document.getElementById('uploadLevel').value));
                } else if (data.subjects && Array.isArray(data.subjects)) {
                    data.subjects.forEach(subjectData => {
                        const subjectQuestions = processQuestionArray(
                            subjectData.questions || [],
                            subjectData.name || subjectData.subject || document.getElementById('uploadSubject').value,
                            subjectData.level || parseInt(document.getElementById('uploadLevel').value)
                        );
                        processedQuestions = processedQuestions.concat(subjectQuestions);
                    });
                } else if (data.items && Array.isArray(data.items)) {
                    processedQuestions = processItemsFormat(data,
                        document.getElementById('uploadSubject').value,
                        parseInt(document.getElementById('uploadLevel').value));
                } else {
                    processedQuestions = extractQuestionsFromObject(data, 
                        document.getElementById('uploadSubject').value, 
                        parseInt(document.getElementById('uploadLevel').value));
                }
                
                const sub = document.getElementById('uploadSubject').value;
                const lev = parseInt(document.getElementById('uploadLevel').value);
                const existingQuestions = quizData[sub] && quizData[sub][lev] ? quizData[sub][lev] : [];
                
                if (existingQuestions.length > 0 && processedQuestions.length > 0) {
                    showExamUploadOptions('bulk', sub, lev, processedQuestions.map(p => p.question), data);
                    return;
                }
                
                processedQuestions.forEach(q => {
                    if (!quizData[q.subject]) quizData[q.subject] = {};
                    if (!quizData[q.subject][q.level]) quizData[q.subject][q.level] = [];
                    
                    quizData[q.subject][q.level].push(q.question);
                });
                
                saveQuizData();
                closeBulkUploader();
                alertMessage(`JSON Uploaded: ${processedQuestions.length} questions processed!`, "bg-gradient-to-r from-green-500 to-teal-500");
                
                if (processedQuestions.length > 0) {
                    const firstQuestion = processedQuestions[0];
                    renderSubjectLevels(firstQuestion.subject);
                }

            } catch (err) {
                console.error("JSON parse error:", err);
                alertMessage("Invalid JSON format or structure", "bg-gradient-to-r from-red-500 to-pink-500");
            }
        };
        reader.readAsText(jsonFile);
        return;
    }

    if (!file) return;
    Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        complete: (res) => {
            let count = 0;
            let lastSubject = '';
            const processedQuestions = [];

            res.data.forEach(row => {
                const qText = row.question || row.Question;
                const qAns = row.answer || row.Answer || row.correct;
                const qOptsStr = row.options || row.Options;
                const qSub = row.subject || row.Subject;
                const qLvl = row.level || row.Level;
                const qType = row.type || row.Type || 'radio';

                if (qText && qAns) {
                    const s = qSub || document.getElementById('uploadSubject').value;
                    const l = parseInt(qLvl || document.getElementById('uploadLevel').value);
                    lastSubject = s;

                    let opts;
                    if (qOptsStr) {
                        opts = qOptsStr.split('|').map(o => o.trim());
                    } else {
                        opts = [
                            String(qAns).trim(),
                            "Incorrect Option 1",
                            "Incorrect Option 2",
                            "Incorrect Option 3"
                        ];
                    }

                    let finalAnswer = String(qAns).trim();
                    
                    if (opts.includes(finalAnswer)) { 
                    }
                    else if (/^\d+$/.test(finalAnswer)) {
                        const idx = parseInt(finalAnswer) - 1;
                        if (idx >= 0 && idx < opts.length) {
                            finalAnswer = opts[idx];
                        }
                    }

                    processedQuestions.push({
                        subject: s,
                        level: l,
                        question: {
                            question: qText.trim(),
                            answer: finalAnswer,
                            options: opts,
                            type: qType,
                            hint: row.hint || ''
                        }
                    });

                    count++;
                }
            });

            const sub = document.getElementById('uploadSubject').value;
            const lev = parseInt(document.getElementById('uploadLevel').value);
            const existingQuestions = quizData[sub] && quizData[sub][lev] ? quizData[sub][lev] : [];
            
            if (existingQuestions.length > 0 && processedQuestions.length > 0) {
                showExamUploadOptions('bulk', sub, lev, processedQuestions.map(p => p.question), res.data);
                return;
            }
            
            processedQuestions.forEach(q => {
                if (!quizData[q.subject]) quizData[q.subject] = {};
                if (!quizData[q.subject][q.level]) quizData[q.subject][q.level] = [];
                
                quizData[q.subject][q.level].push(q.question);
            });
            
            saveQuizData();
            closeBulkUploader();
            alertMessage(`Uploaded ${count} questions`, "bg-gradient-to-r from-green-500 to-teal-500");
            if (lastSubject) renderSubjectLevels(lastSubject);
        },
        error: (err) => {
            console.error("CSV parse error:", err);
            alertMessage("Error parsing CSV file", "bg-gradient-to-r from-red-500 to-pink-500");
        }
    });
}

function alertMessage(msg, bg) {
    const d = document.createElement('div');
    d.className = `fixed top-6 left-1/2 transform -translate-x-1/2 px-8 py-4 rounded-xl text-white font-bold shadow-2xl z-50 ${bg} text-sm`;
    d.textContent = msg;
    document.body.appendChild(d);
    setTimeout(() => d.remove(), 2500);
}

// Helper function
function openResourceWithTracking(id, name, subject, level) {
    window.lastExternalQuizContext = {
        subject: subject || currentSubject,
        level: level || currentLevel,
        resourceName: name
    };
    
    openResource(id);
}

function openUrlManager() {
    openResourceUploader();
    resetUrlInputs();
}

// ========== FIXED: Handle Sign Out function ==========
function handleSignOut() {
    if (confirm("Are you sure you want to sign out?")) {
        isAuthenticated = false;
        currentUser = null;
        alertMessage("Signed out successfully", "bg-gradient-to-r from-green-500 to-teal-500");
        renderAuthScreen();
        updateHeaderButtons();
        
        document.getElementById('adminFooter').style.display = 'none';
    }
}

// Export functions
window.handleSignIn = handleSignIn;
window.handleSignUp = handleSignUpWithRole;
window.renderAuthScreen = renderAuthScreen;
window.renderSignUpFormWithRoles = renderSignUpFormWithRoles;
window.renderWelcomeScreen = renderWelcomeScreen;
window.renderStudentProfile = renderStudentProfile;
window.renderSubjectLevels = renderSubjectLevels;
window.renderSubjectPage = renderSubjectPage;
window.startQuiz = startQuiz;
window.selectAnswer = selectAnswer;
window.submitEssayAnswer = submitEssayAnswer;
window.nextQuestion = nextQuestion;
window.prevQuestion = prevQuestion;
window.renderAdminDashboard = renderAdminDashboard;
window.checkAdminPassword = checkAdminPassword;
window.closeModal = closeModal;
window.openModal = openModal;
window.openBulkUploader = openBulkUploader;
window.closeBulkUploader = closeBulkUploader;
window.processBulkUpload = processBulkUpload;
window.openManualExamCreator = openManualExamCreator;
window.closeManualExamCreator = closeManualExamCreator;
window.addManualQuestion = addManualQuestion;
window.saveManualExam = saveManualExam;
window.openResourceUploader = openResourceUploader;
window.closeResourceUploader = closeResourceUploader;
window.saveResources = saveResources;
window.openResource = openResource;
window.openUrlResource = openUrlResource;
window.openManualExamCreatorForSubject = openManualExamCreatorForSubject;
window.openResourceUploaderForSubject = openResourceUploaderForSubject;
window.updateTimerSettings = updateTimerSettings;
window.toggleTimer = toggleTimer;
window.deleteUser = deleteUser;
window.scrollToUserList = scrollToUserList;
window.changeManualType = changeManualType;
window.addManualOptionInput = addManualOptionInput;
window.updateManualOption = updateManualOption;
window.showQuestionSummary = showQuestionSummary;
window.updateManualAnswer = updateManualAnswer;
window.updateManualMultiAnswer = updateManualMultiAnswer;
window.toggleMultiSelect = toggleMultiSelect;
window.submitMultiAnswer = submitMultiAnswer;
window.renameResource = renameResource;
window.deleteResource = deleteResource;
window.openResourceWithTracking = openResourceWithTracking;
window.openResetQuizModal = openResetQuizModal;
window.closeResetModal = closeResetModal;
window.confirmResetQuizProgress = confirmResetQuizProgress;
window.openSubjectManagement = openSubjectManagement;
window.closeSubjectManagement = closeSubjectManagement;
window.addNewSubject = addNewSubject;
window.renameSubject = renameSubject;
window.deleteSubject = deleteSubject;
window.editSubjectName = editSubjectName;
window.saveSubjectChanges = saveSubjectChanges;
window.openSubjectManagementFromUploader = openSubjectManagementFromUploader;
window.openSubjectManagementFromManual = openSubjectManagementFromManual;
window.openSubjectManagementFromResource = openSubjectManagementFromResource;
window.showSubjectSummary = showSubjectSummary;
window.editExam = editExam;
window.deleteExam = deleteExam;
window.renameExam = renameExam;
window.openUrlManager = openUrlManager;
window.updateUrlInput = updateUrlInput;
window.addMoreUrlInput = addMoreUrlInput;
window.removeUrlInput = removeUrlInput;
window.renameUrlResource = renameUrlResource;
window.deleteUrlResource = deleteUrlResource;
window.toggleModalExpand = toggleModalExpand;
window.openLevelMenu = openLevelMenu;
window.editLevelSettings = editLevelSettings;
window.deleteLevel = deleteLevel;
window.openLevelRenameModal = openLevelRenameModal;
window.closeLevelRenameModal = closeLevelRenameModal;
window.saveLevelRename = saveLevelRename;
window.handleSignOut = handleSignOut;
window.toggleAccordion = toggleAccordion;
window.openSubjectDropdown = openSubjectDropdown;
window.editSubjectOnPage = editSubjectOnPage;
window.deleteSubjectOnPage = deleteSubjectOnPage;
window.goBack = goBack;
window.goBackFromQuiz = goBackFromQuiz;
window.openAddModal = openAddModal;
window.toggleAddTypeFields = toggleAddTypeFields;
window.saveNewItem = saveNewItem;
window.saveNewSubjectFromModal = saveNewSubjectFromModal;
window.saveNewChapter = saveNewChapter;
window.openAddLevelModal = openAddLevelModal;
window.closeAddLevelModal = closeAddLevelModal;
window.saveNewLevel = saveNewLevel;
window.openSubjectManagementMenu = openSubjectManagementMenu;
window.playAudioResource = playAudioResource;
window.playPauseAudio = playPauseAudio;
window.rewindAudio = rewindAudio;
window.forwardAudio = forwardAudio;
window.updateAudioProgress = updateAudioProgress;
window.downloadAudio = downloadAudio;
window.createAudioPlayer = createAudioPlayer;
window.formatTime = formatTime;
window.handleFirstTimeAdminSignup = handleFirstTimeAdminSignup;
window.verifyAdminPasskey = verifyAdminPasskey;
window.cancelAdminAuthorization = cancelAdminAuthorization;
window.checkAdminAuthorization = checkAdminAuthorization;
window.toggleAdminPasskeyField = toggleAdminPasskeyField;
window.renderResults = renderResults;
window.reviewQuiz = reviewQuiz;
window.retryQuiz = retryQuiz;
window.removeManualOption = removeManualOption;
window.ensureQuizPreviewScroll = ensureQuizPreviewScroll;
window.showRegistrationPasscodeModal = showRegistrationPasscodeModal;
window.closeRegistrationPasscodeModal = closeRegistrationPasscodeModal;
window.checkRegistrationPasscode = checkRegistrationPasscode;
window.completePendingRegistration = completePendingRegistration;
window.toggleFullScreen = toggleFullScreen;
window.showExamUploadOptions = showExamUploadOptions;
window.closeExamUploadOptionsModal = closeExamUploadOptionsModal;
window.handleExamUploadOption = handleExamUploadOption;
</script>
</body>
</html>
